!function t(e,i,o){function r(s,a){if(!i[s]){if(!e[s]){var h="function"==typeof require&&require;if(!a&&h)return h(s,!0);if(n)return n(s,!0);var u=new Error("Cannot find module '"+s+"'");throw u.code="MODULE_NOT_FOUND",u}var p=i[s]={exports:{}};e[s][0].call(p.exports,function(t){var i=e[s][1][t];return r(i?i:t)},p,p.exports,t,e,i,o)}return i[s].exports}for(var n="function"==typeof require&&require,s=0;s<o.length;s++)r(o[s]);return r}({1:[function(t,e,i){"use strict";function o(t){this.uint8=new Uint8Array(t),this.offset=0}var r=t("./Utility");o.prototype.Math=Math,o.prototype.parse=function(){return{}},o.prototype._parseObject=function(t,e){this.offset;for(var i in e)t[i]=this._getValue(e[i],this.offset),this.offset+=this._sizeof(e[i])},o.prototype._getValue=function(t,e){return void 0===t.isArray?this._getValueScalar(t,e):this._getValueArray(t,e)},o.prototype._getValueScalar=function(t,e){switch(t.type){case"char":return this._getChars(e,1);case"strings":return this._getStrings(e,1);case"uint8":return this._getUint8(e);case"uint16":return this._getUint16(e);case"uint32":return this._getUint32(e);case"float":return this._getFloat(e);default:throw"error: undefined type"+t}},o.prototype._getValueArray=function(t,e){if("char"===t.type)return this._getChars(e,t.size);if("strings"===t.type)return this._getStrings(e,t.size);for(var i=[],o=this._sizeofScalar(t),r=0;r<t.size;r++)i[r]=this._getValueScalar(t,e),e+=o;return i},o.prototype._sizeof=function(t){return void 0===t.isArray?this._sizeofScalar(t):this._sizeofArray(t)},o.prototype._sizeofScalar=function(t){switch(t.type){case"char":return 1;case"strings":return 1;case"uint8":return 1;case"uint16":return 2;case"uint32":return 4;case"float":return 4;default:throw"error: undefined type "+t+" "+t.type}},o.prototype._sizeofArray=function(t){return this._sizeofScalar(t)*t.size},o.prototype._sizeofObject=function(t){var e=0;for(var i in t)e+=this._sizeof(t[i]);return e},o.prototype._getUint8=function(t){return this.uint8[t]},o.prototype._getUint16=function(t){return this._getValueWithReverseByteOrder(t,2)},o.prototype._getUint32=function(t){return this._getValueWithReverseByteOrder(t,4)},o.prototype._getFloat=function(t){return this._toBinary32(this._getValueWithReverseByteOrder(t,4))},o.prototype._getValueWithReverseByteOrder=function(t,e){for(var i=0,o=0;e>o;o++)i=i<<8|this.uint8[t+e-o-1];return i},o.prototype._toBinary32=function(t){var e=t>>31&1,i=t>>23&255,o=8388607&t;if(0===i&&0===o)return 0;if(255===i&&0===o)return 1/0;if(255===i&&0!==o)return NaN;var r=1;0===i&&0!==o&&(i=1,r=0);for(var n=0;23>n;n++)o>>22-n&1&&(r+=this.Math.pow(2,-(n+1)));return r*=this.Math.pow(2,i-127),e&&(r=-r),r},o.prototype._getChars=function(t,e){for(var i="",o=0;e>o;o++){var r=t+o;if(0===this.uint8[r])break;i+=String.fromCharCode(this.uint8[r])}return i},o.prototype._getStrings=function(t,e){for(var i="",o=0;e>o;o++){var n=t+o;if(0===this.uint8[n])break;i+=r(16,this.uint8[n],2)}return i},o.prototype.dump=function(){for(var t=this.uint8,e=0,i=t.length;i>0;)e++,i=i/16|0;for(var o="",n="",s=0;s<t.length;s++)s%16===0&&(o+=r(16,s,e),o+=" "),o+=r(16,t[s],2),o+=" ",n+=t[s]>=32&&t[s]<=126?String.fromCharCode(t[s]):".",s%16===15&&(o+="  ",o+=n,o+="\n",n="");return o},e.exports=o},{"./Utility":30}],2:[function(t,e,i){"use strict";var o={};o.__inherit=function(t,e){var i=function(t){function e(){}return Object.create?Object.create(t):(e.prototype=t,new e)};t.prototype=i(e.prototype),t.prototype.constructor=t},o.__copyParentMethod=function(t,e,i){var o=e.name,r=o+"_"+("_"===i[0]?i.slice(1):i);t.prototype[r]=e.prototype[i]},e.exports=o},{}],3:[function(t,e,i){"use strict";function o(t){this.pmd=t,this.world=null,this.bodies=[],this.constraints=[],this.count=0,this._init()}var r=t("./PhysicsRigidBody"),n=t("./PhysicsConstraint");o.prototype._init=function(){this.world=this._generateWorld();var t;for(this.bodies.length=0,t=0;t<this.pmd.rigidBodyCount;t++)this.bodies.push(new r(this.pmd,this.world,this.pmd.rigidBodies[t]));for(this.constraints.length=0,t=0;t<this.pmd.jointCount;t++){var e=this.pmd.joints[t],i=this.bodies[e.rigidBody1],o=this.bodies[e.rigidBody2];this.constraints.push(new n(this.pmd,this.world,e,i,o))}},o.prototype._generateWorld=function(){var t=new Ammo.btDefaultCollisionConfiguration,e=new Ammo.btCollisionDispatcher(t),i=new Ammo.btDbvtBroadphase,o=new Ammo.btSequentialImpulseConstraintSolver,r=new Ammo.btDiscreteDynamicsWorld(e,i,o,t);return r.setGravity(new Ammo.btVector3(0,-100,0)),r},o.prototype._generateGround=function(){var t=new Ammo.btTransform;return t.setIdentity(),t.setOrigin(new Ammo.btVector3(0,-1,0)),new Ammo.btRigidBody(new Ammo.btRigidBodyConstructionInfo(0,new Ammo.btDefaultMotionState(t),new Ammo.btBoxShape(new Ammo.btVector3(5,1,5)),new Ammo.btVector3(0,0,0)))},o.prototype.simulate=function(t,e){this._preSimulation(t),this.world.stepSimulation(1/60,0,1/60),this._postSimulation(t)},o.prototype.simulateFrame=function(t,e){var i,o=1/60*e,r=e,n=1/60;e>=3&&(r=2,n=1/60*2,i=this.world.getGravity(),i.setY(-50),this.world.setGravity(i)),this._preSimulation(t),this.world.stepSimulation(o,r,n),this._postSimulation(t),e>=3&&(i.setY(-100),this.world.setGravity(i),Ammo.destroy(i))},o.prototype._preSimulation=function(t){for(var e=0;e<this.bodies.length;e++)this.bodies[e].preSimulation(t)},o.prototype._postSimulation=function(t){for(var e=0;e<this.bodies.length;e++)this.bodies[e].postSimulation(t)},o.prototype.resetRigidBodies=function(t){for(var e=0;e<this.bodies.length;e++)this.bodies[e].reset(t)},e.exports=o},{"./PhysicsConstraint":4,"./PhysicsRigidBody":6}],4:[function(t,e,i){"use strict";function o(t,e,i,o,n){this.parent=r,this.parent.call(this),this.pmd=t,this.world=e,this.joint=i,this.bodyA=o,this.bodyB=n,this.constraint=null,this.boneOffsetForm=null,this.boneOffsetFormInverse=null,this._init()}var r=t("./PhysicsEntity"),n=t("../Inherit").__inherit;n(o,r),o.prototype._init=function(){var t=this.joint,e=this.bodyA.rb,i=this.bodyB.rb,o=this.bodyA.body,r=this.bodyB.body;if(0!==o.type&&2==r.type&&o.boneIndex>0&&r.boneIndex>0&&65535!=o.boneIndex&&65535!=r.boneIndex){var n=this.pmd.bones[o.boneIndex],s=this.pmd.bones[r.boneIndex];s.parentIndex==n.id&&(r.type=1)}var a=this.allocTr();this._setOriginArray3Left(a,t.position),this._setBasisArray3Left(a,t.rotation);var h=e.getWorldTransform(),u=i.getWorldTransform(),p=this._inverseTransform(h),l=this._inverseTransform(u),f=this._multiplyTransforms(p,a),c=this._multiplyTransforms(l,a),m=new Ammo.btGeneric6DofSpringConstraint(e,i,f,c,!0),d=this.allocV(),_=this.allocV(),v=this.allocV(),y=this.allocV();d.setValue(t.translationLimitation1[0],t.translationLimitation1[1],-t.translationLimitation2[2]),_.setValue(t.translationLimitation2[0],t.translationLimitation2[1],-t.translationLimitation1[2]),v.setValue(-t.rotationLimitation2[0],-t.rotationLimitation2[1],t.rotationLimitation1[2]),y.setValue(-t.rotationLimitation1[0],-t.rotationLimitation1[1],t.rotationLimitation2[2]),m.setLinearLowerLimit(d),m.setLinearUpperLimit(_),m.setAngularLowerLimit(v),m.setAngularUpperLimit(y);for(var g=0;3>g;g++)0!=t.springPosition[g]&&(m.enableSpring(g,!0),m.setStiffness(g,t.springPosition[g]));for(var g=0;3>g;g++)0!=t.springRotation[g]&&(m.enableSpring(g+3,!0),m.setStiffness(g+3,t.springRotation[g]));this.world.addConstraint(m,!0),this.constraint=m,this.freeTr(a),Ammo.destroy(h),Ammo.destroy(u),this.freeTr(p),this.freeTr(l),this.freeTr(f),this.freeTr(c),this.freeV(d),this.freeV(_),this.freeV(v),this.freeV(y)},e.exports=o},{"../Inherit":2,"./PhysicsEntity":5}],5:[function(t,e,i){"use strict";function o(){this.workNum=10,this.workTrs=[],this.workQs=[],this.workVs=[];for(var t=0;t<this.workNum;t++)this.workTrs[t]=new Ammo.btTransform,this.workQs[t]=new Ammo.btQuaternion,this.workVs[t]=new Ammo.btVector3}o.prototype.allocTr=function(){var t=this.workTrs[this.workTrs.length-1];return this.workTrs.length--,t},o.prototype.freeTr=function(t){this.workTrs[this.workTrs.length]=t},o.prototype.allocQ=function(){var t=this.workQs[this.workQs.length-1];return this.workQs.length--,t},o.prototype.freeQ=function(t){this.workQs[this.workQs.length]=t},o.prototype.allocV=function(){var t=this.workVs[this.workVs.length-1];return this.workVs.length--,t},o.prototype.freeV=function(t){this.workVs[this.workVs.length]=t},o.prototype._newTransform=function(){return new Ammo.btTransform},o.prototype._setIdentity=function(t){t.setIdentity()},o.prototype._getBasis=function(t){var e=this.allocQ();return t.getBasis().getRotation(e),e},o.prototype._getBasisMatrix3=function(t){var e=this._getBasis(t),i=this._quaternionToMatrix3(e);return this.freeQ(e),i},o.prototype._setBasis=function(t,e){t.setRotation(e)},o.prototype._setBasisMatrix3=function(t,e){var i=this._matrix3ToQuaternion(e);this._setBasis(t,i),this.freeQ(i)},o.prototype._setBasisArray4=function(t,e){var i=this._array4ToQuaternion(e);this._setBasis(t,i),this.freeQ(i)},o.prototype._setBasisArray4Left=function(t,e){e[0]=-e[0],e[1]=-e[1],this._setBasisArray4(t,e),e[0]=-e[0],e[1]=-e[1]},o.prototype._setBasisArray3=function(t,e){t.getBasis().setEulerZYX(e[0],e[1],e[2])},o.prototype._setBasisArray3Left=function(t,e){e[0]=-e[0],e[1]=-e[1],this._setBasisArray3(t,e),e[0]=-e[0],e[1]=-e[1]},o.prototype._getOrigin=function(t){return t.getOrigin()},o.prototype._getOriginArray3=function(t){var e=this._getOrigin(t);return[e.x(),e.y(),e.z()]},o.prototype._setOrigin=function(t,e){t.getOrigin().setValue(e.x(),e.y(),e.z())},o.prototype._setOriginArray3=function(t,e){t.getOrigin().setValue(e[0],e[1],e[2])},o.prototype._setOriginArray3Left=function(t,e){e[2]=-e[2],this._setOriginArray3(t,e),e[2]=-e[2]},o.prototype._setOriginFloats=function(t,e,i,o){t.getOrigin().setValue(e,i,o)},o.prototype._copyOrigin=function(t,e){var i=e.getOrigin();this._setOrigin(t,i)},o.prototype._addVector3=function(t,e){var i=this.allocV();return i.setValue(t.x()+e.x(),t.y()+e.y(),t.z()+e.z()),i},o.prototype._addVector3ByArray3=function(t,e){var i=this.allocV();return i.setValue(t.x()+e[0],t.y()+e[1],t.z()+e[2]),i},o.prototype._dotVectors3=function(t,e){return t.x()*e.x()+t.y()*e.y()+t.z()*e.z()},o.prototype._rowOfMatrix3=function(t,e){var i=this.allocV();return i.setValue(t[3*e+0],t[3*e+1],t[3*e+2]),i},o.prototype._columnOfMatrix3=function(t,e){var i=this.allocV();return i.setValue(t[e+0],t[e+3],t[e+6]),i},o.prototype._negativeVector3=function(t){var e=this.allocV();return e.setValue(-t.x(),-t.y(),-t.z()),e},o.prototype._cloneVector3=function(t){var e=this.allocV();return e.setValue(t.x(),t.y(),t.z()),e},o.prototype._cloneMatrix3=function(t){for(var e=[],i=0;9>i;i++)e[i]=t[i];return e},o.prototype._array3ToVector3=function(t){var e=this.allocV();return e.setValue(t[0],t[1],t[2]),e},o.prototype._vector3ToArray3=function(t){var e=[];return e[0]=t.x(),e[1]=t.y(),e[2]=t.z(),e},o.prototype._array4ToQuaternion=function(t){var e=this.allocQ();return e.setX(t[0]),e.setY(t[1]),e.setZ(t[2]),e.setW(t[3]),e},o.prototype._quaternionToArray4=function(t){var e=[t.x(),t.y(),t.z(),t.w()];return e},o.prototype._quaternionToEulerZYX=function(t){var e,i,o,r=t.w(),n=t.x(),s=t.y(),a=t.z(),h=n*n,u=s*s,p=n*s+a*r;if(p>.499)o=360/Math.PI*Math.atan2(n,r),i=90,e=0;else if(-.499>p)o=-360/Math.PI*Math.atan2(n,r),i=-90,o=0;else{var l=Math.atan2(2*s*r-2*n*a,1-2*u-2*a),f=Math.asin(2*n*s+2*a*r),c=Math.atan2(2*n*r-2*s*a,1-2*h-2*a);o=Math.round(180*l/Math.PI),i=Math.round(180*f/Math.PI),e=Math.round(180*c/Math.PI)}return[e,o,i];var e,i,o},o.prototype._multiplyTransforms=function(t,e){var i=this.allocTr();i.setIdentity();var o=this._getBasisMatrix3(t),r=this._getBasisMatrix3(e),n=this._getOrigin(t),s=this._getOrigin(e),a=this._multiplyMatrix3ByVector3(o,s),h=this._addVector3(a,n);this._setOrigin(i,h);var u=this._multiplyMatrices3(o,r);return this._setBasisMatrix3(i,u),this.freeV(a),this.freeV(h),i},o.prototype._inverseTransform=function(t){var e=this.allocTr(),i=this._getBasisMatrix3(t),o=this._getOrigin(t),r=this._transposeMatrix3(i),n=this._negativeVector3(o),s=this._multiplyMatrix3ByVector3(r,n);return this._setOrigin(e,s),this._setBasisMatrix3(e,r),this.freeV(n),this.freeV(s),e},o.prototype._multiplyTransformByVector3=function(t,e){var i=this._getBasisMatrix3(t),o=this._getOrigin(t),r=this._multiplyMatrix3ByVector3(i,e),n=this._addVector3(r,o);return this.freeV(r),n},o.prototype._multiplyMatrix3ByVector3=function(t,e){var i=this.allocV(),o=this._rowOfMatrix3(t,0),r=this._rowOfMatrix3(t,1),n=this._rowOfMatrix3(t,2),s=this._dotVectors3(o,e),a=this._dotVectors3(r,e),h=this._dotVectors3(n,e);return i.setValue(s,a,h),this.freeV(o),this.freeV(r),this.freeV(n),i},o.prototype._multiplyMatrices3=function(t,e){var i=[],o=this._rowOfMatrix3(t,0),r=this._rowOfMatrix3(t,1),n=this._rowOfMatrix3(t,2),s=this._columnOfMatrix3(e,0),a=this._columnOfMatrix3(e,1),h=this._columnOfMatrix3(e,2);return i[0]=this._dotVectors3(o,s),i[1]=this._dotVectors3(o,a),i[2]=this._dotVectors3(o,h),i[3]=this._dotVectors3(r,s),i[4]=this._dotVectors3(r,a),i[5]=this._dotVectors3(r,h),i[6]=this._dotVectors3(n,s),i[7]=this._dotVectors3(n,a),i[8]=this._dotVectors3(n,h),this.freeV(o),this.freeV(r),this.freeV(n),this.freeV(s),this.freeV(a),this.freeV(h),i},o.prototype._transposeMatrix3=function(t){var e=[];return e[0]=t[0],e[1]=t[3],e[2]=t[6],e[3]=t[1],e[4]=t[4],e[5]=t[7],e[6]=t[2],e[7]=t[5],e[8]=t[8],e},o.prototype._inverseMatrix3=function(t){var e=t[0],i=t[1],o=t[2],r=t[3],n=t[4],s=t[5],a=t[6],h=t[7],u=t[8],p=e*n*u+r*h*o+a*i*s-a*n*o-r*i*u-e*h*s;if(0==p)return this._cloneMatrix3(t);var l=[];return l[0]=(n*u-s*h)/p,l[1]=(o*h-i*u)/p,l[2]=(i*s-o*n)/p,l[3]=(s*a-r*u)/p,l[4]=(e*u-o*a)/p,l[5]=(o*r-e*s)/p,l[6]=(r*h-n*a)/p,l[7]=(i*a-e*h)/p,l[8]=(e*n-i*r)/p,l},o.prototype._quaternionToMatrix3=function(t){var e=quat4.create();return e[0]=t.x(),e[1]=t.y(),e[2]=t.z(),e[3]=t.w(),quat4.toMat3(e)},o.prototype._matrix3ToQuaternion=function(t){var e,i,o,r,n,s=t[0]+t[4]+t[8];s>0?(e=2*Math.sqrt(s+1),n=.25*e,i=(t[7]-t[5])/e,o=(t[2]-t[6])/e,r=(t[3]-t[1])/e):t[0]>t[4]&&t[0]>t[8]?(e=2*Math.sqrt(1+t[0]-t[4]-t[8]),n=(t[7]-t[5])/e,i=.25*e,o=(t[1]+t[3])/e,r=(t[2]+t[6])/e):t[4]>t[8]?(e=2*Math.sqrt(1+t[4]-t[0]-t[8]),n=(t[2]-t[6])/e,i=(t[1]+t[3])/e,o=.25*e,r=(t[5]+t[7])/e):(e=2*Math.sqrt(1+t[8]-t[0]-t[4]),n=(t[3]-t[1])/e,i=(t[2]+t[6])/e,o=(t[5]+t[7])/e,r=.25*e);var a=this.allocQ();return a.setX(i),a.setY(o),a.setZ(r),a.setW(n),a},o.prototype._dumpTransform=function(t){var e=this._getBasis(t),i="";return i+="-- origin --\n",i+=this._getOriginArray3(t).toString()+"\n",i+="-- quaternion --\n",i+=[e.x(),e.y(),e.z(),e.w()].toString()+"\n",i+="-- matrix --\n",i+=this._dumpMatrix3(this._getBasisMatrix3(t)),this.freeQ(e),i},o.prototype._dumpMatrix3=function(t){for(var e="",i=0;3>i;i++)e+=[t[3*i+0],t[3*i+1],t[3*i+2]].toString()+",\n";return e},e.exports=o},{}],6:[function(t,e,i){"use strict";function o(t,e,i){this.parent=n,this.parent.call(this),this.pmd=t,this.world=e,this.body=i,this.rb=null,this.bone=null,this.form=null,this.boneForm=null,this.boneOffsetForm=null,this.boneOffsetFormInverse=null,this._init()}var r=t("../Inherit").__inherit,n=t("./PhysicsEntity");r(o,n),o.prototype._init=function(){var t=this.body,e=this.pmd.bones[t.boneIndex],i=this._generateShape(t),o=0==t.type?0:t.weight,r=this.allocV();r.setValue(0,0,0),0!=o&&i.calculateLocalInertia(o,r);var n=this.allocTr();this._setIdentity(n),this._setOriginArray3Left(n,t.position),this._setBasisArray3Left(n,t.rotation);var s=this.allocTr();this._setIdentity(s);var a=65535==this.body.boneIndex?[0,0,0]:e.position;this._setOriginArray3Left(s,a);var h=this._multiplyTransforms(s,n),u=new Ammo.btDefaultMotionState(h),p=new Ammo.btRigidBodyConstructionInfo(o,u,i,r);p.set_m_friction(t.friction),p.set_m_restitution(t.recoil);var l=new Ammo.btRigidBody(p);0==t.type&&(l.setCollisionFlags(2|l.getCollisionFlags()),l.setActivationState(4)),l.setDamping(t.positionDim,t.rotationDim),l.setSleepingThresholds(0,0),this.world.addRigidBody(l,1<<t.groupIndex,t.groupTarget),this.rb=l,this.bone=e,this.boneOffsetForm=n,this.boneOffsetFormInverse=this._inverseTransform(n),this.freeV(r),this.freeTr(h),this.freeTr(s)},o.prototype._generateShape=function(t){switch(t.shapeType){case 0:return new Ammo.btSphereShape(t.width);case 1:return new Ammo.btBoxShape(new Ammo.btVector3(t.width,t.height,t.depth));case 2:return new Ammo.btCapsuleShape(t.width,t.height);default:throw"unknown shape type."+t}},o.prototype.reset=function(t){this._setTransformFromBone(t)},o.prototype.preSimulation=function(t){65535!=this.body.boneIndex&&(0==this.body.type&&this._setTransformFromBone(t),2==this.body.type&&this._setPositionFromBone(t))},o.prototype._setTransformFromBone=function(t){var e=t[this.body.boneIndex];65535==this.body.boneIndex&&(e={p:[0,0,0],r:[0,0,0,1]});var i=this.allocTr();this._setOriginArray3Left(i,e.p),this._setBasisArray4Left(i,e.r);var o=this._multiplyTransforms(i,this.boneOffsetForm);this.rb.setCenterOfMassTransform(o),this.rb.getMotionState().setWorldTransform(o),this.freeTr(i),this.freeTr(o)},o.prototype._setPositionFromBone=function(t){var e=t[this.body.boneIndex],i=this.allocTr();this._setOriginArray3Left(i,e.p),this._setBasisArray4Left(i,e.r);var o=this._multiplyTransforms(i,this.boneOffsetForm),r=this.allocTr();this.rb.getMotionState().getWorldTransform(r),this._copyOrigin(r,o),this.rb.setCenterOfMassTransform(r),this.rb.getMotionState().setWorldTransform(r),this.freeTr(i),this.freeTr(r),this.freeTr(o)},o.prototype.postSimulation=function(t){if(0!=this.body.type&&65535!=this.body.boneIndex){var e=t[this.body.boneIndex],i=this.allocTr();this.rb.getMotionState().getWorldTransform(i);var o=this._multiplyTransforms(i,this.boneOffsetFormInverse),r=this._getBasis(o);if(e.r[0]=-r.x(),e.r[1]=-r.y(),e.r[2]=r.z(),e.r[3]=r.w(),1==this.body.type){var n=this._getOrigin(o);e.p[0]=n.x(),e.p[1]=n.y(),e.p[2]=-n.z()}this.freeQ(r),this.freeTr(i),this.freeTr(o)}},e.exports=o},{"../Inherit":2,"./PhysicsEntity":5}],7:[function(t,e,i){"use strict";function o(){this.header=null,this.englishHeader=null,this.vertexCount=null,this.vertexIndexCount=null,this.materialCount=null,this.boneCount=null,this.ikCount=null,this.faceCount=null,this.faceDisplayCount=null,this.boneFrameNameCount=null,this.boneDisplayCount=null,this.toonTextureCount=null,this.rigidBodyCount=null,this.jointCount=null,this.vertices=[],this.vertexIndices=[],this.materials=[],this.bones=[],this.iks=[],this.faces=[],this.faceDisplays=[],this.boneFrameNames=[],this.boneDisplays=[],this.englishBoneNames=[],this.englishFaceNames=[],this.englishBoneFrameNames=[],this.toonTextures=[],this.rigidBodies=[],this.joints=[],this.bonesHash={},this.facesHash={},this.images=[],this.toonImages=[],this.sphereImages=[],this.centerBone={},this.leftFootBone={},this.rightFootBone={},this.leftEyeBone={},this.rightEyeBone={}}var r=t("./PmdImageloader");o.prototype.valid=function(){return this.header.valid()},o.prototype.getParentBone=function(t){return this.bones[t.parentIndex]},o.prototype.loadImages=function(t,e){var i=new r(this,t);i.load(e)},o.prototype.setup=function(){for(var t=0;t<this.vertexCount;t++)this.vertices[t].setup();for(var t=0;t<this.boneCount;t++)this.bonesHash[this.bones[t].name]=this.bones[t];for(var t=0;t<this.faceCount;t++)this.facesHash[this.faces[t].name]=this.faces[t];this._keepSomeBonesInfo()},o.prototype.toRight=function(){for(var t=0;t<this.vertexCount;t++)this.vertices[t].toRight();for(var t=0;t<this.boneCount;t++)this.bones[t].toRight();for(var t=0;t<this.faceCount;t++)this.faces[t].toRight();for(var t=0;t<this.rigidBodyCount;t++)this.rigidBodies[t].toRight();for(var t=0;t<this.jointCount;t++)this.joints[t].toRight()},o.prototype._keepSomeBonesInfo=function(){this._keepBoneInfo(this.centerBone,"0x830x5a0x830x930x830x5e0x810x5b"),this._keepBoneInfo(this.leftFootBone,"0x8d0xb60x910xab0x8e0xf1"),this._keepBoneInfo(this.rightFootBone,"0x890x450x910xab0x8e0xf1"),this._keepBoneInfo(this.leftEyeBone,"0x8d0xb60x960xda"),this._keepBoneInfo(this.rightEyeBone,"0x890x450x960xda")},o.prototype._keepBoneInfo=function(t,e){var i=this._findBoneNumberByName(e);if(null!==i){var o=this.bones[i];t.pos=this._getAveragePositionOfBone(o),t.id=i,t.bone=o,t.posFromBone=[],t.posFromBone[0]=t.pos[0]-o.position[0],t.posFromBone[1]=t.pos[1]-o.position[1],t.posFromBone[2]=t.pos[2]-o.position[2]}else t.pos=null,t.id=null,t.bone=null,t.posFromBone=null},o.prototype._findBoneNumberByName=function(t){for(var e=0;e<this.boneCount;e++)if(this.bones[e].name==t)return e;return null},o.prototype._getAveragePositionOfBone=function(t){for(var e=0,i=[0,0,0],o=0;o<this.vertexCount;o++){var r=this.vertices[o];(r.boneIndices[0]==t.id||r.boneIndices[1]==t.id)&&(i[0]+=r.position[0],i[1]+=r.position[1],i[2]+=r.position[2],e++)}return 0!=e&&(i[0]=i[0]/e,i[1]=i[1]/e,i[2]=i[2]/e),i},o.prototype.getBoneNames=function(){for(var t=[],e=0;e<this.boneCount;e++)t[e]=this.bones[e].name;return t},o.prototype.getFaceNames=function(){for(var t=[],e=0;e<this.faceCount;e++)t[e]=this.faces[e].name;return t},o.prototype.dump=function(){var t="";return t+="vertexCount: "+this.vertexCount+"\n",t+="vertexIndexCount: "+this.vertexIndexCount+"\n",t+="materialCount: "+this.materialCount+"\n",t+="boneCount: "+this.boneCount+"\n",t+="ikCount: "+this.ikCount+"\n",t+="faceCount: "+this.faceCount+"\n",t+="faceDisplayCount: "+this.faceDisplayCount+"\n",t+="boneFrameNameCount: "+this.boneFrameNameCount+"\n",t+="boneDisplayCount: "+this.boneDisplayCount+"\n",t+="toonTextureCount: "+this.toonTextureCount+"\n",t+="rigidBodyCount: "+this.rigidBodyCount+"\n",t+="jointCount: "+this.jointCount+"\n",t+="\n",t+=this._dumpHeader(),t+=this._dumpVertices(),t+=this._dumpVertexIndices(),t+=this._dumpMaterials(),t+=this._dumpBones(),t+=this._dumpIKs(),t+=this._dumpFaces(),t+=this._dumpfaceDisplays(),t+=this._dumpBoneFrameNames(),t+=this._dumpBoneDisplays(),t+=this._dumpEnglishHeader(),t+=this._dumpEnglishBoneNames(),t+=this._dumpEnglishFaceNames(),t+=this._dumpToonTextures(),t+=this._dumpRigidBodies(),t+=this._dumpJoints()},o.prototype.boneNumsOfMaterials=function(){for(var t=0,e=[],i=0;i<this.materialCount;i++){for(var o=[],r=0;r<this.boneCount;r++)o[r]=0;for(var n=0,s=this.materials[i].vertexCount,r=0;s>r;r++)for(var a=this.vertices[this.vertexIndices[t+r].index],h=0;h<a.boneIndices.length;h++){var u=a.boneIndices[h];0==o[u]&&n++,o[u]++}e.push(n),t+=s}return e},o.prototype._dumpHeader=function(){var t="";return t+="-- Header --\n",t+=this.header.dump(),t+="\n"},o.prototype._dumpEnglishHeader=function(){var t="";return t+="-- Header(English) --\n",t+=this.englishHeader.dump(),t+="\n"},o.prototype._dumpVertices=function(){var t="";t+="-- Vertices --\n";for(var e=0;e<this.vertexCount;e++)t+=this.vertices[e].dump();return t+="\n"},o.prototype._dumpVertexIndices=function(){var t="";t+="-- VertexIndices --\n";for(var e=0;e<this.vertexIndexCount;e++)t+=this.vertexIndices[e].dump();return t+="\n"},o.prototype._dumpMaterials=function(){var t="";t+="-- Materials --\n";for(var e=0;e<this.materialCount;e++)t+=this.materials[e].dump();return t+="\n"},o.prototype._dumpBones=function(){var t="";t+="-- Bones --\n";for(var e=0;e<this.boneCount;e++)t+=this.bones[e].dump();return t+="\n"},o.prototype._dumpIKs=function(){var t="";t+="-- IKs --\n";for(var e=0;e<this.ikCount;e++)t+=this.iks[e].dump();return t+="\n"},o.prototype._dumpFaces=function(){var t="";t+="-- Faces --\n";for(var e=0;e<this.faceCount;e++)t+=this.faces[e].dump();return t+="\n"},o.prototype._dumpFaceDisplays=function(){var t="";t+="-- Face Displays --\n";for(var e=0;e<this.faceDisplayCount;e++)t+=this.faceDisplays[e].dump();return t+="\n"},o.prototype._dumpBoneFrameNames=function(){var t="";t+="-- Bone Frame Names --\n";for(var e=0;e<this.boneFrameNameCount;e++)t+=this.boneFrameNames[e].dump();return t+="\n"},o.prototype._dumpBoneDisplays=function(){var t="";t+="-- Bone Displays --\n";for(var e=0;e<this.boneDisplayCount;e++)t+=this.boneDisplays[e].dump();return t+="\n"},o.prototype._dumpEnglishBoneNames=function(){var t="";t+="-- Bone Names(English) --\n";for(var e=0;e<this.boneCount;e++)t+=this.englishBoneNames[e].dump();return t+="\n"},o.prototype._dumpEnglishFaceNames=function(){var t="";t+="-- Face Names(English) --\n";for(var e=0;e<this.faceCount-1;e++)t+=this.englishFaceNames[e].dump();return t+="\n"},o.prototype._dumpEnglishBoneFrameNames=function(){var t="";t+="-- Bone Frame Names(English) --\n";for(var e=0;e<this.boneFrameNameCount;e++)t+=this.englishBoneFrameNames[e].dump();return t+="\n"},o.prototype._dumpToonTextures=function(){var t="";t+="-- Toon Textures --\n";for(var e=0;e<this.toonTextureCount;e++)t+=this.toonTextures[e].dump();return t+="\n"},o.prototype._dumpRigidBodies=function(){var t="";t+="-- Rigid Bodies --\n";for(var e=0;e<this.rigidBodyCount;e++)t+=this.rigidBodies[e].dump();return t+="\n"},o.prototype._dumpJoints=function(){var t="";t+="-- Joints --\n";for(var e=0;e<this.jointCount;e++)t+=this.joints[e].dump();return t+="\n"},e.exports=o},{"./PmdImageloader":21}],8:[function(t,e,i){"use strict";function o(t){this.id=t,this.name=null,this.parentIndex=null,this.tailIndex=null,this.type=null,this.ikIndex=null,this.position=null,this.motionIndex=null}o.prototype.isKnee=function(){return this.name.indexOf("0x820xd00x820xb4")>=0},o.prototype.dump=function(){var t="";return t+="id: "+this.id+"\n",t+="name: "+this.name+"\n",t+="parentIndex: "+this.parentIndex+"\n",t+="tailIndex: "+this.tailIndex+"\n",t+="type: "+this.type+"\n",t+="ikIndex: "+this.ikIndex+"\n",t+="position: "+this.position+"\n"},o.prototype.toRight=function(){this.position[2]=-this.position[2]},e.exports=o},{}],9:[function(t,e,i){"use strict";function o(t){this.id=t,this.index=null,this.frameIndex=null}o.prototype.dump=function(){var t="";return t+="id: "+this.id+"\n",t+="index: "+this.index+"\n",t+="frameIndex: "+this.frameIndex+"\n"},e.exports=o},{}],10:[function(t,e,i){"use strict";function o(t){this.id=t,this.name=null}o.prototype.dump=function(){var t="";return t+="id: "+this.id+"\n",t+="name: "+this.name+"\n"},e.exports=o},{}],11:[function(t,e,i){"use strict";function o(t){this.id=t,this.name=null}o.prototype.dump=function(){var t="";return t+="id: "+this.id+"\n",t+="name: "+this.name+"\n"},e.exports=o},{}],12:[function(t,e,i){"use strict";function o(t){this.id=t,this.name=null}o.prototype.dump=function(){var t="";return t+="id: "+this.id+"\n",t+="name: "+this.name+"\n"},e.exports=o},{}],13:[function(t,e,i){"use strict";function o(t){this.id=t,this.name=null}o.prototype.dump=function(){var t="";return t+="id: "+this.id+"\n",t+="name: "+this.name+"\n"},e.exports=o},{}],14:[function(t,e,i){"use strict";function o(){this.compatibility=null,this.modelName=null,this.comment=null}o.prototype.dump=function(){var t="";return t+="compatibility: "+this.compatibility+"\n",t+="modelName:     "+this.modelName+"\n",t+="comment: "+this.comment+"\n"},e.exports=o},{}],15:[function(t,e,i){"use strict";function o(t){this.id=t,this.name=null,this.vertexCount=null,this.type=null,this.vertices=null,this.done=!1,this.motionIndex=null}o.prototype.dump=function(){var t="";t+="id: "+this.id+"\n",t+="name: "+this.name+"\n",t+="vertexCount: "+this.vertexCount+"\n",t+="type: "+this.type+"\n";for(var e=0;e<this.vertices.length;e++)t+=this.vertices[e].dump();return t},o.prototype.toRight=function(){for(var t=0;t<this.vertices.length;t++)this.vertices[t].toRight()},e.exports=o},{}],16:[function(t,e,i){"use strict";function o(t){this.id=t,this.index=null}o.prototype.dump=function(){var t="";return t+="id: "+this.id+"\n",t+="index: "+this.index+"\n"},e.exports=o},{}],17:[function(t,e,i){"use strict";function o(t,e){this.id=t,this.type=e,this.index=null,this.position=null}o.prototype.dump=function(){var t="";return t+="id: "+this.id+"\n",t+="index: "+this.index+"\n",t+="position: "+this.position+"\n"},o.prototype.toRight=function(){this.position[2]=-this.position[2]},e.exports=o},{}],18:[function(t,e,i){"use strict";function o(t){this.parent=r,this.parent.call(this,t),this.englishCompatibility=!1}var r=t("../FileParser"),n=t("../Inherit").__inherit,s=t("./Pmd"),a=t("./PmdHeader"),h=t("./PmdVertex"),u=t("./PmdVertexIndex"),p=t("./PmdMaterial"),l=t("./PmdBone"),f=t("./PmdIk"),c=t("./PmdFace"),m=t("./PMDFaceVertex"),d=t("./PMDFaceDisplay"),_=t("./PMDBoneFrameName"),v=t("./PMDBoneDisplay"),y=t("./PMDEnglishHeader"),g=t("./PMDEnglishBoneName"),E=t("./PMDEnglishBoneFrameName"),T=t("./PMDEnglishFaceName"),x=t("./PMDToonTexture"),S=t("./PMDRigidBody"),A=t("./PMDJoint");n(o,r),o.prototype._HEADER_STRUCTURE={magic:{type:"char",isArray:!0,size:3},version:{type:"float"},modelName:{type:"char",isArray:!0,size:20},comment:{type:"char",isArray:!0,size:256}},o.prototype._VERTICES_STRUCTURE={count:{type:"uint32"},vertices:{type:"object",isArray:!0,size:"count"}},o.prototype._VERTEX_STRUCTURE={position:{type:"float",isArray:!0,size:3},normal:{type:"float",isArray:!0,size:3},uv:{type:"float",isArray:!0,size:2},boneIndices:{type:"uint16",isArray:!0,size:2},boneWeight:{type:"uint8"},edgeFlag:{type:"uint8"}},o.prototype._VERTEX_INDICES_STRUCTURE={count:{type:"uint32"},indices:{type:"object",isArray:!0,size:"count"}},o.prototype._VERTEX_INDEX_STRUCTURE={index:{type:"uint16"}},o.prototype._MATERIALS_STRUCTURE={count:{type:"uint32"},materials:{type:"object",isArray:!0,size:"count"}},o.prototype._MATERIAL_STRUCTURE={color:{type:"float",isArray:!0,size:4},specularity:{type:"float"},specularColor:{type:"float",isArray:!0,size:3},mirrorColor:{type:"float",isArray:!0,size:3},tuneIndex:{type:"uint8"},edgeFlag:{type:"uint8"},vertexCount:{type:"uint32"},fileName:{type:"char",isArray:!0,size:20}},o.prototype._BONES_STRUCTURE={count:{type:"uint16"},bones:{type:"object",isArray:!0,size:"count"}},o.prototype._BONE_STRUCTURE={name:{type:"strings",isArray:!0,size:20},parentIndex:{type:"uint16"},tailIndex:{type:"uint16"},type:{type:"uint8"},ikIndex:{type:"uint16"},position:{type:"float",isArray:!0,size:3}},o.prototype._IKS_STRUCTURE={count:{type:"uint16"},iks:{type:"object",isArray:!0,size:"count"}},o.prototype._IK_STRUCTURE={index:{type:"uint16"},targetBoneIndex:{type:"uint16"},chainLength:{type:"uint8"},iteration:{type:"uint16"},limitation:{type:"float"},childBoneIndices:{type:"uint16",isArray:!0,size:"chainLength"}},o.prototype._FACES_STRUCTURE={count:{type:"uint16"},faces:{type:"object",isArray:!0,size:"count"}},o.prototype._FACE_STRUCTURE={name:{type:"strings",isArray:!0,size:20},vertexCount:{type:"uint32"},type:{type:"uint8"},vertices:{type:"object",isArray:!0,size:"vertexCount"}},o.prototype._FACE_VERTEX_STRUCTURE={index:{type:"uint32"},position:{type:"float",isArray:!0,size:3}},o.prototype._FACE_DISPLAYS_STRUCTURE={count:{type:"uint8"},indices:{type:"object",isArray:!0,size:"count"}},o.prototype._FACE_DISPLAY_STRUCTURE={index:{type:"uint16"}},o.prototype._BONE_FRAME_NAMES_STRUCTURE={count:{type:"uint8"},names:{type:"object",isArray:!0,size:"count"}},o.prototype._BONE_FRAME_NAME_STRUCTURE={name:{type:"strings",isArray:!0,size:50}},o.prototype._BONE_DISPLAYS_STRUCTURE={count:{type:"uint32"},displays:{type:"object",isArray:!0,size:"count"}},o.prototype._BONE_DISPLAY_STRUCTURE={index:{type:"uint16"},frameIndex:{type:"uint8"}},o.prototype._ENGLISH_HEADER_STRUCTURE={compatibility:{type:"uint8"},modelName:{type:"char",isArray:!0,size:20},comment:{type:"char",isArray:!0,size:256}},o.prototype._ENGLISH_BONE_NAME_STRUCTURE={name:{type:"char",isArray:!0,size:20}},o.prototype._ENGLISH_FACE_NAME_STRUCTURE={name:{type:"char",isArray:!0,size:20}},o.prototype._ENGLISH_BONE_FRAME_NAME_STRUCTURE={name:{type:"char",isArray:!0,size:50}},o.prototype._TOON_TEXTURE_STRUCTURE={fileName:{type:"char",isArray:!0,size:100}},o.prototype._RIGID_BODIES_STRUCTURE={count:{type:"uint32"},bodies:{type:"object",isArray:!0,size:"count"}},o.prototype._RIGID_BODY_STRUCTURE={name:{type:"strings",isArray:!0,size:20},boneIndex:{type:"uint16"},groupIndex:{type:"uint8"},groupTarget:{type:"uint16"},shapeType:{type:"uint8"},width:{type:"float"},height:{type:"float"},depth:{type:"float"},position:{type:"float",isArray:!0,size:3},rotation:{type:"float",
isArray:!0,size:3},weight:{type:"float"},positionDim:{type:"float"},rotationDim:{type:"float"},recoil:{type:"float"},friction:{type:"float"},type:{type:"uint8"}},o.prototype._JOINTS_STRUCTURE={count:{type:"uint32"},joints:{type:"object",isArray:!0,size:"count"}},o.prototype._JOINT_STRUCTURE={name:{type:"strings",isArray:!0,size:20},rigidBody1:{type:"uint32"},rigidBody2:{type:"uint32"},position:{type:"float",isArray:!0,size:3},rotation:{type:"float",isArray:!0,size:3},translationLimitation1:{type:"float",isArray:!0,size:3},translationLimitation2:{type:"float",isArray:!0,size:3},rotationLimitation1:{type:"float",isArray:!0,size:3},rotationLimitation2:{type:"float",isArray:!0,size:3},springPosition:{type:"float",isArray:!0,size:3},springRotation:{type:"float",isArray:!0,size:3}},o.prototype.parse=function(){this.offset=0;var t=new s;return this._parseHeader(t),this._parseVertices(t),this._parseVertexIndices(t),this._parseMaterials(t),this._parseBones(t),this._parseIKs(t),this._parseFaces(t),this._parseFaceDisplays(t),this._parseBoneFrameNames(t),this._parseBoneDisplays(t),this._parseEnglishHeader(t),this.englishCompatibility&&(this._parseEnglishBoneNames(t),this._parseEnglishFaceNames(t),this._parseEnglishBoneFrameNames(t)),this._parseToonTextures(t),this._parseRigidBodies(t),this._parseJoints(t),t},o.prototype.valid=function(){var t=this.offset;this.offset=0;var e=new s;return this._parseHeader(e),this.offset=t,e.valid()},o.prototype._parseHeader=function(t){var e=this._HEADER_STRUCTURE;t.header=new a,this._parseObject(t.header,e)},o.prototype._parseVertices=function(t){var e=this._VERTICES_STRUCTURE;t.vertexCount=this._getValue(e.count,this.offset),this.offset+=this._sizeof(e.count),t.vertices.length=0;for(var i=0;i<t.vertexCount;i++)this._parseVertex(t,i)},o.prototype._parseVertex=function(t,e){var i=this._VERTEX_STRUCTURE,o=new h(e);this._parseObject(o,i),t.vertices[e]=o},o.prototype._parseVertexIndices=function(t){var e=this._VERTEX_INDICES_STRUCTURE;t.vertexIndexCount=this._getValue(e.count,this.offset),this.offset+=this._sizeof(e.count),t.vertexIndices.length=0;for(var i=0;i<t.vertexIndexCount;i++)this._parseVertexIndex(t,i)},o.prototype._parseVertexIndex=function(t,e){var i=this._VERTEX_INDEX_STRUCTURE,o=new u(e);this._parseObject(o,i),t.vertexIndices[e]=o},o.prototype._parseMaterials=function(t){var e=this._MATERIALS_STRUCTURE;t.materialCount=this._getValue(e.count,this.offset),this.offset+=this._sizeof(e.count),t.materials.length=0;for(var i=0;i<t.materialCount;i++)this._parseMaterial(t,i)},o.prototype._parseMaterial=function(t,e){var i=this._MATERIAL_STRUCTURE,o=new p(e);this._parseObject(o,i),t.materials[e]=o},o.prototype._parseBones=function(t){var e=this._BONES_STRUCTURE;t.boneCount=this._getValue(e.count,this.offset),this.offset+=this._sizeof(e.count),t.bones.length=0;for(var i=0;i<t.boneCount;i++)this._parseBone(t,i)},o.prototype._parseBone=function(t,e){var i=this._BONE_STRUCTURE,o=new l(e);this._parseObject(o,i),t.bones[e]=o},o.prototype._parseIKs=function(t){var e=this._IKS_STRUCTURE;t.ikCount=this._getValue(e.count,this.offset),this.offset+=this._sizeof(e.count),t.iks.length=0;for(var i=0;i<t.ikCount;i++)this._parseIK(t,i)},o.prototype._parseIK=function(t,e){var i=this._IK_STRUCTURE,o=new f(e);for(var r in i)"childBoneIndices"!=r&&(o[r]=this._getValue(i[r],this.offset),this.offset+=this._sizeof(i[r]));o.childBoneIndices=[];for(var n=this._sizeofScalar(i.childBoneIndices),s=0;s<o.chainLength;s++)o.childBoneIndices[s]=this._getValueScalar(i.childBoneIndices,this.offset),this.offset+=n;t.iks[e]=o},o.prototype._parseFaces=function(t){var e=this._FACES_STRUCTURE;t.faceCount=this._getValue(e.count,this.offset),this.offset+=this._sizeof(e.count),t.faces.length=0;for(var i=0;i<t.faceCount;i++)this._parseFace(t,i)},o.prototype._parseFace=function(t,e){var i=this._FACE_STRUCTURE,o=new c(e);for(var r in i)"vertices"!=r&&(o[r]=this._getValue(i[r],this.offset),this.offset+=this._sizeof(i[r]));o.vertices=[];for(var n=0;n<o.vertexCount;n++)this._parseFaceVertex(o,n,o.type);t.faces[e]=o},o.prototype._parseFaceVertex=function(t,e,i){var o=this._FACE_VERTEX_STRUCTURE,r=new m(e,i);this._parseObject(r,o),t.vertices[e]=r},o.prototype._parseFaceDisplays=function(t){var e=this._FACE_DISPLAYS_STRUCTURE;t.faceDisplayCount=this._getValue(e.count,this.offset),this.offset+=this._sizeof(e.count),t.faceDisplays.length=0;for(var i=0;i<t.faceDisplayCount;i++)this._parseFaceDisplay(t,i)},o.prototype._parseFaceDisplay=function(t,e){var i=this._FACE_DISPLAY_STRUCTURE,o=new d(e);this._parseObject(o,i),t.faceDisplays[e]=o},o.prototype._parseBoneFrameNames=function(t){var e=this._BONE_FRAME_NAMES_STRUCTURE;t.boneFrameNameCount=this._getValue(e.count,this.offset),this.offset+=this._sizeof(e.count),t.boneFrameNames.length=0;for(var i=0;i<t.boneFrameNameCount;i++)this._parseBoneFrameName(t,i)},o.prototype._parseBoneFrameName=function(t,e){var i=this._BONE_FRAME_NAME_STRUCTURE,o=new _(e);this._parseObject(o,i),t.boneFrameNames[e]=o},o.prototype._parseBoneDisplays=function(t){var e=this._BONE_DISPLAYS_STRUCTURE;t.boneDisplayCount=this._getValue(e.count,this.offset),this.offset+=this._sizeof(e.count),t.boneDisplays.length=0;for(var i=0;i<t.boneDisplayCount;i++)this._parseBoneDisplay(t,i)},o.prototype._parseBoneDisplay=function(t,e){var i=this._BONE_DISPLAY_STRUCTURE,o=new v(e);this._parseObject(o,i),t.boneDisplays[e]=o},o.prototype._parseEnglishHeader=function(t){var e=this._ENGLISH_HEADER_STRUCTURE;t.englishHeader=new y,this._parseObject(t.englishHeader,e),0==t.englishHeader.compatibility?(this.offset-=this._sizeofObject(e),this.offset+=this._sizeof(e.compatibility),this.englishCompatibility=!1):this.englishCompatibility=!0},o.prototype._parseEnglishBoneNames=function(t){var e=this._ENGLISH_BONE_NAME_STRUCTURE;t.englishBoneNames.length=0;for(var i=0;i<t.boneCount;i++){var o=new g(i);this._parseObject(o,e),t.englishBoneNames[i]=o}},o.prototype._parseEnglishFaceNames=function(t){var e=this._ENGLISH_FACE_NAME_STRUCTURE;t.englishFaceNames.length=0;for(var i=0;i<t.faceCount-1;i++){var o=new T(i);this._parseObject(o,e),t.englishFaceNames[i]=o}},o.prototype._parseEnglishBoneFrameNames=function(t){var e=this._ENGLISH_BONE_FRAME_NAME_STRUCTURE;t.englishBoneFrameNames.length=0;for(var i=0;i<t.boneFrameNameCount;i++){var o=new E(i);this._parseObject(o,e),t.englishBoneFrameNames[i]=o}},o.prototype._parseToonTextures=function(t){var e=this._TOON_TEXTURE_STRUCTURE;t.toonTextureCount=10,t.toonTextures.length=0;for(var i=0;i<t.toonTextureCount;i++){var o=new x(i);this._parseObject(o,e),t.toonTextures[i]=o}},o.prototype._parseRigidBodies=function(t){var e=this._RIGID_BODIES_STRUCTURE;t.rigidBodyCount=this._getValue(e.count,this.offset),this.offset+=this._sizeof(e.count),t.rigidBodies.length=0;for(var i=0;i<t.rigidBodyCount;i++)this._parseRigidBody(t,i)},o.prototype._parseRigidBody=function(t,e){var i=this._RIGID_BODY_STRUCTURE,o=new S(e);this._parseObject(o,i),t.rigidBodies[e]=o},o.prototype._parseJoints=function(t){var e=this._JOINTS_STRUCTURE;t.jointCount=this._getValue(e.count,this.offset),this.offset+=this._sizeof(e.count),t.joints.length=0;for(var i=0;i<t.jointCount;i++)this._parseJoint(t,i)},o.prototype._parseJoint=function(t,e){var i=this._JOINT_STRUCTURE,o=new A(e);this._parseObject(o,i),t.joints[e]=o},e.exports=o},{"../FileParser":1,"../Inherit":2,"./PMDBoneDisplay":9,"./PMDBoneFrameName":10,"./PMDEnglishBoneFrameName":11,"./PMDEnglishBoneName":12,"./PMDEnglishFaceName":13,"./PMDEnglishHeader":14,"./PMDFaceDisplay":16,"./PMDFaceVertex":17,"./PMDJoint":22,"./PMDRigidBody":25,"./PMDToonTexture":26,"./Pmd":7,"./PmdBone":8,"./PmdFace":15,"./PmdHeader":19,"./PmdIk":20,"./PmdMaterial":23,"./PmdVertex":27,"./PmdVertexIndex":28}],19:[function(t,e,i){"use strict";function o(){this.magic=null,this.version=null,this.modelName=null,this.comment=null}o.prototype.valid=function(){return"Pmd"==this.magic},o.prototype.dump=function(){var t="";return t+="magic: "+this.magic+"\n",t+="version: "+this.version+"\n",t+="model_name: "+this.modelName+"\n",t+="comment: "+this.comment+"\n"},e.exports=o},{}],20:[function(t,e,i){"use strict";function o(t){this.id=t,this.index=null,this.targetBoneIndex=null,this.chainLength=null,this.iteration=null,this.limitation=null,this.childBoneIndices=null}o.prototype.dump=function(){var t="";return t+="id: "+this.id+"\n",t+="index: "+this.index+"\n",t+="targetBoneIndex: "+this.targetBoneIndex+"\n",t+="chainLength: "+this.chainLength+"\n",t+="iteration: "+this.iteration+"\n",t+="limitation: "+this.limitation+"\n",t+="childBoneIndices: "+this.childBoneIndices+"\n"},e.exports=o},{}],21:[function(t,e,i){"use strict";function o(t,e){this.pmd=t,this.baseURL=e,this.errorImageNum=0,this.loadedImageNum=0,this.noImageNum=0}o.prototype.load=function(t){this.pmd.images.length=0,this.pmd.toonImages.length=0,this.pmd.sphereImages.length=0,this.errorImageNum=0,this.loadedImageNum=0,this.noImageNum=0;for(var e=0;e<this.pmd.materialCount;e++){var i=this.pmd.materials[e].convertedFileName();if(""==i||i.indexOf(".spa")>=0||i.indexOf(".sph")>=0)this.pmd.images[e]=this._generatePixelImage(),this.noImageNum++,this._checkDone(t);else{var o=this;this.pmd.images[e]=new Image,this.pmd.images[e].onerror=function(e){o.errorImageNum++,o._checkDone(t)},this.pmd.images[e].onload=function(e){o.loadedImageNum++,o._checkDone(t)},this.pmd.images[e].src=this.baseURL+"/"+i}}for(var e=0;e<this.pmd.toonTextureCount;e++){var i=this.pmd.toonTextures[e].fileName;if(""==i||i.indexOf(".spa")>=0||i.indexOf(".sph")>=0)this.pmd.toonImages[e]=this._generatePixelImage(),this.noImageNum++,this._checkDone(t);else{var o=this;this.pmd.toonImages[e]=new Image,this.pmd.toonImages[e].onerror=function(e){o.errorImageNum++,o._checkDone(t)},this.pmd.toonImages[e].onload=function(e){o.loadedImageNum++,o._checkDone(t)},this.pmd.toonImages[e].src=this.baseURL+"/"+i}}for(var e=0;e<this.pmd.materialCount;e++)if(this.pmd.materials[e].hasSphereTexture()){var i=this.pmd.materials[e].sphereMapFileName(),o=this;this.pmd.sphereImages[e]=new Image,this.pmd.sphereImages[e].onerror=function(e){o.errorImageNum++,o._checkDone(t)},this.pmd.sphereImages[e].onload=function(e){o.loadedImageNum++,o._checkDone(t)},this.pmd.sphereImages[e].src=this.baseURL+"/"+i}else this.pmd.sphereImages[e]=this._generatePixelImage(),this.noImageNum++,this._checkDone(t)},o.prototype._generatePixelImage=function(){var t=document.createElement("canvas");t.width=1,t.height=1;var e=t.getContext("2d");return e.fillStyle="rgb(255, 255, 255)",e.fillRect(0,0,1,1),t},o.prototype._checkDone=function(t){this.loadedImageNum+this.noImageNum+this.errorImageNum>=2*this.pmd.materialCount+this.pmd.toonTextureCount&&t(this.pmd)},e.exports=o},{}],22:[function(t,e,i){"use strict";function o(t){this.id=t,this.name=null,this.rigidBody1=null,this.rigidBody2=null,this.position=null,this.rotation=null,this.translationLimitation1=null,this.translationLimitation2=null,this.rotationLimitation1=null,this.rotationLimitation2=null,this.springPosition=null,this.springRotation=null}o.prototype.dump=function(){var t="";return t+="id: "+this.id+"\n",t+="name: "+this.name+"\n",t+="rigidBody1: "+this.rigidBody1+"\n",t+="rigidBody2: "+this.rigidBody2+"\n",t+="position: "+this.position+"\n",t+="rotation: "+this.rotation+"\n",t+="translationLimitation1: "+this.translationLimitation1+"\n",t+="translationLimitation2: "+this.translationLimitation2+"\n",t+="rotationLimitation1: "+this.rotationLimitation1+"\n",t+="rotationLimitation2: "+this.rotationLimitation2+"\n",t+="springPosition: "+this.springPosition+"\n",t+="springRotation: "+this.springRotation+"\n"},o.prototype.toRight=function(){this.position[2]=-this.position[2],this.rotation[0]=-this.rotation[0],this.rotation[1]=-this.rotation[1]},e.exports=o},{}],23:[function(t,e,i){"use strict";function o(t){this.id=t,this.color=null,this.specularity=null,this.specularColor=null,this.mirrorColor=null,this.tuneIndex=null,this.edgeFlag=null,this.vertexCount=null,this.fileName=null}o.prototype.convertedFileName=function(){var t,e=this.fileName.replace(".tga",".png");return(t=e.lastIndexOf("*"))>=0&&(e=e.substring(0,t)),e},o.prototype.hasSphereTexture=function(){return this.fileName.lastIndexOf(".sph")>=0||this.fileName.lastIndexOf(".spa")>=0?!0:!1},o.prototype.isSphereMapAddition=function(){var t=this.fileName;return t.lastIndexOf(".spa")>=0?!0:!1},o.prototype.sphereMapFileName=function(){var t,e=this.fileName;return(t=e.lastIndexOf("*"))>=0&&(e=e.slice(t+1)),(t=e.lastIndexOf("+"))>=0&&(e=e.slice(t+1)),e},o.prototype.hasToon=function(){return this.tuneIndex>=10?!1:!0},o.prototype.dump=function(){var t="";return t+="id: "+this.id+"\n",t+="color: "+this.color+"\n",t+="specularity: "+this.specularity+"\n",t+="specularColor: "+this.specularColor+"\n",t+="mirrorColor: "+this.mirrorColor+"\n",t+="tuneIndex: "+this.tuneIndex+"\n",t+="edgeFlag: "+this.edgeFlag+"\n",t+="vertexCount: "+this.vertexCount+"\n",t+="fileName: "+this.fileName+"\n"},e.exports=o},{}],24:[function(t,e,i){"use strict";function o(t,e,i){this.layer=t,this.pmd=e,this.view=i,this.vmd=null,this.audio=null,this.vtf=t.generateTexture(),this.vtfWidth=t.calculateVTFWidth(7*e.boneCount);var o=new ArrayBuffer(this.vtfWidth*this.vtfWidth*4);this.vtfUint8Array=new Uint8Array(o),this.vtfFloatArray=new Float32Array(o),this.vArray=t.createFloatArray(e.vertexCount*this._V_ITEM_SIZE),this.vArray1=t.createFloatArray(e.vertexCount*this._V_ITEM_SIZE),this.vArray2=t.createFloatArray(e.vertexCount*this._V_ITEM_SIZE),this.vmArray=t.createFloatArray(e.vertexCount*this._V_ITEM_SIZE),this.veArray=t.createFloatArray(e.vertexCount*this._VE_ITEM_SIZE),this.mtArray1=t.createFloatArray(e.vertexCount*this._MT_ITEM_SIZE),this.mtArray2=t.createFloatArray(e.vertexCount*this._MT_ITEM_SIZE),this.mrArray1=t.createFloatArray(e.vertexCount*this._MR_ITEM_SIZE),this.mrArray2=t.createFloatArray(e.vertexCount*this._MR_ITEM_SIZE),this.cArray=t.createFloatArray(e.vertexCount*this._C_ITEM_SIZE),this.iArray=t.createUintArray(e.vertexIndexCount),this.biArray=t.createFloatArray(e.vertexCount*this._BI_ITEM_SIZE),this.bwArray=t.createFloatArray(e.vertexCount*this._BW_ITEM_SIZE),this.vnArray=t.createFloatArray(e.vertexCount*this._VN_ITEM_SIZE),this.vBuffer=t.createBuffer(),this.vBuffer1=t.createBuffer(),this.vBuffer2=t.createBuffer(),this.vmBuffer=t.createBuffer(),this.veBuffer=t.createBuffer(),this.mtBuffer1=t.createBuffer(),this.mtBuffer2=t.createBuffer(),this.mrBuffer1=t.createBuffer(),this.mrBuffer2=t.createBuffer(),this.cBuffer=t.createBuffer(),this.iBuffer=t.createBuffer(),this.biBuffer=t.createBuffer(),this.bwBuffer=t.createBuffer(),this.vnBuffer=t.createBuffer(),this.textures=[],this.toonTextures=[],this.sphereTextures=[],this.basePosition=[0,0,0],this.frame=0,this.motions=[],this.originalMotions={},this.posFromBone1=[],this.posFromBone2=[],this.dancing=!1,this.physics=new r(this.pmd)}var r=t("../Physics/Physics");o.prototype.Math=Math,o.prototype.vec3=vec3,o.prototype.quat4=quat4,o.prototype.mat4=mat4,o.prototype._V_ITEM_SIZE=3,o.prototype._C_ITEM_SIZE=2,o.prototype._I_ITEM_SIZE=1,o.prototype._BW_ITEM_SIZE=1,o.prototype._BI_ITEM_SIZE=2,o.prototype._MT_ITEM_SIZE=3,o.prototype._MR_ITEM_SIZE=4,o.prototype._VN_ITEM_SIZE=3,o.prototype._VE_ITEM_SIZE=1,o.prototype.setup=function(){for(var t=0;t<this.pmd.vertexCount;t++){for(var e=0;e<this._MT_ITEM_SIZE;e++)this.mtArray1[t*this._MT_ITEM_SIZE+e]=0,this.mtArray2[t*this._MT_ITEM_SIZE+e]=0;for(var e=0;e<this._MR_ITEM_SIZE;e++)this.mrArray1[t*this._MR_ITEM_SIZE+e]=0,this.mrArray2[t*this._MR_ITEM_SIZE+e]=0}var i=this.layer;i.pourArrayBuffer(this.mtBuffer1,this.mtArray1,this._MT_ITEM_SIZE,this.pmd.vertexCount),i.pourArrayBuffer(this.mtBuffer2,this.mtArray2,this._MT_ITEM_SIZE,this.pmd.vertexCount),i.pourArrayBuffer(this.mrBuffer1,this.mrArray1,this._MR_ITEM_SIZE,this.pmd.vertexCount),i.pourArrayBuffer(this.mrBuffer2,this.mrArray2,this._MR_ITEM_SIZE,this.pmd.vertexCount),this._initArrays(),this._initTextures(),this._pourArrays(),this._bindBuffers()},o.prototype.setBasePosition=function(t,e,i){this.basePosition[0]=t,this.basePosition[1]=e,this.basePosition[2]=i,this._initMotions2();for(var o=0;o<this.pmd.boneCount;o++)this._getBoneMotion(o);this.physics.resetRigidBodies(this.motions)},o.prototype.setVMD=function(t){this.vmd=t},o.prototype.startDance=function(){this.vmd.setup(this.pmd),this.dancing=!0,this.frame=0,this._initMotions2(),this._moveBone(1),this.physics.resetRigidBodies(this.motions)},o.prototype._initArrays=function(){this._initVertices(),this._initVerticesFromBones(),this._initVertexMorphs(),this._initVertexEdges(),this._initCoordinates(),this._initIndices(),this._initBoneWeights(),this._initBoneIndices(),this._initVertexNormals(),this._initMotions(),this._initMotionArrays()},o.prototype._initVertices=function(){for(var t=0;t<this.pmd.vertexCount;t++)for(var e=this.pmd.vertices[t].position,i=t*this._V_ITEM_SIZE,o=0;o<this._V_ITEM_SIZE;o++)this.vArray[i+o]=e[o]},o.prototype._initVerticesFromBones=function(){for(var t=0;t<this.pmd.vertexCount;t++){for(var e=this.pmd.vertices[t].position,i=this.pmd.vertices[t].boneIndices[0],o=this.pmd.vertices[t].boneIndices[1],r=this.pmd.bones[i],n=this.pmd.bones[o],s=this.vec3.create(),a=this.vec3.create(),h=0;h<this._V_ITEM_SIZE;h++)s[h]=e[h]-r.position[h],a[h]=e[h]-n.position[h];this.posFromBone1.push(s),this.posFromBone2.push(a);for(var u=t*this._V_ITEM_SIZE,h=0;h<this._V_ITEM_SIZE;h++)this.vArray1[u+h]=e[h]-r.position[h],this.vArray2[u+h]=e[h]-n.position[h]}},o.prototype._initVertexMorphs=function(){for(var t=0;t<this.pmd.vertexCount;t++)for(var e=t*this._V_ITEM_SIZE,i=0;i<this._V_ITEM_SIZE;i++)this.vmArray[e+i]=0},o.prototype._initVertexEdges=function(){for(var t=0;t<this.pmd.vertexCount;t++)this.veArray[t]=this.pmd.vertices[t].edgeFlag?0:1},o.prototype._initCoordinates=function(){for(var t=0;t<this.pmd.vertexCount;t++)for(var e=t*this._C_ITEM_SIZE,i=this.pmd.vertices[t].uv,o=0;o<this._C_ITEM_SIZE;o++)this.cArray[e+o]=i[o]},o.prototype._initIndices=function(){for(var t=0;t<this.pmd.vertexIndexCount;t++)this.iArray[t]=this.pmd.vertexIndices[t].index},o.prototype._initBoneWeights=function(){for(var t=0;t<this.pmd.vertexCount;t++)this.bwArray[t]=this.pmd.vertices[t].boneWeight/100},o.prototype._initBoneIndices=function(){for(var t=0;t<this.pmd.vertexCount;t++)for(var e=0;e<this._BI_ITEM_SIZE;e++)this.biArray[t*this._BI_ITEM_SIZE+e]=this.pmd.vertices[t].boneIndices[e]},o.prototype._initVertexNormals=function(){for(var t=0;t<this.pmd.vertexCount;t++)for(var e=this.pmd.vertices[t].normal,i=t*this._VN_ITEM_SIZE,o=0;o<this._VN_ITEM_SIZE;o++)this.vnArray[i+o]=e[o]},o.prototype._initMotionArrays=function(){if(this.view.skinningType==this.view._SKINNING_CPU)return void this._skinning();if(this.view.skinningType==this.view._SKINNING_GPU)return void this._pourVTF();for(var t=0;t<this.pmd.vertexCount;t++){for(var e=this.pmd.vertices[t].boneIndices[0],i=this.pmd.vertices[t].boneIndices[1],o=this._getBoneMotion(e),r=this._getBoneMotion(i),n=t*this._MT_ITEM_SIZE,s=0;s<this._MT_ITEM_SIZE;s++)this.mtArray1[n+s]=o.p[s],this.mtArray2[n+s]=r.p[s];n=t*this._MR_ITEM_SIZE;for(var s=0;s<this._MR_ITEM_SIZE;s++)this.mrArray1[n+s]=o.r[s],this.mrArray2[n+s]=r.r[s]}var a=this.layer;this.layer.gl,this.layer.shader;a.pourArrayBuffer(this.mtBuffer1,this.mtArray1,this._MT_ITEM_SIZE,this.pmd.vertexCount),a.pourArrayBuffer(this.mtBuffer2,this.mtArray2,this._MT_ITEM_SIZE,this.pmd.vertexCount),a.pourArrayBuffer(this.mrBuffer1,this.mrArray1,this._MR_ITEM_SIZE,this.pmd.vertexCount),a.pourArrayBuffer(this.mrBuffer2,this.mrArray2,this._MR_ITEM_SIZE,this.pmd.vertexCount)},o.prototype._initTextures=function(){for(var t=0;t<this.pmd.materialCount;t++)this.textures[t]=this.layer.generateTexture(this.pmd.images[t]);for(var t=0;t<this.pmd.toonTextureCount;t++)this.toonTextures[t]=this.layer.generateTexture(this.pmd.toonImages[t]);for(var t=0;t<this.pmd.materialCount;t++)this.sphereTextures[t]=this.layer.generateTexture(this.pmd.sphereImages[t])},o.prototype._initMotions=function(){for(var t=0;t<this.pmd.boneCount;t++){this.motions[t]={r:this.quat4.create(),p:this.vec3.create(),done:!1};var e=this.pmd.bones[t],i={};i.location=[0,0,0],i.rotation=[0,0,0,1],this.originalMotions[e.name]=i}},o.prototype._initMotions2=function(){for(var t=0;t<this.pmd.boneCount;t++){this.quat4.clear(this.motions[t].r),this.vec3.clear(this.motions[t].p),this.motions[t].done=!1;var e=this.pmd.bones[t],i=this.originalMotions[e.name];this.vec3.clear(i.location),this.quat4.clear(i.rotation)}},o.prototype._packTo4Uint8=function(t,e,i){t=1*t;var o=0>t?128:0;t=this.Math.abs(t),e[i+0]=o|127&t,e[i+1]=256*t&255,e[i+2]=256*t*256&255,e[i+3]=256*t*256*256&255},o.prototype._pourVTF=function(){for(var t=0;t<this.pmd.boneCount;t++){var e=7*t*4,i=this._getBoneMotion(t);this._packTo4Uint8(i.p[0],this.vtfUint8Array,e+0),this._packTo4Uint8(i.p[1],this.vtfUint8Array,e+4),this._packTo4Uint8(i.p[2],this.vtfUint8Array,e+8),this._packTo4Uint8(i.r[0],this.vtfUint8Array,e+12),this._packTo4Uint8(i.r[1],this.vtfUint8Array,e+16),this._packTo4Uint8(i.r[2],this.vtfUint8Array,e+20),this._packTo4Uint8(i.r[3],this.vtfUint8Array,e+24)}this.layer.pourVTF(this.vtf,this.vtfUint8Array,this.vtfWidth)},o.prototype.skinningOneBone=function(t){if(null===t.id)return null;var e=this._getBoneMotion(t.id),i=t.posFromBone,o=[0,0,0];return this.quat4.multiplyVec3(e.r,i,o),this.vec3.add(o,e.p,o),o},o.prototype._skinning=function(){for(var t=this.vec3.create(),e=this.vec3.create(),i=0;i<this.pmd.vertexCount;i++){var o=this.pmd.vertices[i],r=o.boneWeight,n=o.boneIndices[0],s=(this.pmd.bones[n],this._getBoneMotion(n)),a=this.posFromBone1[i];this.quat4.multiplyVec3(s.r,a,t),this.vec3.add(t,s.p,t);var h=i*this._V_ITEM_SIZE;if(r>=99)this.vArray[h+0]=t[0],this.vArray[h+1]=t[1],this.vArray[h+2]=t[2];else{var u=o.boneIndices[1],p=(this.pmd.bones[u],this._getBoneMotion(u)),l=this.posFromBone2[i];this.quat4.multiplyVec3(p.r,l,e),this.vec3.add(e,p.p,e);var f=o.boneWeightFloat1,c=o.boneWeightFloat2;this.vArray[h+0]=t[0]*f+e[0]*c,this.vArray[h+1]=t[1]*f+e[1]*c,this.vArray[h+2]=t[2]*f+e[2]*c}}this.layer.pourArrayBuffer(this.vBuffer,this.vArray,this._V_ITEM_SIZE,this.pmd.vertexCount)},o.prototype._pourArrays=function(){var t=this.layer;t.pourArrayBuffer(this.vBuffer,this.vArray,this._V_ITEM_SIZE,this.pmd.vertexCount),t.pourArrayBuffer(this.vBuffer1,this.vArray1,this._V_ITEM_SIZE,this.pmd.vertexCount),t.pourArrayBuffer(this.vBuffer2,this.vArray2,this._V_ITEM_SIZE,this.pmd.vertexCount),t.pourArrayBuffer(this.vmBuffer,this.vmArray,this._V_ITEM_SIZE,this.pmd.vertexCount),t.pourArrayBuffer(this.cBuffer,this.cArray,this._C_ITEM_SIZE,this.pmd.vertexCount),t.pourElementArrayBuffer(this.iBuffer,this.iArray,this._I_ITEM_SIZE,this.pmd.vertexIndexCount),t.pourArrayBuffer(this.bwBuffer,this.bwArray,this._BW_ITEM_SIZE,this.pmd.vertexCount),t.pourArrayBuffer(this.biBuffer,this.biArray,this._BI_ITEM_SIZE,this.pmd.vertexCount),t.pourArrayBuffer(this.vnBuffer,this.vnArray,this._VN_ITEM_SIZE,this.pmd.vertexCount),t.pourArrayBuffer(this.veBuffer,this.veArray,this._VE_ITEM_SIZE,this.pmd.vertexCount)},o.prototype._bindBuffers=function(){var t=(this.layer,this.layer.gl),e=this.layer.shader;t.bindBuffer(t.ARRAY_BUFFER,this.vBuffer),t.enableVertexAttribArray(e.vertexPositionAttribute),t.vertexAttribPointer(e.vertexPositionAttribute,this.vBuffer.itemSize,t.FLOAT,!1,0,0),t.bindBuffer(t.ARRAY_BUFFER,this.vBuffer1),t.enableVertexAttribArray(e.vertexPositionAttribute1),t.vertexAttribPointer(e.vertexPositionAttribute1,this.vBuffer1.itemSize,t.FLOAT,!1,0,0),t.bindBuffer(t.ARRAY_BUFFER,this.vBuffer2),t.enableVertexAttribArray(e.vertexPositionAttribute2),t.vertexAttribPointer(e.vertexPositionAttribute2,this.vBuffer2.itemSize,t.FLOAT,!1,0,0),t.bindBuffer(t.ARRAY_BUFFER,this.vmBuffer),t.enableVertexAttribArray(e.vertexMorphAttribute),t.vertexAttribPointer(e.vertexMorphAttribute,this.vmBuffer.itemSize,t.FLOAT,!1,0,0),t.bindBuffer(t.ARRAY_BUFFER,this.cBuffer),t.enableVertexAttribArray(e.textureCoordAttribute),t.vertexAttribPointer(e.textureCoordAttribute,this.cBuffer.itemSize,t.FLOAT,!1,0,0),t.bindBuffer(t.ARRAY_BUFFER,this.bwBuffer),t.enableVertexAttribArray(e.boneWeightAttribute),t.vertexAttribPointer(e.boneWeightAttribute,this.bwBuffer.itemSize,t.FLOAT,!1,0,0),t.bindBuffer(t.ARRAY_BUFFER,this.biBuffer),t.enableVertexAttribArray(e.boneIndicesAttribute),t.vertexAttribPointer(e.boneIndicesAttribute,this.biBuffer.itemSize,t.FLOAT,!1,0,0),t.bindBuffer(t.ARRAY_BUFFER,this.vnBuffer),t.enableVertexAttribArray(e.vertexNormalAttribute),t.vertexAttribPointer(e.vertexNormalAttribute,this.vnBuffer.itemSize,t.FLOAT,!1,0,0),t.bindBuffer(t.ARRAY_BUFFER,this.veBuffer),t.enableVertexAttribArray(e.vertexEdgeAttribute),t.vertexAttribPointer(e.vertexEdgeAttribute,this.veBuffer.itemSize,t.FLOAT,!1,0,0),t.bindBuffer(t.ARRAY_BUFFER,this.mtBuffer1),t.enableVertexAttribArray(e.motionTranslationAttribute1),t.vertexAttribPointer(e.motionTranslationAttribute1,this.mtBuffer1.itemSize,t.FLOAT,!1,0,0),t.bindBuffer(t.ARRAY_BUFFER,this.mtBuffer2),t.enableVertexAttribArray(e.motionTranslationAttribute2),t.vertexAttribPointer(e.motionTranslationAttribute2,this.mtBuffer2.itemSize,t.FLOAT,!1,0,0),t.bindBuffer(t.ARRAY_BUFFER,this.mrBuffer1),t.enableVertexAttribArray(e.motionRotationAttribute1),t.vertexAttribPointer(e.motionRotationAttribute1,this.mrBuffer1.itemSize,t.FLOAT,!1,0,0),t.bindBuffer(t.ARRAY_BUFFER,this.mrBuffer2),t.enableVertexAttribArray(e.motionRotationAttribute2),t.vertexAttribPointer(e.motionRotationAttribute2,this.mrBuffer2.itemSize,t.FLOAT,!1,0,0),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this.iBuffer)},o.prototype._draw=function(t,e,i){this.layer.draw(t,this.layer._BLEND_ALPHA,i,e)},o.prototype.update=function(t){this._initMotions2(),this.dancing&&(this._moveBone(t),this.view.morphType==this.view._MORPH_ON&&this._moveFace());for(var e=0;e<this.pmd.boneCount;e++)this._getBoneMotion(e);this.view.physicsType==this.view._PHYSICS_ON&&this._runPhysics(t),this._initMotionArrays()},o.prototype.draw=function(){var t=(this.layer,this.layer.gl),e=this.layer.shader;this._bindBuffers(),this.view.skinningType==this.view._SKINNING_GPU?(t.activeTexture(t.TEXTURE1),t.bindTexture(t.TEXTURE_2D,this.vtf),t.uniform1i(e.uVTFUniform,1)):t.uniform1i(e.uVTFUniform,0),t.uniform1i(e.edgeUniform,0),t.enable(t.BLEND),t.blendFuncSeparate(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA,t.SRC_ALPHA,t.DST_ALPHA);for(var i=0,o=0;o<this.pmd.materialCount;o++){var r=this.pmd.materials[o];r.edgeFlag?t.uniform1i(e.shadowUniform,1):t.uniform1i(e.shadowUniform,0),this.view.edgeType==this.view._EDGE_ON&&1==r.color[3]?(t.enable(t.CULL_FACE),t.cullFace(t.FRONT)):(t.disable(t.CULL_FACE),t.cullFace(t.FRONT)),t.uniform4fv(e.diffuseColorUniform,r.color),t.uniform3fv(e.ambientColorUniform,r.mirrorColor),t.uniform3fv(e.specularColorUniform,r.specularColor),t.uniform1f(e.shininessUniform,r.specularity),r.hasToon()?(t.activeTexture(t.TEXTURE2),t.bindTexture(t.TEXTURE_2D,this.toonTextures[r.tuneIndex]),t.uniform1i(e.toonTextureUniform,2),t.uniform1i(e.useToonUniform,1)):t.uniform1i(e.useToonUniform,0),this.view.sphereMapType==this.view._SPHERE_MAP_ON&&r.hasSphereTexture()?(t.activeTexture(t.TEXTURE3),t.bindTexture(t.TEXTURE_2D,this.sphereTextures[o]),t.uniform1i(e.sphereTextureUniform,3),t.uniform1i(e.useSphereMapUniform,1),r.isSphereMapAddition()?t.uniform1i(e.useSphereMapAdditionUniform,1):t.uniform1i(e.useSphereMapAdditionUniform,0)):t.uniform1i(e.useSphereMapUniform,0);var n=this.pmd.materials[o].vertexCount;this._draw(this.textures[o],i,n),i+=n}},o.prototype.drawEdge=function(){var t=(this.layer,this.layer.gl),e=this.layer.shader;t.uniform1i(e.edgeUniform,1),t.uniform1i(e.useToonUniform,0),t.cullFace(t.BACK),t.disable(t.BLEND),t.enable(t.CULL_FACE);for(var i=0,o=0,r=!1,n=0;n<this.pmd.materialCount;n++)o+=this.pmd.materials[n].vertexCount,this.pmd.materials[n].edgeFlag?r=!0:(r&&this._draw(this.textures[0],i,o),i+=o,o=0,r=!1);r&&this._draw(this.textures[0],i,o)},o.prototype.drawShadowMap=function(){var t=(this.layer,this.layer.gl),e=this.layer.shader;this._bindBuffers(),this.view.skinningType==this.view._SKINNING_GPU?(t.activeTexture(t.TEXTURE1),t.bindTexture(t.TEXTURE_2D,this.vtf),t.uniform1i(e.uVTFUniform,1)):t.uniform1i(e.uVTFUniform,0),t.uniform1i(e.edgeUniform,0),t.disable(t.BLEND),t.disable(t.CULL_FACE),t.cullFace(t.FRONT),this._draw(this.textures[0],0,this.pmd.vertexIndexCount)},o.prototype._runPhysics=function(t){1==t?this.physics.simulate(this.motions):this.physics.simulateFrame(this.motions,t)},o.prototype._loadFromVMD=function(t){this.vmd.loadMotion(),this.view.morphType==this.view._MORPH_ON&&this.vmd.loadFace(),this.vmd.step(t),this.frame+=t},o.prototype._moveFace=function(){for(var t=!1,e=0;e<this.pmd.faceCount;e++){var i=this.vmd.getFace(this.pmd.faces[e]);i.available&&(this._moveMorph(this.pmd.faces[e].id,i.weight),t=!0)}if(t){this.layer.pourArrayBuffer(this.vmBuffer,this.vmArray,this._V_ITEM_SIZE,this.pmd.vertexCount);for(var o=this.pmd.faces[0],e=0;e<o.vertexCount;e++){var r=o.vertices[e],n=r.index*this._V_ITEM_SIZE;this.vmArray[n+0]=0,this.vmArray[n+1]=0,this.vmArray[n+2]=0}}},o.prototype._moveBone=function(t){this._loadFromVMD(t);for(var e=0;e<this.pmd.boneCount;e++)this._getBoneMotion(e);this.view.ikType==this.view._IK_ON&&this._resolveIK()},vec3.clear=function(t){t[0]=0,t[1]=0,t[2]=0},quat4.clear=function(t){t[0]=0,t[1]=0,t[2]=0,t[3]=1},o.prototype._getOriginalBoneMotion=function(t){return this.dancing?this.vmd.getBoneMotion(t):this.originalMotions[t.name]},o.prototype._getBoneMotion=function(t){var e=this.motions[t];return e.done||this._resolveFK(e,t),e},o.prototype._resolveFK=function(t,e){var i=this._getOriginalBoneMotion(this.pmd.bones[e]),o=this.pmd.bones[e];if(65535===this.pmd.bones[e].parentIndex)this.vec3.add(o.position,i.location,t.p),this.vec3.add(t.p,this.basePosition,t.p),this.quat4.set(i.rotation,t.r);else{var r=this._getBoneMotion(o.parentIndex),n=this.pmd.bones[o.parentIndex];this.quat4.multiply(r.r,i.rotation,t.r),this.vec3.subtract(o.position,n.position,t.p),this.vec3.add(t.p,i.location,t.p),this.quat4.multiplyVec3(r.r,t.p,t.p),this.vec3.add(t.p,r.p,t.p)}t.done=!0},o.prototype._resolveIK=function(){for(var t=this.vec3.create(),e=this.vec3.create(),i=this.vec3.create(),o=this.quat4.create(),r=this.quat4.create(),n=0;n<this.pmd.ikCount;n++){var s=this.pmd.iks[n],a=(this.pmd.bones[s.index],this.pmd.bones[s.targetBoneIndex]),h=this.pmd.bones[a.parentIndex],u=this._getBoneMotion(s.index),p=this._getBoneMotion(s.targetBoneIndex),l=s.iteration,f=s.chainLength;this.vec3.subtract(a.position,h.position,t);for(var c=.1*this.vec3.length(t),m=0;l>m&&(this.vec3.subtract(p.p,u.p,t),!(c>this.vec3.length(t)));m++)for(var d=0;f>d;d++){var _=s.childBoneIndices[d],v=this.pmd.bones[_],y=this._getBoneMotion(_);p=this._getBoneMotion(s.targetBoneIndex),this.vec3.subtract(p.p,y.p,e),this.vec3.subtract(u.p,y.p,i),this.vec3.cross(e,i,t);var g=this.vec3.length(e),E=this.vec3.length(i),T=this.vec3.length(t),x=T/E/g;if(!isNaN(x)&&!(c>g||c>E||.001>x)){var S=(d+1)*s.limitation*4,A=this.Math.asin(x);this.vec3.dot(e,i)<0&&(A=3.141592653589793-A),A>S&&(A=S),this.vec3.scale(t,this.Math.sin(A/2)/T,t),this.vec3.set(t,o),o[3]=this.Math.cos(A/2);var F=this._getBoneMotion(v.parentIndex).r;if(this.quat4.inverse(F,r),this.quat4.multiply(r,o,r),this.quat4.multiply(r,y.r,r),this.pmd.bones[_].isKnee()){var b=r[3]>1?1:r[3];this.quat4.set([-this.Math.sqrt(1-b*b),0,0,b],r),this.quat4.inverse(y.r,o),this.quat4.multiply(r,o,o),this.quat4.multiply(F,o,o)}this.quat4.normalize(r,this.vmd.getBoneMotion(v).rotation),this.quat4.multiply(o,y.r,y.r),this.motions[s.targetBoneIndex].done=!1;for(var I=0;d>=I;I++)this.motions[s.childBoneIndices[I]].done=!1}}}},o.prototype._moveMorph=function(t,e){if(0!=t)for(var i=this.pmd.faces[t],o=this.pmd.faces[0],r=0;r<i.vertexCount;r++){var n=o.vertices[i.vertices[r].index],s=n.index*this._V_ITEM_SIZE;this.vmArray[s+0]+=i.vertices[r].position[0]*e,this.vmArray[s+1]+=i.vertices[r].position[1]*e,this.vmArray[s+2]+=i.vertices[r].position[2]*e;
}},e.exports=o},{"../Physics/Physics":3}],25:[function(t,e,i){"use strict";function o(t){this.id=t,this.name=null,this.boneIndex=null,this.groupIndex=null,this.groupTarget=null,this.shapeType=null,this.width=null,this.height=null,this.depth=null,this.position=null,this.rotation=null,this.weight=null,this.positionDim=null,this.rotationDim=null,this.recoil=null,this.friction=null,this.type=null}o.prototype.dump=function(){var t="";return t+="id: "+this.id+"\n",t+="name: "+this.name+"\n",t+="boneIndex: "+this.boneIndex+"\n",t+="groupIndex: "+this.groupIndex+"\n",t+="groupTarget: "+this.groupTarget+"\n",t+="shapeType: "+this.shapeType+"\n",t+="width: "+this.width+"\n",t+="height: "+this.height+"\n",t+="depth: "+this.depth+"\n",t+="position: "+this.position+"\n",t+="rotation: "+this.rotation+"\n",t+="weight: "+this.weight+"\n",t+="positionDim: "+this.positionDim+"\n",t+="rotationDim: "+this.rotationDim+"\n",t+="recoil: "+this.recoil+"\n",t+="friction: "+this.friction+"\n",t+="type: "+this.type+"\n"},o.prototype.toRight=function(){this.position[2]=-this.position[2],this.rotation[0]=-this.rotation[0],this.rotation[1]=-this.rotation[1]},e.exports=o},{}],26:[function(t,e,i){"use strict";function o(t){this.id=t,this.fileName=null}o.prototype.dump=function(){var t="";return t+="id: "+this.id+"\n",t+="fileName: "+this.fileName+"\n"},e.exports=o},{}],27:[function(t,e,i){"use strict";function o(t){this.id=t,this.position=null,this.normal=null,this.uv=null,this.boneIndices=null,this.boneWeight=null,this.edgeFlag=null,this.boneWeightFloat1=null,this.boneWeightFloat2=null}o.prototype.setup=function(){this.boneWeightFloat1=this.boneWeight/100,this.boneWeightFloat2=(100-this.boneWeight)/100},o.prototype.dump=function(){var t="";return t+="id: "+this.id+"\n",t+="position: "+this.position+"\n",t+="normal: "+this.normal+"\n",t+="uv: "+this.uv+"\n",t+="boneIndices: "+this.boneIndices+"\n",t+="boneWeight: "+this.boneWeight+"\n",t+="edgeFlag: "+this.edgeFlag+"\n"},o.prototype.toRight=function(){this.position[2]=-this.position[2],this.normal[2]=-this.normal[2]},e.exports=o},{}],28:[function(t,e,i){"use strict";function o(t){this.id=t,this.index=null}o.prototype.dump=function(){var t="";return t+="id: "+this.id+"\n",t+="index: "+this.index+"\n"},e.exports=o},{}],29:[function(t,e,i){"use strict";function o(t){this.layer=t,this.modelViews=[],this.vmd=null,this.audio=null,this.eye=[0,0,0],this.center=[0,0,0],this.up=[0,1,0],this.cameraTranslation=[0,0,0],this.cameraQuaternion=[0,0,0,1],this.cameraDistance=0,this.frame=0,this.dframe=1,this.camera={},this.camera.location=[0,0,0],this.camera.rotation=[0,0,0],this.length=0,this.angle=0,this.oldDate=null,this.startDate=null,this.audioStart=!1,this.dancing=!1,this.elapsedTime=0,this.skinningType=null,this.lightingType=null,this.ikType=null,this.edgeType=null,this.morphType=null,this.sphereMapType=null,this.shadowMappingType=null,this.lightColor=[0,0,0],this.runType=null,this.stageType=null,this.effectFlag=null,this.audioType=null,this.physicsType=null,this.setLightingType(this._LIGHTING_ON),this.setSkinningType(this._SKINNING_CPU_AND_GPU),this.setIKType(this._IK_ON),this.setMorphType(this._MORPH_ON),this.setSphereMapType(this._SPHERE_MAP_ON),this.setShadowMappingType(this._SHADOW_MAPPING_OFF),this.setEdgeType(this._EDGE_ON),this.setRunType(this._RUN_REALTIME_ORIENTED),this.setStageType(this._STAGE_2),this.setEffectFlag(this._EFFECT_OFF),this.setAudioType(this._AUDIO_ON),this.setPhysicsType(this._PHYSICS_ON),this.setLightColor(1)}o.prototype.Math=Math,o.prototype.vec3=vec3,o.prototype.quat4=quat4,o.prototype.mat4=mat4,o.prototype._FRAME_S=1/60,o.prototype._FRAME_MS=1/60*1e3,o.prototype._PHYSICS_OFF=0,o.prototype._PHYSICS_ON=1,o.prototype._PHYSICS_WORKERS_ON=2,o.prototype._SKINNING_CPU=0,o.prototype._SKINNING_GPU=1,o.prototype._SKINNING_CPU_AND_GPU=2,o.prototype._LIGHTING_OFF=0,o.prototype._LIGHTING_ON=1,o.prototype._LIGHTING_ON_WITH_TOON=2,o.prototype._IK_OFF=0,o.prototype._IK_ON=1,o.prototype._MORPH_OFF=0,o.prototype._MORPH_ON=1,o.prototype._SPHERE_MAP_OFF=0,o.prototype._SPHERE_MAP_ON=1,o.prototype._SHADOW_MAPPING_OFF=0,o.prototype._SHADOW_MAPPING_ON=1,o.prototype._SHADOW_MAPPING_ONLY=2,o.prototype._RUN_FRAME_ORIENTED=0,o.prototype._RUN_REALTIME_ORIENTED=1,o.prototype._RUN_AUDIO_ORIENTED=2,o.prototype._AUDIO_OFF=0,o.prototype._AUDIO_ON=1,o.prototype._EDGE_OFF=0,o.prototype._EDGE_ON=1,o.prototype._STAGE_OFF=0,o.prototype._STAGE_1=1,o.prototype._STAGE_2=2,o.prototype._STAGE_3=3,o.prototype._EFFECT_OFF=0,o.prototype._EFFECT_BLUR=1,o.prototype._EFFECT_GAUSSIAN=2,o.prototype._EFFECT_DIFFUSION=4,o.prototype._EFFECT_DIVISION=8,o.prototype._EFFECT_LOW_RESO=16,o.prototype._EFFECT_FACE_MOSAIC=32,o._PHYSICS_OFF=o.prototype._PHYSICS_OFF,o._PHYSICS_ON=o.prototype._PHYSICS_ON,o._PHYSICS_WORKERS_ON=o.prototype._PHYSICS_WORKERS_ON,o._SKINNING_CPU=o.prototype._SKINNING_CPU,o._SKINNING_GPU=o.prototype._SKINNING_GPU,o._SKINNING_CPU_AND_GPU=o.prototype._SKINNING_CPU_AND_GPU,o._LIGHTING_OFF=o.prototype._LIGHTING_OFF,o._LIGHTING_ON=o.prototype._LIGHTING_ON,o._LIGHTING_ON_WITH_TOON=o.prototype._LIGHTING_ON_WITH_TOON,o._IK_OFF=o.prototype._IK_OFF,o._IK_ON=o.prototype._IK_ON,o._MORPH_OFF=o.prototype._MORPH_OFF,o._MORPH_ON=o.prototype._MORPH_ON,o._SPHERE_MAP_OFF=o.prototype._SPHERE_MAP_OFF,o._SPHERE_MAP_ON=o.prototype._SPHERE_MAP_ON,o._SHADOW_MAPPING_OFF=o.prototype._SHADOW_MAPPING_OFF,o._SHADOW_MAPPING_ON=o.prototype._SHADOW_MAPPING_ON,o._SHADOW_MAPPING_ONLY=o.prototype._SHADOW_MAPPING_ONLY,o._RUN_FRAME_ORIENTED=o.prototype._RUN_FRAME_ORIENTED,o._RUN_REALTIME_ORIENTED=o.prototype._RUN_REALTIME_ORIENTED,o._RUN_AUDIO_ORIENTED=o.prototype._RUN_AUDIO_ORIENTED,o._AUDIO_OFF=o.prototype._AUDIO_OFF=0,o._AUDIO_ON=o.prototype._AUDIO_ON=1,o._EDGE_OFF=o.prototype._EDGE_OFF,o._EDGE_ON=o.prototype._EDGE_ON,o._STAGE_OFF=o.prototype._STAGE_OFF,o._STAGE_1=o.prototype._STAGE_1,o._STAGE_2=o.prototype._STAGE_2,o._STAGE_3=o.prototype._STAGE_3,o._EFFECT_OFF=o.prototype._EFFECT_OFF,o._EFFECT_BLUR=o.prototype._EFFECT_BLUR,o._EFFECT_GAUSSIAN=o.prototype._EFFECT_GAUSSIAN,o._EFFECT_DIFFUSION=o.prototype._EFFECT_DIFFUSION,o._EFFECT_DIVISION=o.prototype._EFFECT_DIVISION,o._EFFECT_LOW_RESO=o.prototype._EFFECT_LOW_RESO,o._EFFECT_FACE_MOSAIC=o.prototype._EFFECT_FACE_MOSAIC,o.prototype.addModelView=function(t){this.modelViews.push(t)},o.prototype.getModelView=function(t){return this.modelViews[t]},o.prototype.getModelNum=function(){return this.modelViews.length},o.prototype.setup=function(){for(var t=0;t<this.modelViews.length;t++)this.modelViews[t].setup();this.elapsedTime=0},o.prototype.setVMD=function(t){this.vmd=t,this.vmd.supply()},o.prototype.setAudio=function(t,e){this.audio={},this.audio.audio=t,this.audio.offset=e},o.prototype.startDance=function(){this.vmd.setup(this.modelViews[0].pmd),this.elapsedTime=0,this.dancing=!0,this.oldDate=null,this.startDate=Date.now(),this.frame=0,this.dframe=0;for(var t=0;t<this.modelViews.length;t++)this.modelViews[t].setVMD(this.vmd.clone()),this.modelViews[t].startDance()},o.prototype.setEye=function(t){for(var e=0;e<this.eye.length;e++)this.eye[e]=t[e];this.center[0]=t[0],this.center[1]=t[1],this.resetCameraMove()},o.prototype.setPhysicsType=function(t){this.physicsType=t},o.prototype.setSkinningType=function(t){this.skinningType=t},o.prototype.setLightingType=function(t){this.lightingType=t},o.prototype.setLightColor=function(t){this.lightColor[0]=t,this.lightColor[1]=t,this.lightColor[2]=t},o.prototype.setIKType=function(t){this.ikType=t},o.prototype.setMorphType=function(t){this.morphType=t},o.prototype.setSphereMapType=function(t){this.sphereMapType=t},o.prototype.setShadowMappingType=function(t){this.shadowMappingType=t},o.prototype.setRunType=function(t){this.runType=t},o.prototype.setStageType=function(t){this.stageType=t},o.prototype.setEffectFlag=function(t){this.effectFlag=t},o.prototype.setAudioType=function(t){this.audioType=t},o.prototype.setEdgeType=function(t){this.edgeType=t},o.prototype.moveCameraQuaternion=function(t){this.quat4.multiply(this.cameraQuaternion,t,this.cameraQuaternion)},o.prototype.moveCameraQuaternionByXY=function(t,e){t=-t,e=-e;var i=this.Math.sqrt(t*t+e*e);if(0!=i){var o=i*this.Math.PI,r=this.Math.sin(o)/i,n=this.quat4.create([e*r,t*r,0,this.Math.cos(o)]);return this.moveCameraQuaternion(n),!0}return!1},o.prototype.moveCameraTranslation=function(t,e){e=-e,this.cameraTranslation[0]+=50*t,this.cameraTranslation[1]+=50*e},o.prototype.resetCameraMove=function(){this.cameraDistance=0,this.cameraTranslation[0]=0,this.cameraTranslation[1]=0,this.cameraTranslation[2]=0,this.cameraQuaternion[0]=0,this.cameraQuaternion[1]=0,this.cameraQuaternion[2]=0,this.cameraQuaternion[3]=1},o.prototype.moveCameraForward=function(t){t>0&&(this.cameraDistance-=25),0>t&&(this.cameraDistance+=25),this.cameraDistance<=-100&&(this.cameraDistance=-99)},o.prototype._getCalculatedCameraParams=function(t,e,i){this.vec3.set(this.eye,t),this.vec3.set(this.center,e),this.vec3.set(this.up,i),this.quat4.multiplyVec3(this.cameraQuaternion,t,t),this.quat4.multiplyVec3(this.cameraQuaternion,i,i);var o=[0,0,0];this.vec3.set(this.cameraTranslation,o),this.quat4.multiplyVec3(this.cameraQuaternion,o,o),this.vec3.add(t,o,t),this.vec3.add(e,o,e);var r=[0,0,0];this.vec3.subtract(t,e,r),t[0]+=r[0]*this.cameraDistance*.01,t[1]+=r[1]*this.cameraDistance*.01,t[2]+=r[2]*this.cameraDistance*.01},o.prototype._calculateDframe=function(){var t=Date.now();if(this.runType==this._RUN_FRAME_ORIENTED)this.dframe=1,this.elapsedTime+=this._FRAME_MS;else if(this.runType!=this._RUN_REALTIME_ORIENTED&&this.dancing&&null!==this.audio)if(this.audioStart&&(t=1e3*this.audio.audio.currentTime+this.startDate+this.audio.offset*this._FRAME_MS),this.oldDate){var e=this.elapsedTime,i=this.elapsedTime/this._FRAME_MS|0;this.elapsedTime+=t-this.oldDate;var o=this.elapsedTime/this._FRAME_MS|0,r=o-i;0>=r&&(t=this.oldDate,r=0,this.elapsedTime=e),this.dframe=r}else this.dframe=0;else if(this.oldDate){var e=this.elapsedTime,i=this.elapsedTime/this._FRAME_MS|0;this.elapsedTime+=t-this.oldDate;var o=this.elapsedTime/this._FRAME_MS|0,r=o-i;0>=r&&(t=this.oldDate,r=0,this.elapsedTime=e),this.dframe=r}else this.dframe=0;this.oldDate=t},o.prototype._controlAudio=function(){this.audio&&!this.audioStart&&this.audioType!=this._AUDIO_OFF&&(!this.audio.offset||this.frame>=this.audio.offset)&&(this.audio.audio.play(),this.audio.offset<0&&(this.audio.audio.currentTime=-this.audio.offset*this._FRAME_S),this.audioStart=!0)},o.prototype.update=function(){if(this._controlAudio(),this._calculateDframe(),0!=this.dframe){this.dancing&&this._loadFromVMD(this.dframe);for(var t=0;t<this.modelViews.length;t++)this.modelViews[t].update(this.dframe)}},o.prototype.draw=function(){if(0!=this.dframe){var t=this.layer,e=t.gl,i=t.shader,o=this.effectFlag&this._EFFECT_BLUR?t.postEffects.blur:this.effectFlag&this._EFFECT_GAUSSIAN?t.postEffects.gaussian:this.effectFlag&this._EFFECT_DIFFUSION?t.postEffects.diffusion:this.effectFlag&this._EFFECT_DIVISION?t.postEffects.division:this.effectFlag&this._EFFECT_LOW_RESO?t.postEffects.low_reso:this.effectFlag&this._EFFECT_FACE_MOSAIC?t.postEffects.face_mosaic:null;if(this.shadowMappingType!=this._SHADOW_MAPPING_OFF){this.shadowMappingType==this._SHADOW_MAPPING_ONLY?(e.bindFramebuffer(e.FRAMEBUFFER,null),t.viewport(),t.perspective(t.viewAngle)):(e.bindFramebuffer(e.FRAMEBUFFER,t.shadowFrameBuffer.f),e.viewport(0,0,t.shadowFrameBufferSize,t.shadowFrameBufferSize),this.mat4.perspective(t.viewAngle,1,t.viewNear,t.viewFar,t.pMatrix)),t.identity(),t.lookAt(t.lightPosition,t.lightCenter,t.lightUpDirection),t.registerLightMatrix(),e.uniform1i(i.shadowGenerationUniform,1),e.uniform1i(i.shadowTextureUniform,0),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT);for(var r=0;r<this.modelViews.length;r++)this.modelViews[r].drawShadowMap();if(e.flush(),e.bindFramebuffer(e.FRAMEBUFFER,null),e.uniform1i(i.shadowMappingUniform,1),e.activeTexture(e.TEXTURE4),e.bindTexture(e.TEXTURE_2D,this.layer.shadowFrameBuffer.t),e.uniform1i(i.shadowTextureUniform,4),e.uniformMatrix4fv(i.lightMatrixUniform,!1,t.lightMatrix),this.shadowMappingType==this._SHADOW_MAPPING_ONLY)return}else e.uniform1i(i.shadowMappingUniform,0);this._setCamera(),this._setDrawParameters(),e.uniform1i(i.shadowGenerationUniform,0);var n=null===o?null:o.shader;this.effectFlag!=this._EFFECT_OFF?o.bindFrameBufferForScene():e.bindFramebuffer(e.FRAMEBUFFER,null),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT);for(var r=0;r<this.modelViews.length;r++)this.modelViews[r].draw(),this.edgeType==this._EDGE_ON&&this.modelViews[r].drawEdge();this.stageType!=this._STAGE_OFF&&(this._drawStage(),this.effectFlag==this._EFFECT_OFF&&e.useProgram(i)),e.flush(),this.effectFlag!=this._EFFECT_OFF&&(e.useProgram(n),n.frame=this.frame,o.draw(this),e.useProgram(i))}},o.prototype._setCamera=function(){var t=this.layer;t.gl,t.shader;t.viewport();var e=60;this.dancing&&this.vmd.getCamera().available&&(e=this.vmd.getCamera().angle,this.vmd.getCalculatedCameraParams(this.eye,this.center,this.up)),t.perspective(e),t.identity();var i=[0,0,0],o=[0,0,0],r=[0,0,0];this._getCalculatedCameraParams(i,o,r),t.lookAt(i,o,r)},o.prototype._setDrawParameters=function(){var t=this.layer,e=t.gl,i=t.shader;e.uniform1i(i.uSkinningTypeUniform,this.skinningType),e.uniform1i(i.uLightingTypeUniform,this.lightingType),e.uniform3fv(i.lightColorUniform,this.lightColor),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT)},o.prototype._drawStage=function(){for(var t=this.layer,e=(this.layer.gl,this.layer.stageShaders[this.stageType-1]),i=(e.shader,[]),o=[],r=[],n=0;n<this.modelViews.length;n++){var s=this.modelViews[n];i.push(s.skinningOneBone(s.pmd.centerBone)),o.push(s.skinningOneBone(s.pmd.leftFootBone)),r.push(s.skinningOneBone(s.pmd.rightFootBone))}i=[].concat.apply([],i),o=[].concat.apply([],o),r=[].concat.apply([],r);var a=!1;this.shadowMappingType==this._SHADOW_MAPPING_ON&&(a=!0),e.draw(this.frame,this.modelViews.length,i,o,r,a,t.lightMatrix)},o.prototype._loadFromVMD=function(t){this.vmd.loadCamera(),this.vmd.loadLight(),this.vmd.step(t),this.frame+=t},o.prototype._moveLight=function(){var t=this.vmd.getLight();t.available&&(this.layer.gl.uniform3fv(this.layer.shader.lightColorUniform,t.color),this.layer.lightPosition=t.location)},e.exports=o},{}],30:[function(t,e,i){"use strict";function o(t,e,i){var o="",r="";8===t?r="0":16===t&&(r="0x");for(var n=0;i>n;n++)o+="0";return r+(o+e.toString(t)).substr(-1*i)}e.exports=o},{}],31:[function(t,e,i){"use strict";function o(){this.header=null,this.motionCount=null,this.faceCount=null,this.cameraCount=null,this.lightCount=null,this.motions=[],this.faces=[],this.cameras=[],this.lights=[],this.frame=0,this.orderedMotions=[],this.orderedFaces=[],this.orderedCameras=[],this.orderedLights=[],this.cameraIndex=-1,this.lightIndex=-1,this.stepMotions=[],this.stepFaces=[],this.stepCamera={location:[0,0,0],rotation:[0,0,0],length:0,angle:0,available:!0},this.stepLight={color:[0,0,0],location:[0,0,0],available:!0}}o.prototype.Object=Object,o.prototype.Math=Math,o.prototype.vec3=vec3,o.prototype.quat4=quat4,o.prototype.valid=function(){return this.header.valid()},o.prototype.supply=function(){for(var t=0;t<this.motionCount;t++)this.motions[t].supply();for(var t=0;t<this.faceCount;t++)this.faces[t].supply();for(var t=0;t<this.cameraCount;t++)this.cameras[t].supply();for(var t=0;t<this.lightCount;t++)this.lights[t].supply()},o.prototype.clone=function(){var t=new o;t.motionCount=this.motionCount,t.faceCount=this.faceCount,t.cameraCount=this.cameraCount,t.lightCount=this.lightCount;for(var e=0;e<this.motionCount;e++)t.motions[e]=this.motions[e];for(var e=0;e<this.faceCount;e++)t.faces[e]=this.faces[e];for(var e=0;e<this.cameraCount;e++)t.cameras[e]=this.cameras[e];for(var e=0;e<this.lightCount;e++)t.lights[e]=this.lights[e];return t},o.prototype.setup=function(t){this.frame=0,this.cameraIndex=-1,this.lightIndex=-1,t&&(this._setupMotions(t),this._setupFaces(t)),this._setupCameras(),this._setupLights(),this.step(1)},o.prototype._setupMotions=function(t){for(var e={},i=0;i<this.motionCount;i++){var o=this.motions[i];void 0!==t.bonesHash[o.boneName]&&(void 0===e[o.boneName]&&(e[o.boneName]={},e[o.boneName].motions=[],e[o.boneName].index=-1),e[o.boneName].motions.push(o))}for(var r in e)e[r].motions.sort(function(t,e){return t.frameNum-e.frameNum});this.orderedMotions.length=0;for(var n=this.Object.keys(e),i=0;i<n.length;i++)this.orderedMotions[i]=e[n[i]];this.stepMotions.length=0;for(var i=0;i<t.boneCount;i++){var s={};s.location=[0,0,0],s.rotation=[0,0,0,1],this._clearVec3(s.location),this._clearQuat4(s.rotation),this.stepMotions[i]=s}for(var a=(t.getBoneNames(),0),i=0;i<t.bones.length;i++){var h=t.bones[i];h.motionIndex=n.indexOf(h.name),-1==h.motionIndex&&(h.motionIndex=n.length+a,a++)}},o.prototype._setupFaces=function(t){for(var e={},i=0;i<this.faceCount;i++){var o=this.faces[i];void 0!==t.facesHash[o.name]&&(void 0===e[o.name]&&(e[o.name]={},e[o.name].faces=[],e[o.name].index=-1),e[o.name].faces.push(o))}for(var r in e)e[r].faces.sort(function(t,e){return t.frameNum-e.frameNum});this.orderedFaces.length=0;for(var n=this.Object.keys(e),i=0;i<n.length;i++)this.orderedFaces[i]=e[n[i]];this.stepFaces.length=0;for(var i=0;i<t.faceCount;i++){var s={};s.weight=0,s.available=!0,this.stepFaces[i]=s}for(var a=(t.getFaceNames(),0),i=0;i<t.faces.length;i++){var h=t.faces[i];h.motionIndex=n.indexOf(h.name),-1==h.motionIndex&&(h.motionIndex=n.length+a,this.stepFaces[h.motionIndex].available=!1,a++)}},o.prototype._setupCameras=function(){this.orderedCameras.length=0;for(var t=0;t<this.cameraCount;t++)this.orderedCameras[t]=this.cameras[t];this.orderedCameras.sort(function(t,e){return t.frameNum-e.frameNum})},o.prototype._setupLights=function(){this.orderedLights.length=0;for(var t=0;t<this.lightCount;t++)this.orderedLights[t]={},this.orderedLights[t].light=this.lights[t];this.orderedLights.sort(function(t,e){return t.light.frameNum-e.light.frameNum})},o.prototype.step=function(t){this._stepMotion(),this._stepFace(),this._stepCamera(),this._stepLight(),this.frame+=t},o.prototype._stepMotion=function(){for(var t=0;t<this.orderedMotions.length;t++)for(var e=this.orderedMotions[t];e.index+1<e.motions.length&&e.motions[e.index+1].frameNum<=this.frame;)e.index++},o.prototype._stepFace=function(){for(var t=0;t<this.orderedFaces.length;t++)for(var e=this.orderedFaces[t];e.index+1<e.faces.length&&e.faces[e.index+1].frameNum<=this.frame;)e.index++},o.prototype._stepCamera=function(){for(;this.cameraIndex+1<this.cameras.length&&this.orderedCameras[this.cameraIndex+1].frameNum<=this.frame;)this.cameraIndex++},o.prototype._stepLight=function(){for(;this.lightIndex+1<this.lights.length&&this.orderedLights[this.lightIndex+1].light.frameNum<=this.frame;)this.lightIndex++},o.prototype.merge=function(t){this.motionCount+=t.motionCount,this.faceCount+=t.faceCount,this.cameraCount+=t.cameraCount,this.lightCount+=t.lightCount;for(var e=0;e<t.motionCount;e++)this.motions.push(t.motions[e]);for(var e=0;e<t.faceCount;e++)this.faces.push(t.faces[e]);for(var e=0;e<t.cameraCount;e++)this.cameras.push(t.cameras[e]);for(var e=0;e<t.lightCount;e++)this.lights.push(t.lights[e])},o.prototype.addOffset=function(t){for(var e=0;e<this.motionCount;e++)this.motions[e].frameNum+=t;for(var e=0;e<this.faceCount;e++)this.faces[e].frameNum+=t;for(var e=0;e<this.cameraCount;e++)this.cameras[e].frameNum+=t;for(var e=0;e<this.lightCount;e++)this.lights[e].frameNum+=t},o.prototype.loadMotion=function(){for(var t=0;t<this.orderedMotions.length;t++){var e=this.orderedMotions[t];if(-1!=e.index){var i=e.motions[e.index],o=e.motions[e.index+1],r=this.stepMotions[t];if(i.frameNum==this.frame||void 0===o||o.frameNum-i.frameNum<=2)this._setVec3(i.location,r.location),this._setQuat4(i.rotation,r.rotation);else{var n=o.frameNum-i.frameNum,s=this.frame-i.frameNum,a=s/n;this._slerpQuat4(i.rotation,o.rotation,a,r.rotation),this._lerpVec3(i.location,o.location,a,r.location)}}}for(var t=this.orderedMotions.length;t<this.stepMotions.length;t++){var h=this.stepMotions[t];this._clearVec3(h.location),this._clearQuat4(h.rotation)}},o.prototype.loadFace=function(){for(var t=0;t<this.orderedFaces.length;t++){var e=this.orderedFaces[t];if(-1!=e.index){var i=e.faces[e.index],o=e.faces[e.index+1],r=this.stepFaces[t];if(i.frameNum==this.frameNum||void 0===o||o.frameNum-i.frameNum<=2)r.weight=i.weight;else{var n=o.frameNum-i.frameNum,s=this.frame-i.frameNum,a=s/n;r.weight=this._lerp(i.weight,o.weight,a)}}}},o.prototype.loadCamera=function(){var t=this.orderedCameras,e=this.cameraIndex;if(this.stepCamera.available=!1,-1!=e){this.stepCamera.available=!0;var i=t[e],o=t[e+1];if(i.frameNum==this.frame||void 0===o||o.frameNum-i.frameNum<=2)this._setVec3(i.location,this.stepCamera.location),this._setVec3(i.rotation,this.stepCamera.rotation),this.stepCamera.length=i.length,this.stepCamera.angle=i.angle;else{var r=o.frameNum-i.frameNum,n=this.frame-i.frameNum,s=n/r;this._lerpVec3(i.location,o.location,s,this.stepCamera.location),this._lerpVec3(i.rotation,o.rotation,s,this.stepCamera.rotation),this.stepCamera.length=this._lerp(i.length,o.length,s),this.stepCamera.angle=this._lerp(i.angle,o.angle,s)}}},o.prototype.loadLight=function(){var t=this.orderedLights,e=this.lightIndex;if(this.stepLight.available=!1,-1!=e){var i=t[e].light;this.stepLight.available=!0,this._setVec3(i.color,this.stepLight.color),this._setVec3(i.location,this.stepLight.location)}},o.prototype._setVec3=function(t,e){e[0]=t[0],e[1]=t[1],e[2]=t[2]},o.prototype._setQuat4=function(t,e){e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3]},o.prototype._clearVec3=function(t){t[0]=0,t[1]=0,t[2]=0},o.prototype._clearQuat4=function(t){t[0]=0,t[1]=0,t[2]=0,t[3]=1},o.prototype._lerp=function(t,e,i){return t*(1-i)+e*i},o.prototype._lerpVec3=function(t,e,i,o){o[0]=this._lerp(t[0],e[0],i),o[1]=this._lerp(t[1],e[1],i),o[2]=this._lerp(t[2],e[2],i)},o.prototype._slerpQuat4=function(t,e,i,o){var r=t[0]*e[0]+t[1]*e[1]+t[2]*e[2]+t[3]*e[3];if(0>r?(o[0]=-e[0],o[1]=-e[1],o[2]=-e[2],o[3]=-e[3],r=-r):(o[0]=e[0],o[1]=e[1],o[2]=e[2],o[3]=e[3]),this.Math.abs(r)>=1)return o[0]=t[0],o[1]=t[1],o[2]=t[2],o[3]=t[3],o;var n=this.Math.acos(r),s=this.Math.sqrt(1-r*r);if(this.Math.abs(s)<.001)return o[0]=.5*(t[0]+e[0]),o[1]=.5*(t[1]+e[1]),o[2]=.5*(t[2]+e[2]),o[3]=.5*(t[3]+e[3]),o;var a=this.Math.sin((1-i)*n)/s,h=this.Math.sin(i*n)/s;return o[0]=t[0]*a+o[0]*h,o[1]=t[1]*a+o[1]*h,o[2]=t[2]*a+o[2]*h,o[3]=t[3]*a+o[3]*h,o},vec3.rotateX=function(t,e,i){var o=mat4.rotateX(mat4.identity(mat4.create()),e);return mat4.multiplyVec3(o,t,i)},vec3.rotateY=function(t,e,i){var o=mat4.rotateY(mat4.identity(mat4.create()),e);return mat4.multiplyVec3(o,t,i)},vec3.rotateZ=function(t,e,i){var o=mat4.rotateZ(mat4.identity(mat4.create()),e);return mat4.multiplyVec3(o,t,i)},o.prototype.getBoneMotion=function(t){return this.stepMotions[t.motionIndex]},o.prototype.getFace=function(t){return this.stepFaces[t.motionIndex]},o.prototype.getCamera=function(){return this.stepCamera},o.prototype.getLight=function(){return this.stepLight},o.prototype.getCalculatedCameraParams=function(t,e,i){var o=0,r=this.getCamera();e[0]=r.location[0],e[1]=r.location[1]+o,e[2]=r.location[2],t[0]=0,t[1]=0+o,t[2]=r.length,i[0]=0,i[1]=1,i[2]=0,this.vec3.rotateX(t,r.rotation[0],t),this.vec3.rotateY(t,r.rotation[1],t),this.vec3.rotateZ(t,r.rotation[2],t),this.vec3.add(t,r.location,t),this.vec3.rotateX(i,r.rotation[0],i),this.vec3.rotateY(i,r.rotation[1],i),this.vec3.rotateZ(i,r.rotation[2],i)},o.prototype.dump=function(){var t="";return t+="motionCount: "+this.motionCount+"\n",t+="faceCount: "+this.faceCount+"\n",t+="cameraCount: "+this.cameraCount+"\n",t+="lightCount: "+this.lightCount+"\n",t+=this._dumpMotions(),t+=this._dumpFaces(),t+=this._dumpCameras(),t+=this._dumpLights()},o.prototype._dumpMotions=function(){var t="";t+="-- Motions --\n";for(var e=0;e<this.motionCount;e++)t+=this.motions[e].dump();return t+="\n"},o.prototype._dumpFaces=function(){var t="";t+="-- Faces --\n";for(var e=0;e<this.faceCount;e++)t+=this.faces[e].dump();return t+="\n"},o.prototype._dumpCameras=function(){var t="";t+="-- Cameras --\n";for(var e=0;e<this.cameraCount;e++)t+=this.cameras[e].dump();return t+="\n"},o.prototype._dumpLights=function(){var t="";t+="-- Lights --\n";for(var e=0;e<this.lightCount;e++)t+=this.lights[e].dump();return t+="\n"},e.exports=o},{}],32:[function(t,e,i){"use strict";function o(t){this.id=t,this.frameNum=null,this.length=null,this.location=null,this.rotation=null,this.interpolation=null,this.angle=null,this.perspective=null}o.prototype.supply=function(){this.frameNum*=2},o.prototype.dump=function(){var t="";return t+="id: "+this.id+"\n",t+="frameNum: "+this.frameNum+"\n",t+="length: "+this.length+"\n",t+="location: "+this.location+"\n",t+="rotation: "+this.rotation+"\n",t+="interpolation: "+this.interpolation+"\n",t+="angle: "+this.angle+"\n",t+="perspective: "+this.perspective+"\n"},e.exports=o},{}],33:[function(t,e,i){"use strict";function o(t){this.id=t,this.name=null,this.frameNum=null,this.weight=null}o.prototype.supply=function(){this.frameNum*=2},o.prototype.dump=function(){var t="";return t+="id: "+this.id+"\n",t+="name: "+this.name+"\n",t+="frameNum: "+this.frameNum+"\n",t+="weight: "+this.weight+"\n"},e.exports=o},{}],34:[function(t,e,i){"use strict";function o(t){this.parent=r,this.parent.call(this,t)}var r=t("../FileParser"),n=t("../Inherit").__inherit,s=t("./Vmd"),a=t("./VmdHeader"),h=t("./VmdMotion"),u=t("./VmdFace"),p=t("./VmdCamera"),l=t("./VmdLight");n(o,r),o.prototype._HEADER_STRUCTURE={magic:{type:"char",isArray:!0,size:30},modelName:{type:"char",isArray:!0,size:20}},o.prototype._MOTIONS_STRUCTURE={count:{type:"uint32"},motions:{type:"object",isArray:!0,size:"count"}},o.prototype._MOTION_STRUCTURE={boneName:{type:"strings",isArray:!0,size:15},frameNum:{type:"uint32"},location:{type:"float",isArray:!0,size:3},rotation:{type:"float",isArray:!0,size:4},interpolation:{type:"uint8",isArray:!0,size:64}},o.prototype._FACES_STRUCTURE={count:{type:"uint32"},faces:{type:"object",isArray:!0,size:"count"}},o.prototype._FACE_STRUCTURE={name:{type:"strings",isArray:!0,size:15},frameNum:{type:"uint32"},weight:{type:"float"}},o.prototype._CAMERAS_STRUCTURE={count:{type:"uint32"},cameras:{type:"object",isArray:!0,size:"count"}},o.prototype._CAMERA_STRUCTURE={frameNum:{type:"uint32"},length:{type:"float"},location:{type:"float",isArray:!0,size:3},rotation:{type:"float",isArray:!0,size:3},interpolation:{type:"uint8",isArray:!0,size:24},angle:{type:"uint32"},perspective:{type:"uint8"}},o.prototype._LIGHTS_STRUCTURE={count:{type:"uint32"},lights:{type:"object",isArray:!0,size:"count"}},o.prototype._LIGHT_STRUCTURE={frameNum:{type:"uint32"},color:{type:"float",isArray:!0,size:3},location:{type:"float",isArray:!0,size:3}},o.prototype.parse=function(){this.offset=0;var t=new s;return this._parseHeader(t),this._parseMotions(t),this._parseFaces(t),this._parseCameras(t),this._parseLights(t),t},o.prototype.valid=function(){var t=this.offset;this.offset=0;var e=new s;return this._parseHeader(e),this.offset=t,e.valid()},o.prototype._parseHeader=function(t){var e=this._HEADER_STRUCTURE;t.header=new a,this._parseObject(t.header,e)},o.prototype._parseMotions=function(t){var e=this._MOTIONS_STRUCTURE;t.motionCount=this._getValue(e.count,this.offset),this.offset+=this._sizeof(e.count),t.motions.length=0;for(var i=0;i<t.motionCount;i++)this._parseMotion(t,i)},o.prototype._parseMotion=function(t,e){var i=this._MOTION_STRUCTURE,o=new h(e);this._parseObject(o,i),t.motions[e]=o},o.prototype._parseFaces=function(t){var e=this._FACES_STRUCTURE;t.faceCount=this._getValue(e.count,this.offset),this.offset+=this._sizeof(e.count),t.faces.length=0;for(var i=0;i<t.faceCount;i++)this._parseFace(t,i)},o.prototype._parseFace=function(t,e){var i=this._FACE_STRUCTURE,o=new u(e);this._parseObject(o,i),t.faces[e]=o},o.prototype._parseCameras=function(t){var e=this._CAMERAS_STRUCTURE;t.cameraCount=this._getValue(e.count,this.offset),this.offset+=this._sizeof(e.count),t.cameras.length=0;for(var i=0;i<t.cameraCount;i++)this._parseCamera(t,i)},o.prototype._parseCamera=function(t,e){var i=this._CAMERA_STRUCTURE,o=new p(e);this._parseObject(o,i),t.cameras[e]=o},o.prototype._parseLights=function(t){var e=this._LIGHTS_STRUCTURE;t.lightCount=this._getValue(e.count,this.offset),this.offset+=this._sizeof(e.count),t.lights.length=0;for(var i=0;i<t.lightCount;i++)this._parseLight(t,i)},o.prototype._parseLight=function(t,e){var i=this._LIGHT_STRUCTURE,o=new l(e);this._parseObject(o,i),t.lights[e]=o},e.exports=o},{"../FileParser":1,"../Inherit":2,"./Vmd":31,"./VmdCamera":32,"./VmdFace":33,"./VmdHeader":35,"./VmdLight":36,"./VmdMotion":37}],35:[function(t,e,i){"use strict";function o(){this.magic=null,this.modelName=null}o.prototype.valid=function(){return"Vocaloid Motion Data 0002"==this.magic},o.prototype.dump=function(){var t="";return t+="magic: "+this.magic+"\n",t+="modelName: "+this.modelName+"\n"},e.exports=o},{}],36:[function(t,e,i){"use strict";function o(t){this.id=t,this.frameNum=null,this.color=null,this.location=null}o.prototype.supply=function(){this.frameNum*=2},o.prototype.dump=function(){var t="";return t+="id: "+this.id+"\n",t+="frameNum: "+this.frameNum+"\n",t+="color: "+this.color+"\n",t+="location: "+this.location+"\n"},e.exports=o},{}],37:[function(t,e,i){"use strict";function o(t){this.id=t,this.boneName=null,this.frameNum=null,this.location=null,this.rotation=null,this.interpolation=null}o.prototype.supply=function(){this.frameNum*=2},o.prototype.dump=function(){var t="";return t+="id: "+this.id+"\n",t+="boneName: "+this.boneName+"\n",t+="frameNum: "+this.frameNum+"\n",t+="location: "+this.location+"\n",t+="rotation: "+this.rotation+"\n",t+="interpolation: "+this.interpolation+"\n"},e.exports=o},{}],38:[function(t,e,i){"use strict";function o(t){this.parent=r,this.parent.call(this,t,1)}var r=t("./PostEffect"),n=t("../Inherit").__inherit;n(o,r),o.prototype._FSHADER={},o.prototype._FSHADER.type="x-shader/x-fragment",o.prototype._FSHADER.src="  precision mediump float;  uniform float uWidth;  uniform float uHeight;  uniform sampler2D uSampler;  uniform sampler2D uSampler2;  void main() {    vec2 st = vec2(1.0 / uWidth, 1.0 / uHeight);    vec4 color = texture2D(uSampler, gl_FragCoord.st * st);    color *= 0.72;    color += texture2D(uSampler, (gl_FragCoord.st + vec2(-1.0,  1.0)) * st)                        * 0.02;    color += texture2D(uSampler, (gl_FragCoord.st + vec2( 0.0,  1.0)) * st)                        * 0.02;    color += texture2D(uSampler, (gl_FragCoord.st + vec2( 1.0,  1.0)) * st)                        * 0.02;    color += texture2D(uSampler, (gl_FragCoord.st + vec2(-1.0,  0.0)) * st)                        * 0.02;    color += texture2D(uSampler, (gl_FragCoord.st + vec2( 1.0,  0.0)) * st)                        * 0.02;    color += texture2D(uSampler, (gl_FragCoord.st + vec2(-1.0, -1.0)) * st)                        * 0.02;    color += texture2D(uSampler, (gl_FragCoord.st + vec2( 0.0, -1.0)) * st)                        * 0.02;    color += texture2D(uSampler, (gl_FragCoord.st + vec2( 1.0, -1.0)) * st)                        * 0.02;    color += texture2D(uSampler, (gl_FragCoord.st + vec2(-2.0,  2.0)) * st)                        * 0.01;    color += texture2D(uSampler, (gl_FragCoord.st + vec2(-1.0,  2.0)) * st)                        * 0.01;    color += texture2D(uSampler, (gl_FragCoord.st + vec2( 0.0,  2.0)) * st)                        * 0.01;    color += texture2D(uSampler, (gl_FragCoord.st + vec2( 1.0,  2.0)) * st)                        * 0.01;    color += texture2D(uSampler, (gl_FragCoord.st + vec2( 2.0,  2.0)) * st)                        * 0.01;    color += texture2D(uSampler, (gl_FragCoord.st + vec2(-2.0,  1.0)) * st)                        * 0.01;    color += texture2D(uSampler, (gl_FragCoord.st + vec2( 2.0,  1.0)) * st)                        * 0.01;    color += texture2D(uSampler, (gl_FragCoord.st + vec2(-2.0,  0.0)) * st)                        * 0.01;    color += texture2D(uSampler, (gl_FragCoord.st + vec2( 2.0,  0.0)) * st)                        * 0.01;    color += texture2D(uSampler, (gl_FragCoord.st + vec2(-2.0, -1.0)) * st)                        * 0.01;    color += texture2D(uSampler, (gl_FragCoord.st + vec2( 2.0, -1.0)) * st)                        * 0.01;    color += texture2D(uSampler, (gl_FragCoord.st + vec2(-2.0, -2.0)) * st)                        * 0.01;    color += texture2D(uSampler, (gl_FragCoord.st + vec2(-1.0, -2.0)) * st)                        * 0.01;    color += texture2D(uSampler, (gl_FragCoord.st + vec2( 0.0, -2.0)) * st)                        * 0.01;    color += texture2D(uSampler, (gl_FragCoord.st + vec2( 1.0, -2.0)) * st)                        * 0.01;    color += texture2D(uSampler, (gl_FragCoord.st + vec2( 2.0, -2.0)) * st)                        * 0.01;    gl_FragColor = color;  }",
e.exports=o},{"../Inherit":2,"./PostEffect":46}],39:[function(t,e,i){"use strict";function o(t){this.parent=r,this.parent.call(this,t,2)}var r=t("./PostEffect"),n=t("../Inherit").__inherit,s=t("../Inherit").__copyParentMethod;n(o,r),o.prototype._FSHADER={},o.prototype._FSHADER.type="x-shader/x-fragment",o.prototype._FSHADER.src="  precision mediump float;  uniform float uWidth;  uniform float uHeight;  uniform float uFrame;  uniform sampler2D uSampler;  uniform sampler2D uSampler2;  uniform float     uWeight[10];  uniform bool      uIsX;void main(void){  vec2 st = vec2(1.0/uWidth, 1.0/uHeight);  vec2 fc = gl_FragCoord.st;  vec4 color = vec4(0.0);  if(uIsX){    color += texture2D(uSampler, (fc + vec2(-9.0, 0.0)) * st) * uWeight[9];    color += texture2D(uSampler, (fc + vec2(-8.0, 0.0)) * st) * uWeight[8];    color += texture2D(uSampler, (fc + vec2(-7.0, 0.0)) * st) * uWeight[7];    color += texture2D(uSampler, (fc + vec2(-6.0, 0.0)) * st) * uWeight[6];    color += texture2D(uSampler, (fc + vec2(-5.0, 0.0)) * st) * uWeight[5];    color += texture2D(uSampler, (fc + vec2(-4.0, 0.0)) * st) * uWeight[4];    color += texture2D(uSampler, (fc + vec2(-3.0, 0.0)) * st) * uWeight[3];    color += texture2D(uSampler, (fc + vec2(-2.0, 0.0)) * st) * uWeight[2];    color += texture2D(uSampler, (fc + vec2(-1.0, 0.0)) * st) * uWeight[1];    color += texture2D(uSampler, (fc + vec2( 0.0, 0.0)) * st) * uWeight[0];    color += texture2D(uSampler, (fc + vec2( 1.0, 0.0)) * st) * uWeight[1];    color += texture2D(uSampler, (fc + vec2( 2.0, 0.0)) * st) * uWeight[2];    color += texture2D(uSampler, (fc + vec2( 3.0, 0.0)) * st) * uWeight[3];    color += texture2D(uSampler, (fc + vec2( 4.0, 0.0)) * st) * uWeight[4];    color += texture2D(uSampler, (fc + vec2( 5.0, 0.0)) * st) * uWeight[5];    color += texture2D(uSampler, (fc + vec2( 6.0, 0.0)) * st) * uWeight[6];    color += texture2D(uSampler, (fc + vec2( 7.0, 0.0)) * st) * uWeight[7];    color += texture2D(uSampler, (fc + vec2( 8.0, 0.0)) * st) * uWeight[8];    color += texture2D(uSampler, (fc + vec2( 9.0, 0.0)) * st) * uWeight[9];  }else{    color += texture2D(uSampler, (fc + vec2(0.0, -9.0)) * st) * uWeight[9];    color += texture2D(uSampler, (fc + vec2(0.0, -8.0)) * st) * uWeight[8];    color += texture2D(uSampler, (fc + vec2(0.0, -7.0)) * st) * uWeight[7];    color += texture2D(uSampler, (fc + vec2(0.0, -6.0)) * st) * uWeight[6];    color += texture2D(uSampler, (fc + vec2(0.0, -5.0)) * st) * uWeight[5];    color += texture2D(uSampler, (fc + vec2(0.0, -4.0)) * st) * uWeight[4];    color += texture2D(uSampler, (fc + vec2(0.0, -3.0)) * st) * uWeight[3];    color += texture2D(uSampler, (fc + vec2(0.0, -2.0)) * st) * uWeight[2];    color += texture2D(uSampler, (fc + vec2(0.0, -1.0)) * st) * uWeight[1];    color += texture2D(uSampler, (fc + vec2(0.0,  0.0)) * st) * uWeight[0];    color += texture2D(uSampler, (fc + vec2(0.0,  1.0)) * st) * uWeight[1];    color += texture2D(uSampler, (fc + vec2(0.0,  2.0)) * st) * uWeight[2];    color += texture2D(uSampler, (fc + vec2(0.0,  3.0)) * st) * uWeight[3];    color += texture2D(uSampler, (fc + vec2(0.0,  4.0)) * st) * uWeight[4];    color += texture2D(uSampler, (fc + vec2(0.0,  5.0)) * st) * uWeight[5];    color += texture2D(uSampler, (fc + vec2(0.0,  6.0)) * st) * uWeight[6];    color += texture2D(uSampler, (fc + vec2(0.0,  7.0)) * st) * uWeight[7];    color += texture2D(uSampler, (fc + vec2(0.0,  8.0)) * st) * uWeight[8];    color += texture2D(uSampler, (fc + vec2(0.0,  9.0)) * st) * uWeight[9];    vec4 color2 = texture2D(uSampler2, gl_FragCoord.st * st);    vec4 color3 = vec4(color2.rgb * color2.rgb, color2.a);    color = color3 + color - color3 * color;    color = max(color, color2);    color = mix(color2, color, 0.67);/*    color.a = max(color.a, color2.a);*/  }  gl_FragColor = color;}",o.prototype._initUniforms=function(t,e){this.parent.prototype._initUniforms.call(this,t,e),t.isXUniformLocation=e.getUniformLocation(t,"uIsX"),t.weightUniformLocation=e.getUniformLocation(t,"uWeight")},o.prototype._initParams=function(t,e){this.parent.prototype._initParams.call(this,t,e);var i=[];this._getGaussianWeight(i,10,20),t.weight=i},s(o,r,"_setUniforms"),o.prototype._setUniforms=function(t,e){this.PostEffect_setUniforms(t,e);var i=this.shader,o=this.layer.gl;o.uniform1fv(i.weightUniformLocation,i.weight),o.uniform1i(i.isXUniformLocation,0==t?1:0)},e.exports=o},{"../Inherit":2,"./PostEffect":46}],40:[function(t,e,i){"use strict";function o(t){this.parent=r,this.parent.call(this,t,1)}var r=t("./PostEffect"),n=t("../Inherit").__inherit;n(o,r),o.prototype._FSHADER={},o.prototype._FSHADER.type="x-shader/x-fragment",o.prototype._FSHADER.src="  precision mediump float;  uniform float uWidth;  uniform float uHeight;  uniform float uFrame;  uniform sampler2D uSampler;  uniform sampler2D uSampler2;  void main() {    const float n = 2.0;    vec2 st = vec2(1.0 / uWidth, 1.0 / uHeight);    vec2 pos = mod(gl_FragCoord.st * st, 1.0 / n) * n;    gl_FragColor = texture2D(uSampler, pos);  }",e.exports=o},{"../Inherit":2,"./PostEffect":46}],41:[function(t,e,i){"use strict";function o(t){this.parent=r,this.parent.call(this,t,1)}var r=t("./PostEffect"),n=t("../Inherit").__inherit,s=t("../Inherit").__copyParentMethod;n(o,r),o.prototype._FSHADER={},o.prototype._FSHADER.type="x-shader/x-fragment",o.prototype._FSHADER.src="  precision mediump float;  uniform float uWidth;  uniform float uHeight;  uniform float uFrame;  uniform int   uModelNum;  uniform vec3  uModelFacePositions[5];  uniform float uModelFaceAngles[5];  uniform sampler2D uSampler;  uniform sampler2D uSampler2;  void main() {    const float n = 50.0;    const float xSize = 0.05;    const float ySize = 0.02;    vec2 st = vec2(1.0 / uWidth, 1.0 / uHeight);    vec2 pos = gl_FragCoord.st * st;    for(int i = 0; i < 5; i++) {      if(i >= uModelNum)        break;      vec3 fpos = uModelFacePositions[i];      float angle = uModelFaceAngles[i];      vec2 dpos = pos - fpos.xy;      vec2 apos = vec2( dpos.x * cos(angle) + dpos.y * sin(angle),                        -dpos.x * sin(angle) + dpos.y * cos(angle));      if(apos.x > -xSize / fpos.z &&          apos.x <  xSize / fpos.z &&          apos.y > -ySize / fpos.z &&          apos.y <  ySize / fpos.z) {        pos = floor(pos * n) / n;        break;      }    }    gl_FragColor = texture2D(uSampler, pos);  }",o.prototype._initUniforms=function(t,e){this.parent.prototype._initUniforms.call(this,t,e),t.modelNumUniformLocation=e.getUniformLocation(t,"uModelNum"),t.modelFacePositionsUniformLocation=e.getUniformLocation(t,"uModelFacePositions"),t.modelFaceAnglesUniformLocation=e.getUniformLocation(t,"uModelFaceAngles")},s(o,r,"_setUniforms"),o.prototype._setUniforms=function(t,e){this.PostEffect_setUniforms(t);var i=this.shader,o=this.layer.gl,r=e,n=this.layer.mvMatrix,s=this.layer.pMatrix,a=this.mat4.create();this.mat4.multiply(s,n,a);for(var h=(this.layer.gl.width,this.layer.gl.height,0),u=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],p=[0,0,0,0,0],l=0;l<r.getModelNum();l++){var f=r.modelViews[l],c=f.pmd.leftEyeBone,m=f.pmd.rightEyeBone;if(null!==c.id&&null!==m.id){var d=f.skinningOneBone(c),_=f.skinningOneBone(m);d[3]=1,_[3]=1;var v=[(d[0]+_[0])/2,(d[1]+_[1])/2,(d[2]+_[2])/2,1];this.mat4.multiplyVec4(a,v,v),this.mat4.multiplyVec4(a,d,d),this.mat4.multiplyVec4(a,_,_),v[0]=v[0]/v[3],v[1]=v[1]/v[3],v[2]=v[2]/v[3],v[0]=(v[0]+1)/2,v[1]=(v[1]+1)/2,v[2]=(v[2]+1)/2,d[0]=d[0]/d[3],d[1]=d[1]/d[3],d[2]=d[2]/d[3],d[0]=(d[0]+1)/2,d[1]=(d[1]+1)/2,d[2]=(d[2]+1)/2,_[0]=_[0]/_[3],_[1]=_[1]/_[3],_[2]=_[2]/_[3],_[0]=(_[0]+1)/2,_[1]=(_[1]+1)/2,_[2]=(_[2]+1)/2;var y=this.Math.atan2(_[1]-d[1],_[0]-d[0]);p[h]=y,u[3*h+0]=v[0],u[3*h+1]=v[1],u[3*h+2]=v[2],h++}}o.uniform3fv(i.modelFacePositionsUniformLocation,u),o.uniform1fv(i.modelFaceAnglesUniformLocation,p),o.uniform1i(i.modelNumUniformLocation,h)},e.exports=o},{"../Inherit":2,"./PostEffect":46}],42:[function(t,e,i){"use strict";function o(t){this.parent=r,this.parent.call(this,t,2)}var r=t("./PostEffect"),n=t("../Inherit").__inherit,s=t("../Inherit").__copyParentMethod;n(o,r),o.prototype._FSHADER={},o.prototype._FSHADER.type="x-shader/x-fragment",o.prototype._FSHADER.src="  precision mediump float;  uniform float uWidth;  uniform float uHeight;  uniform float uFrame;  uniform sampler2D uSampler;  uniform sampler2D uSampler2;  uniform float     uWeight[10];  uniform bool      uIsX;void main(void){  vec2 st = vec2(1.0/uWidth, 1.0/uHeight);  vec2 fc = gl_FragCoord.st;  vec4 color = vec4(0.0);  if(uIsX){    color += texture2D(uSampler, (fc + vec2(-9.0, 0.0)) * st) * uWeight[9];    color += texture2D(uSampler, (fc + vec2(-8.0, 0.0)) * st) * uWeight[8];    color += texture2D(uSampler, (fc + vec2(-7.0, 0.0)) * st) * uWeight[7];    color += texture2D(uSampler, (fc + vec2(-6.0, 0.0)) * st) * uWeight[6];    color += texture2D(uSampler, (fc + vec2(-5.0, 0.0)) * st) * uWeight[5];    color += texture2D(uSampler, (fc + vec2(-4.0, 0.0)) * st) * uWeight[4];    color += texture2D(uSampler, (fc + vec2(-3.0, 0.0)) * st) * uWeight[3];    color += texture2D(uSampler, (fc + vec2(-2.0, 0.0)) * st) * uWeight[2];    color += texture2D(uSampler, (fc + vec2(-1.0, 0.0)) * st) * uWeight[1];    color += texture2D(uSampler, (fc + vec2( 0.0, 0.0)) * st) * uWeight[0];    color += texture2D(uSampler, (fc + vec2( 1.0, 0.0)) * st) * uWeight[1];    color += texture2D(uSampler, (fc + vec2( 2.0, 0.0)) * st) * uWeight[2];    color += texture2D(uSampler, (fc + vec2( 3.0, 0.0)) * st) * uWeight[3];    color += texture2D(uSampler, (fc + vec2( 4.0, 0.0)) * st) * uWeight[4];    color += texture2D(uSampler, (fc + vec2( 5.0, 0.0)) * st) * uWeight[5];    color += texture2D(uSampler, (fc + vec2( 6.0, 0.0)) * st) * uWeight[6];    color += texture2D(uSampler, (fc + vec2( 7.0, 0.0)) * st) * uWeight[7];    color += texture2D(uSampler, (fc + vec2( 8.0, 0.0)) * st) * uWeight[8];    color += texture2D(uSampler, (fc + vec2( 9.0, 0.0)) * st) * uWeight[9];  }else{    color += texture2D(uSampler, (fc + vec2(0.0, -9.0)) * st) * uWeight[9];    color += texture2D(uSampler, (fc + vec2(0.0, -8.0)) * st) * uWeight[8];    color += texture2D(uSampler, (fc + vec2(0.0, -7.0)) * st) * uWeight[7];    color += texture2D(uSampler, (fc + vec2(0.0, -6.0)) * st) * uWeight[6];    color += texture2D(uSampler, (fc + vec2(0.0, -5.0)) * st) * uWeight[5];    color += texture2D(uSampler, (fc + vec2(0.0, -4.0)) * st) * uWeight[4];    color += texture2D(uSampler, (fc + vec2(0.0, -3.0)) * st) * uWeight[3];    color += texture2D(uSampler, (fc + vec2(0.0, -2.0)) * st) * uWeight[2];    color += texture2D(uSampler, (fc + vec2(0.0, -1.0)) * st) * uWeight[1];    color += texture2D(uSampler, (fc + vec2(0.0,  0.0)) * st) * uWeight[0];    color += texture2D(uSampler, (fc + vec2(0.0,  1.0)) * st) * uWeight[1];    color += texture2D(uSampler, (fc + vec2(0.0,  2.0)) * st) * uWeight[2];    color += texture2D(uSampler, (fc + vec2(0.0,  3.0)) * st) * uWeight[3];    color += texture2D(uSampler, (fc + vec2(0.0,  4.0)) * st) * uWeight[4];    color += texture2D(uSampler, (fc + vec2(0.0,  5.0)) * st) * uWeight[5];    color += texture2D(uSampler, (fc + vec2(0.0,  6.0)) * st) * uWeight[6];    color += texture2D(uSampler, (fc + vec2(0.0,  7.0)) * st) * uWeight[7];    color += texture2D(uSampler, (fc + vec2(0.0,  8.0)) * st) * uWeight[8];    color += texture2D(uSampler, (fc + vec2(0.0,  9.0)) * st) * uWeight[9];  }  gl_FragColor = color;}",o.prototype._initUniforms=function(t,e){this.parent.prototype._initUniforms.call(this,t,e),t.isXUniformLocation=e.getUniformLocation(t,"uIsX"),t.weightUniformLocation=e.getUniformLocation(t,"uWeight")},o.prototype._initParams=function(t,e){this.parent.prototype._initParams.call(this,t,e);var i=[];this._getGaussianWeight(i,10,25),t.weight=i},s(o,r,"_setUniforms"),o.prototype._setUniforms=function(t,e){this.PostEffect_setUniforms(t,e);var i=this.shader,o=this.layer.gl;o.uniform1fv(i.weightUniformLocation,i.weight),o.uniform1i(i.isXUniformLocation,0==t?1:0)},e.exports=o},{"../Inherit":2,"./PostEffect":46}],43:[function(t,e,i){"use strict";function o(t){this.canvas=t,this.gl=this._initGl(t),this.shader=this._initShader(this.gl),this.viewNear=.1,this.viewFar=2e3,this.viewAngle=60,this.gl.clearColor(0,0,0,0),this.gl.clearDepth(1),this.stageShaders=[],this.postEffects={},this.mvMatrix=this.mat4.create(),this.pMatrix=this.mat4.create(),this.mvpMatrix=this.mat4.create(),this.lightPosition=[20,50,-40],this.lightCenter=[0,0,10],this.lightUpDirection=[0,1,0],this.lightMatrix=this.mat4.create(),this.shadowFrameBuffer=null,this.shadowFrameBufferSize=1024,this._initPostEffects(),this._initStageShaders(),this._initShadowFrameBuffer()}var r=t("./BlurEffect"),n=t("./GaussianBlurEffect"),s=t("./DiffusionBlurEffect"),a=t("./DivisionEffect"),h=t("./LowResolutionEffect"),u=t("./FaceMosaicEffect"),p=t("./SimpleStage"),l=t("./MeshedStage"),f=t("./TrialStage");o.prototype.mat4=mat4,o.prototype.Math=Math,o.prototype._NAMES=["webgl","experimental-webgl"],o.prototype._BLEND_ALPHA=0,o.prototype._BLEND_ALPHA2=1,o.prototype._BLEND_ADD_ALPHA=2,o.prototype._SHADERS={},o.prototype._SHADERS["shader-vs"]={},o.prototype._SHADERS["shader-vs"].type="x-shader/x-vertex",o.prototype._SHADERS["shader-vs"].src="  attribute vec3 aVertexPosition;  attribute vec3 aVertexPosition1;  attribute vec3 aVertexPosition2;  attribute vec3 aVertexNormal;  attribute vec3 aVertexMorph;  attribute float aVertexEdge;  attribute vec2 aBoneIndices;  attribute float aBoneWeight;  attribute vec3 aMotionTranslation1;  attribute vec3 aMotionTranslation2;  attribute vec4 aMotionRotation1;  attribute vec4 aMotionRotation2;  attribute vec2 aTextureCoordinates;  uniform mat4 uMVMatrix;  uniform mat4 uPMatrix;  uniform mat4 uMVPMatrix;  uniform mat3 uNMatrix;  uniform vec3 uLightColor;  uniform vec3 uLightDirection;  uniform vec4 uDiffuseColor;  uniform vec3 uAmbientColor;  uniform vec3 uSpecularColor;  uniform float uShininess;  uniform int uSkinningType;  uniform int uLightingType;  uniform int uVTFWidth;  uniform sampler2D uVTF;  uniform sampler2D uToonTexture;  uniform bool uUseToon;  uniform bool uEdge;  uniform bool uShadow;  uniform mat4 uLightMatrix;  uniform bool uShadowGeneration;  uniform bool uShadowMapping;  varying vec2 vTextureCoordinates;  varying vec4 vLightWeighting;  varying vec3 vNormal;  varying vec4 vShadowDepth;  highp float binary32(vec4 rgba) {    rgba = floor(255.0 * rgba + 0.5);    highp float val;    val  = rgba[0];    val += rgba[1] / (256.0);    val += rgba[2] / (256.0 * 256.0);    val += rgba[3] / (256.0 * 256.0 * 256.0);    return rgba[0] >= 128.0 ? -(val - 128.0) : val;  }  float getU(float index) {    float unit = 1.0 / float(uVTFWidth);    return fract(index * unit + unit * 0.5);  }  float getV(float index) {    float unit = 1.0 / float(uVTFWidth);    return floor(index * unit) * unit + unit * 0.5;  }  vec2 getUV(float index) {    float u = getU(index);    float v = getV(index);    return vec2(u, v);  }  vec4 getVTF(float index) {    return texture2D(uVTF, getUV(index));  }  vec3 getMotionTranslation(float bn) {    float index = bn * 7.0 + 0.0;    highp float x = binary32(getVTF(index+0.0));    highp float y = binary32(getVTF(index+1.0));    highp float z = binary32(getVTF(index+2.0));    return vec3(x, y, z);  }  vec4 getMotionRotation(float bn) {    float index = bn * 7.0 + 3.0;    highp float x = binary32(getVTF(index+0.0));    highp float y = binary32(getVTF(index+1.0));    highp float z = binary32(getVTF(index+2.0));    highp float w = binary32(getVTF(index+3.0));    return vec4(x, y, z, w);  }  vec3 qtransform(vec3 v, vec4 q) {    return v + 2.0 * cross(cross(v, q.xyz) - q.w*v, q.xyz);  }  void main() {    vec3 pos;    vec3 norm;    if(uSkinningType == 2) {      vec3 v1 = aVertexPosition1 + aVertexMorph;      v1 = qtransform(v1, aMotionRotation1) + aMotionTranslation1;      norm = qtransform(aVertexNormal, aMotionRotation1);      if(aBoneWeight < 0.99) {        vec3 v2 = aVertexPosition2 + aVertexMorph;        v2 = qtransform(v2, aMotionRotation2) + aMotionTranslation2;        pos = mix(v2, v1, aBoneWeight);        vec3 n2 = qtransform(aVertexNormal, aMotionRotation2);        norm = normalize(mix(n2, norm, aBoneWeight));      } else {        pos = v1;      }    } else if(uSkinningType == 1) {      float b1 = floor(aBoneIndices.x + 0.5);      vec3 v1 = aVertexPosition1 + aVertexMorph;      v1 = qtransform(v1, getMotionRotation(b1)) + getMotionTranslation(b1);      norm = qtransform(aVertexNormal, getMotionRotation(b1));      if(aBoneWeight < 0.99) {        float b2 = floor(aBoneIndices.y + 0.5);        vec3 v2 = aVertexPosition2 + aVertexMorph;        v2 = qtransform(v2, getMotionRotation(b2)) + getMotionTranslation(b2);        pos = mix(v2, v1, aBoneWeight);        vec3 n2 = qtransform(aVertexNormal, getMotionRotation(b2));        norm = normalize(mix(n2, norm, aBoneWeight));      } else {        pos = v1;      }    } else {      pos = aVertexPosition + aVertexMorph;      norm = normalize(aVertexNormal);    }    gl_Position = uMVPMatrix * vec4(pos, 1.0);    if(uShadowGeneration) {      vShadowDepth = gl_Position;      return;    }    vTextureCoordinates = aTextureCoordinates;    vNormal = normalize(norm);    if(uShadowMapping) {      vShadowDepth = uLightMatrix * vec4(pos, 1.0);    }    if(! uEdge && uLightingType > 0) {      vec4 vertexPositionEye4 = uMVMatrix * vec4(pos, 1.0);      vec3 vertexPositionEye3 = vertexPositionEye4.xyz / vertexPositionEye4.w;      vec3 vectorToLightSource = normalize(uLightDirection -                                           vertexPositionEye3);      vec3 normalEye = normalize(uNMatrix * norm);      float diffuseLightWeightning = (uShadow)                                       ? max(dot(normalEye,                                                 vectorToLightSource), 0.0)                                       : 1.0;      vec3 reflectionVector = normalize(reflect(-vectorToLightSource,                                                 normalEye));      vec3 viewVectorEye = -normalize(vertexPositionEye3);      float rdotv = max(dot(reflectionVector, viewVectorEye), 0.0);      float specularLightWeightning = pow(rdotv, uShininess);      vec3 vLight = uAmbientColor +                     uLightColor *                      (uDiffuseColor.rgb * diffuseLightWeightning +                       uSpecularColor * specularLightWeightning);      vLightWeighting = clamp(vec4(vLight, uDiffuseColor.a), 0.0, 1.0);      if(uLightingType == 2 && uUseToon) {        vec2 toonCoord = vec2(0.0, 0.5 * (1.0 - dot(uLightDirection,                                                    normalEye)));        vLightWeighting.rgb *= texture2D(uToonTexture, toonCoord).rgb;      }    } else {      vLightWeighting = uDiffuseColor;    }    /* just copied from MMD.js */    if(uEdge) {      const float thickness = 0.003;      vec4 epos = gl_Position;      vec4 epos2 = uMVPMatrix * vec4(pos + norm, 1.0);      vec4 enorm = normalize(epos2 - epos);      gl_Position = epos + enorm * thickness * aVertexEdge * epos.w;    }  }",o.prototype._SHADERS["shader-fs"]={},o.prototype._SHADERS["shader-fs"].type="x-shader/x-fragment",o.prototype._SHADERS["shader-fs"].src="  precision mediump float;  varying vec2 vTextureCoordinates;  uniform sampler2D uSampler;  uniform bool uEdge;  uniform bool uUseSphereMap;  uniform bool uUseSphereMapAddition;  uniform bool uShadowGeneration;  uniform bool uShadowMapping;  uniform sampler2D uSphereTexture;  uniform sampler2D uShadowTexture;  varying vec4 vLightWeighting;  varying vec3 vNormal;  varying vec4 vShadowDepth;  vec4 packDepth(const in float depth) {    const vec4 bitShift = vec4(256.0*256.0*256.0, 256.0*256.0, 256.0, 1.0);    const vec4 bitMask  = vec4(0.0, 1.0/256.0, 1.0/256.0, 1.0/256.0);    vec4 res = fract(depth * bitShift);    res -= res.xxyz * bitMask;    return res;  }  float unpackDepth(const in vec4 rgba) {    const vec4 bitShift = vec4(1.0/(256.0*256.0*256.0),                               1.0/(256.0*256.0), 1.0/256.0, 1.0);    float depth = dot(rgba, bitShift);    return depth;  }  void main() {    if(uEdge) {      gl_FragColor = vec4(vec3(0.0), vLightWeighting.a);      return;    }    if(uShadowGeneration) {/*      gl_FragColor = packDepth(gl_FragCoord.z);*/      vec3 lightCoord = vShadowDepth.xyz / vShadowDepth.w;      gl_FragColor = packDepth(lightCoord.z);      return;    }    vec4 textureColor = texture2D(uSampler, vTextureCoordinates);    /* just copied from MMD.js */    if(uUseSphereMap) {      vec2 sphereCood = 0.5 * (1.0 + vec2(1.0, -1.0) * vNormal.xy);      vec3 sphereColor = texture2D(uSphereTexture, sphereCood).rgb;      if(uUseSphereMapAddition) {        textureColor.rgb += sphereColor;      } else {        textureColor.rgb *= sphereColor;      }    }    vec4 color = vLightWeighting * textureColor;    if(uShadowMapping) {      vec3 lightCoord = vShadowDepth.xyz / vShadowDepth.w;      vec4 rgbaDepth = texture2D(uShadowTexture,                                  lightCoord.xy*0.5+0.5);      float depth = unpackDepth(rgbaDepth);/*      float depth2 = unpackDepth(packDepth(lightCoord.z));*/      float depth2 = lightCoord.z;      if(depth2 - 0.00002 > depth) {        color.rgb *= 0.7;      }    }    gl_FragColor = color;  }",o.prototype._initGl=function(t){for(var e=this._NAMES,i=null,o=0;o<e.length;o++)try{i=t.getContext(e[o],{antialias:!0})}catch(r){if(i)break}return i?(i.viewportWidth=t.width,i.viewportHeight=t.height):alert("Failed to create WebGL context!"),i},o.prototype._compileShaderFromDOM=function(t,e){var i=document.getElementById(e);if(!i)return null;for(var o="",r=i.firstChild;r;)3==r.nodeType&&(o+=r.textContent),r=r.nextSibling;return this.compileShader(t,o,i.type)},o.prototype.compileShader=function(t,e,i){var o;if("x-shader/x-fragment"==i)o=t.createShader(t.FRAGMENT_SHADER);else{if("x-shader/x-vertex"!=i)return null;o=t.createShader(t.VERTEX_SHADER)}return t.shaderSource(o,e),t.compileShader(o),t.getShaderParameter(o,t.COMPILE_STATUS)?o:(alert(t.getShaderInfoLog(o)),null)},o.prototype._initVertexShader=function(t){var e=this._SHADERS["shader-vs"];return this.gl.getParameter(this.gl.MAX_VERTEX_TEXTURE_IMAGE_UNITS)<=0&&(e.src=e.src.replace("texture2D(uVTF, getUV(index))","vec4(0.0)"),e.src=e.src.replace("vLightWeighting.rgb *= texture2D(uToonTexture, toonCoord).rgb","vLightWeighting.rgb *= vec3(1.0)")),this.compileShader(t,e.src,e.type)},o.prototype._initFragmentShader=function(t){var e=this._SHADERS["shader-fs"];return this.compileShader(t,e.src,e.type)},o.prototype._initShader=function(t){var e=this._initVertexShader(t),i=this._initFragmentShader(t),o=t.createProgram();return t.attachShader(o,e),t.attachShader(o,i),t.linkProgram(o),t.getProgramParameter(o,t.LINK_STATUS)||alert("Failed to setup shaders"),t.useProgram(o),o.vertexPositionAttribute=t.getAttribLocation(o,"aVertexPosition"),o.vertexPositionAttribute1=t.getAttribLocation(o,"aVertexPosition1"),o.vertexPositionAttribute2=t.getAttribLocation(o,"aVertexPosition2"),o.vertexMorphAttribute=t.getAttribLocation(o,"aVertexMorph"),o.vertexEdgeAttribute=t.getAttribLocation(o,"aVertexEdge"),o.vertexNormalAttribute=t.getAttribLocation(o,"aVertexNormal"),o.boneWeightAttribute=t.getAttribLocation(o,"aBoneWeight"),o.boneIndicesAttribute=t.getAttribLocation(o,"aBoneIndices"),o.motionTranslationAttribute1=t.getAttribLocation(o,"aMotionTranslation1"),o.motionTranslationAttribute2=t.getAttribLocation(o,"aMotionTranslation2"),o.motionRotationAttribute1=t.getAttribLocation(o,"aMotionRotation1"),o.motionRotationAttribute2=t.getAttribLocation(o,"aMotionRotation2"),o.textureCoordAttribute=t.getAttribLocation(o,"aTextureCoordinates"),o.pMatrixUniform=t.getUniformLocation(o,"uPMatrix"),o.mvMatrixUniform=t.getUniformLocation(o,"uMVMatrix"),o.mvpMatrixUniform=t.getUniformLocation(o,"uMVPMatrix"),o.nMatrixUniform=t.getUniformLocation(o,"uNMatrix"),o.lightColorUniform=t.getUniformLocation(o,"uLightColor"),o.lightDirectionUniform=t.getUniformLocation(o,"uLightDirection"),o.diffuseColorUniform=t.getUniformLocation(o,"uDiffuseColor"),o.ambientColorUniform=t.getUniformLocation(o,"uAmbientColor"),o.specularColorUniform=t.getUniformLocation(o,"uSpecularColor"),o.shininessUniform=t.getUniformLocation(o,"uShininess"),o.uSamplerUniform=t.getUniformLocation(o,"uSampler"),o.uSkinningTypeUniform=t.getUniformLocation(o,"uSkinningType"),o.uLightingTypeUniform=t.getUniformLocation(o,"uLightingType"),o.uVTFUniform=t.getUniformLocation(o,"uVTF"),o.uVTFWidthUniform=t.getUniformLocation(o,"uVTFWidth"),o.useToonUniform=t.getUniformLocation(o,"uUseToon"),o.toonTextureUniform=t.getUniformLocation(o,"uToonTexture"),o.edgeUniform=t.getUniformLocation(o,"uEdge"),o.shadowUniform=t.getUniformLocation(o,"uShadow"),o.sphereTextureUniform=t.getUniformLocation(o,"uSphereTexture"),o.useSphereMapUniform=t.getUniformLocation(o,"uUseSphereMap"),o.useSphereMapAdditionUniform=t.getUniformLocation(o,"uUseSphereMapAddition"),o.shadowGenerationUniform=t.getUniformLocation(o,"uShadowGeneration"),o.shadowMappingUniform=t.getUniformLocation(o,"uShadowMapping"),o.shadowTextureUniform=t.getUniformLocation(o,"uShadowTexture"),o.lightMatrixUniform=t.getUniformLocation(o,"uLightMatrix"),o},o.prototype._initPostEffects=function(){this.postEffects.blur=new r(this),this.postEffects.gaussian=new n(this),this.postEffects.diffusion=new s(this),this.postEffects.division=new a(this),this.postEffects.low_reso=new h(this),this.postEffects.face_mosaic=new u(this)},o.prototype._initStageShaders=function(){this.stageShaders[0]=new p(this),this.stageShaders[1]=new l(this),this.stageShaders[2]=new f(this)},o.prototype._initShadowFrameBuffer=function(){var t=this.shadowFrameBufferSize,e=this.shadowFrameBufferSize;this.shadowFrameBuffer=this._createFrameBuffer(this.shader,this.gl,t,e)},o.prototype.setMatrixUniforms=function(t){t.uniformMatrix4fv(this.shader.pMatrixUniform,!1,this.pMatrix),t.uniformMatrix4fv(this.shader.mvMatrixUniform,!1,this.mvMatrix),this.mat4.multiply(this.pMatrix,this.mvMatrix,this.mvpMatrix),t.uniformMatrix4fv(this.shader.mvpMatrixUniform,!1,this.mvpMatrix);var e=mat3.create();mat4.toInverseMat3(this.mvMatrix,e),mat3.transpose(e),t.uniformMatrix3fv(this.shader.nMatrixUniform,!1,e);var i=vec3.normalize(vec3.create(this.lightPosition)),o=mat4.create();mat3.toMat4(e,o),mat4.multiplyVec3(o,i,i),t.uniform3fv(this.shader.lightDirectionUniform,i)},o.prototype.registerLightMatrix=function(){this.mat4.multiply(this.pMatrix,this.mvMatrix,this.lightMatrix)},o.prototype.viewport=function(){this.gl.viewport(0,0,this.gl.viewportWidth,this.gl.viewportHeight)},o.prototype.clear=function(){this.gl.clear(this.gl.COLOR_BUFFER_BIT)},o.prototype.perspective=function(t){this.mat4.perspective(t,this.gl.viewportWidth/this.gl.viewportHeight,this.viewNear,this.viewFar,this.pMatrix),this.pMatrix[0]*=-1},o.prototype.ortho=function(t,e){this.mat4.ortho(0,this.gl.viewportWidth,-this.gl.viewportHeight,0,t,e,this.pMatrix)},o.prototype.lookAt=function(t,e,i){this.mat4.lookAt(t,e,i,this.mvMatrix)},o.prototype.identity=function(){this.mat4.identity(this.mvMatrix)},o.prototype.generateTexture=function(t){var e=this.gl,i=e.createTexture();return e.bindTexture(e.TEXTURE_2D,i),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,t),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.REPEAT),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.REPEAT),e.bindTexture(e.TEXTURE_2D,null),i},o.prototype.pourVTF=function(t,e,i){var o=this.gl;o.bindTexture(o.TEXTURE_2D,t),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_MAG_FILTER,o.NEAREST),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_MIN_FILTER,o.NEAREST),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_WRAP_S,o.CLAMP_TO_EDGE),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_WRAP_T,o.CLAMP_TO_EDGE),o.texImage2D(o.TEXTURE_2D,0,o.RGBA,i,i,0,o.RGBA,o.UNSIGNED_BYTE,e),o.bindTexture(o.TEXTURE_2D,null),o.uniform1i(this.shader.uVTFWidthUniform,i)},o.prototype._createFrameBuffer=function(t,e,i,o){var r=e.createFramebuffer();e.bindFramebuffer(e.FRAMEBUFFER,r);var n=e.createRenderbuffer();e.bindRenderbuffer(e.RENDERBUFFER,n),e.renderbufferStorage(e.RENDERBUFFER,e.DEPTH_COMPONENT16,i,o),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.RENDERBUFFER,n);var s=e.createTexture();return e.bindTexture(e.TEXTURE_2D,s),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,i,o,0,e.RGBA,e.UNSIGNED_BYTE,null),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,s,0),e.bindTexture(e.TEXTURE_2D,null),e.bindRenderbuffer(e.RENDERBUFFER,null),e.bindFramebuffer(e.FRAMEBUFFER,null),{f:r,d:n,t:s}},o.prototype.draw=function(t,e,i,o){o||(o=0);var r=this.gl,n=this.shader;r.activeTexture(r.TEXTURE0),r.bindTexture(r.TEXTURE_2D,t),r.uniform1i(n.uSamplerUniform,0),r.enable(r.DEPTH_TEST),r.depthFunc(r.LEQUAL),this.setMatrixUniforms(r),r.drawElements(r.TRIANGLES,i,r.UNSIGNED_SHORT,2*o)},o.prototype.pourArrayBuffer=function(t,e,i,o){var r=this.gl;r.bindBuffer(r.ARRAY_BUFFER,t),r.bufferData(r.ARRAY_BUFFER,e,r.STATIC_DRAW),t.itemSize=i,t.numItems=o},o.prototype.pourElementArrayBuffer=function(t,e,i,o){var r=this.gl;r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,t),r.bufferData(r.ELEMENT_ARRAY_BUFFER,e,r.STATIC_DRAW),t.itemSize=i,t.numItems=o},o.prototype.createFloatArray=function(t){return new Float32Array(t)},o.prototype.createUintArray=function(t){return new Uint16Array(t)},o.prototype.createUint8Array=function(t){return new Uint8Array(t)},o.prototype.createBuffer=function(){return this.gl.createBuffer()},o.prototype.calculateSquareValue=function(t){for(var e=1;t>e;)e<<=1;return e},o.prototype.calculateVTFWidth=function(t){for(var e=1;t>e*e;)e=2*e;return e},e.exports=o},{"./BlurEffect":38,"./DiffusionBlurEffect":39,"./DivisionEffect":40,"./FaceMosaicEffect":41,"./GaussianBlurEffect":42,"./LowResolutionEffect":44,"./MeshedStage":45,"./SimpleStage":47,"./TrialStage":49}],44:[function(t,e,i){"use strict";function o(t){this.parent=r,this.parent.call(this,t,1)}var r=t("./PostEffect"),n=t("../Inherit").__inherit;n(o,r),o.prototype._FSHADER={},o.prototype._FSHADER.type="x-shader/x-fragment",o.prototype._FSHADER.src="  precision mediump float;  uniform float uWidth;  uniform float uHeight;  uniform float uFrame;  uniform sampler2D uSampler;  uniform sampler2D uSampler2;  void main() {    const float n = 50.0;    vec2 st = vec2(1.0 / uWidth, 1.0 / uHeight);    vec2 pos = gl_FragCoord.st * st;    pos = floor(pos * n) / n;    gl_FragColor = texture2D(uSampler, pos);  }",e.exports=o},{"../Inherit":2,"./PostEffect":46}],45:[function(t,e,i){"use strict";function o(t){this.parent=r,this.parent.call(this,t)}var r=t("./StageShader"),n=t("../Inherit").__inherit;n(o,r),o.prototype._FSHADER={},o.prototype._FSHADER.type="x-shader/x-fragment",o.prototype._FSHADER.src="  precision mediump float;  varying vec3  vPosition;  varying float vAlpha;  varying vec4  vShadowDepth;  uniform float uFrame;  uniform float uWidth;  uniform int   uModelNum;  uniform vec3  uModelCenterPosition[5];  uniform vec3  uModelRightFootPosition[5];  uniform vec3  uModelLeftFootPosition[5];  uniform bool  uShadowMapping;  uniform sampler2D uShadowTexture;  const float tileSize = 5.0;  const float pi = 3.1415926535;  const float circleRatio = 0.01;  vec4 packDepth(const in float depth) {    const vec4 bitShift = vec4(256.0*256.0*256.0, 256.0*256.0, 256.0, 1.0);    const vec4 bitMask  = vec4(0.0, 1.0/256.0, 1.0/256.0, 1.0/256.0);    vec4 res = fract(depth * bitShift);    res -= res.xxyz * bitMask;    return res;  }  float unpackDepth(const in vec4 rgba) {    const vec4 bitShift = vec4(1.0/(256.0*256.0*256.0),                               1.0/(256.0*256.0), 1.0/256.0, 1.0);    float depth = dot(rgba, bitShift);    return depth;  }  vec2 getTile(vec2 pos) {    return floor((pos + uWidth + (tileSize * 0.5)) / tileSize);  }  void main() {    vec3 pos = vPosition / uWidth;    float s = cos(uFrame/(pi*2.0));    float b = 0.0;    float alpha = vAlpha;    vec2 tile = getTile(vPosition.xz);    float visibility = 1.0;    if(uShadowMapping) {      vec3 lightCoord = vShadowDepth.xyz / vShadowDepth.w;      vec4 rgbaDepth = texture2D(uShadowTexture,                                  lightCoord.xy*0.5+0.5);      float depth = unpackDepth(rgbaDepth);/*      float depth2 = unpackDepth(packDepth(lightCoord.z));*/      float depth2 = lightCoord.z;      if(depth != 0.0) {        visibility = 0.5;      }    }    for(int i = 0; i < 5; i++) {      if(i >= uModelNum)        break;      vec2 ctile = getTile(uModelCenterPosition[i].xz);      vec2 ltile = getTile(uModelLeftFootPosition[i].xz);      vec2 rtile = getTile(uModelRightFootPosition[i].xz);      if(tile == ltile || tile == rtile) {        gl_FragColor = vec4(vec3(1.0, 0.5, 0.5)*s*visibility, alpha);        return;      }    }    tile = vec2(mod(tile.x, 2.0), mod(tile.y, 2.0));    if(pos.x * pos.x+ pos.z * pos.z > circleRatio) {      b = 0.8;    }    if(tile == vec2(0.0) || tile == vec2(1.0)) {      gl_FragColor = vec4((vec3(1.0)+b)*visibility, alpha);    } else {      gl_FragColor = vec4((vec3(0.0)+b)*visibility, alpha);    }  }",
e.exports=o},{"../Inherit":2,"./StageShader":48}],46:[function(t,e,i){"use strict";function o(t,e){this.layer=t,this.shader=null,this.pathNum=e,this._init()}o.prototype.Math=Math,o.prototype.mat4=mat4,o.prototype.vec3=vec3,o.prototype.quat4=quat4,o.prototype._VSHADER={},o.prototype._VSHADER.type="x-shader/x-vertex",o.prototype._VSHADER.src="  attribute vec3 aPosition;  uniform   mat4 uMvpMatrix;  void main() {    gl_Position = uMvpMatrix * vec4(aPosition, 1.0);  }",o.prototype._FSHADER={},o.prototype._FSHADER.type="x-shader/x-fragment",o.prototype._FSHADER.src="  precision mediump float;  uniform float uWidth;  uniform float uHeight;  uniform float uFrame;  uniform sampler2D uSampler;  uniform sampler2D uSampler2;  void main() {    vec2 ts = vec2(1.0 / uWidth, 1.0 / uHeight);    vec4 color = texture2D(uSampler, gl_FragCoord.st * ts);    gl_FragColor = color;  }",o.prototype._init=function(){var t=this.layer.gl;this.shader=this._initShader(t),this._initAttributes(this.shader,t),this._initUniforms(this.shader,t),this._initBuffers(this.shader,t),this._initMatrices(this.shader,t),this._initParams(this.shader,t),this._initFrameBuffers(this.shader,t)},o.prototype._initShader=function(t){var e=this._compileShader(this._VSHADER),i=this._compileShader(this._FSHADER),o=t.createProgram();return t.attachShader(o,e),t.attachShader(o,i),t.linkProgram(o),t.getProgramParameter(o,t.LINK_STATUS)||alert("Failed to setup shaders"),o},o.prototype._initAttributes=function(t,e){t.positionAttribute=e.getAttribLocation(t,"aPosition")},o.prototype._initUniforms=function(t,e){t.mvpMatrixUniformLocation=e.getUniformLocation(t,"uMvpMatrix"),t.widthUniformLocation=e.getUniformLocation(t,"uWidth"),t.heightUniformLocation=e.getUniformLocation(t,"uHeight"),t.frameUniformLocation=e.getUniformLocation(t,"uFrame"),t.samplerUniformLocation=e.getUniformLocation(t,"uSampler"),t.sampler2UniformLocation=e.getUniformLocation(t,"uSampler2"),t.width=this.layer.canvas.width,t.height=this.layer.canvas.height,t.frame=0},o.prototype._initBuffers=function(t,e){var i=[-1,1,0,1,1,0,-1,-1,0,1,-1,0],o=[0,1,2,3,2,1],r=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,r),e.bufferData(e.ARRAY_BUFFER,new Float32Array(i),e.STATIC_DRAW);var n=e.createBuffer();e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,n),e.bufferData(e.ELEMENT_ARRAY_BUFFER,new Uint16Array(o),e.STATIC_DRAW),t.pBuffer=r,t.iBuffer=n},o.prototype._initMatrices=function(t,e){var i=this.mat4.create(),o=this.mat4.create(),r=this.mat4.create(),n=this.mat4.create(),s=this.mat4.create();this.mat4.lookAt([0,0,.5],[0,0,0],[0,1,0],o),this.mat4.ortho(-1,1,1,-1,.1,1,r),this.mat4.multiply(r,o,n),this.mat4.identity(i),this.mat4.multiply(n,i,s),t.mvpMatrix=s},o.prototype._initFrameBuffers=function(t,e){t.pathNum=this.pathNum,t.frameBuffers=[];for(var i=0;i<t.pathNum;i++)t.frameBuffers.push(this.layer._createFrameBuffer(t,e,t.width,t.height))},o.prototype._initParams=function(t,e){},o.prototype._compileShader=function(t){return this.layer.compileShader(this.layer.gl,t.src,t.type)},o.prototype._getGaussianWeight=function(t,e,i){for(var o=0,r=i*i/100,n=0;e>n;n++){var s=1+2*n,a=this.Math.exp(-.5*(s*s)/r);t[n]=a,n>0&&(a*=2),o+=a}for(n=0;e>n;n++)t[n]/=o},o.prototype._bindAttributes=function(){var t=this.shader,e=this.layer.gl;e.bindBuffer(e.ARRAY_BUFFER,t.pBuffer),e.enableVertexAttribArray(t.positionAttribute),e.vertexAttribPointer(t.positionAttribute,3,e.FLOAT,!1,0,0)},o.prototype._bindIndices=function(){var t=this.shader,e=this.layer.gl;e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,t.iBuffer)},o.prototype._setUniforms=function(t,e){var i=this.shader,o=this.layer.gl;o.uniformMatrix4fv(i.mvpMatrixUniformLocation,!1,i.mvpMatrix),o.uniform1f(i.widthUniformLocation,i.width),o.uniform1f(i.heightUniformLocation,i.height),o.uniform1f(i.frameUniformLocation,i.frame)},o.prototype.bindFrameBufferForScene=function(){var t=this.shader,e=this.layer.gl;e.bindFramebuffer(e.FRAMEBUFFER,t.frameBuffers[0].f)},o.prototype._bindFrameBuffer=function(t){var e=this.shader,i=this.layer.gl,o=e.pathNum-1==t?null:e.frameBuffers[t+1].f;i.bindFramebuffer(i.FRAMEBUFFER,o),i.clear(i.COLOR_BUFFER_BIT|i.DEPTH_BUFFER_BIT)},o.prototype._bindFrameTextures=function(t){var e=this.shader,i=this.layer.gl;i.activeTexture(i.TEXTURE0),i.bindTexture(i.TEXTURE_2D,e.frameBuffers[t].t),i.uniform1i(e.samplerUniformLocation,0),null!==e.sampler2UniformLocation&&(i.activeTexture(i.TEXTURE1),i.bindTexture(i.TEXTURE_2D,e.frameBuffers[0].t),i.uniform1i(e.sampler2UniformLocation,1))},o.prototype._enableConditions=function(){var t=(this.shader,this.layer.gl);t.enable(t.BLEND),t.disable(t.CULL_FACE),t.cullFace(t.FRONT)},o.prototype._setParams=function(t,e){},o.prototype._draw=function(){var t=(this.shader,this.layer.gl);t.drawElements(t.TRIANGLES,6,t.UNSIGNED_SHORT,0),t.flush()},o.prototype.draw=function(t){for(var e=0;e<this.shader.pathNum;e++)this._bindFrameBuffer(e),this._bindAttributes(),this._setUniforms(e,t),this._bindIndices(),this._bindFrameTextures(e),this._enableConditions(),this._draw()},e.exports=o},{}],47:[function(t,e,i){"use strict";function o(t){this.parent=n,this.parent.call(this,t)}var r=t("../Inherit").__inherit,n=t("./StageShader");r(o,n),o.prototype._FSHADER={},o.prototype._FSHADER.type="x-shader/x-fragment",o.prototype._FSHADER.src="  precision mediump float;  varying vec3  vPosition;  varying vec4  vShadowDepth;  varying float vAlpha;  uniform float uFrame;  uniform float uWidth;  uniform int   uModelNum;  uniform vec3  uModelCenterPosition[5];  uniform vec3  uModelRightFootPosition[5];  uniform vec3  uModelLeftFootPosition[5];  uniform bool  uShadowMapping;  uniform sampler2D uShadowTexture;  vec4 packDepth(const in float depth) {    const vec4 bitShift = vec4(256.0*256.0*256.0, 256.0*256.0, 256.0, 1.0);    const vec4 bitMask  = vec4(0.0, 1.0/256.0, 1.0/256.0, 1.0/256.0);    vec4 res = fract(depth * bitShift);    res -= res.xxyz * bitMask;    return res;  }  float unpackDepth(const in vec4 rgba) {    const vec4 bitShift = vec4(1.0/(256.0*256.0*256.0),                               1.0/(256.0*256.0), 1.0/256.0, 1.0);    float depth = dot(rgba, bitShift);    return depth;  }  void main() {    float r = cos(vPosition.x);    float g = cos(vPosition.z);    vec4 color = vec4(vec3(r*g), vAlpha);    if(uShadowMapping) {      vec3 lightCoord = vShadowDepth.xyz / vShadowDepth.w;      vec4 rgbaDepth = texture2D(uShadowTexture,                                  lightCoord.xy*0.5+0.5);      float depth = unpackDepth(rgbaDepth);/*      float depth2 = unpackDepth(packDepth(lightCoord.z));*/      float depth2 = lightCoord.z;      if(depth != 0.0) {        color.rgb *= 0.5;      }    }    gl_FragColor = color;  }",e.exports=o},{"../Inherit":2,"./StageShader":48}],48:[function(t,e,i){"use strict";function o(t){this.layer=t,this.shader=null,this._init()}o.prototype._VSHADER={},o.prototype._VSHADER.type="x-shader/x-vertex",o.prototype._VSHADER.src="  attribute vec3 aPosition;  attribute float aAlpha;  uniform mat4 uMVMatrix;  uniform mat4 uPMatrix;  uniform mat4 uLightMatrix;  varying vec3 vPosition;  varying vec4 vShadowDepth;  varying float vAlpha;  void main() {    gl_Position = uPMatrix * uMVMatrix * vec4(aPosition, 1.0);    vPosition = aPosition;    vAlpha = aAlpha;    vShadowDepth = uLightMatrix * vec4(aPosition, 1.0);  }",o.prototype._FSHADER={},o.prototype._FSHADER.type="x-shader/x-fragment",o.prototype._FSHADER.src="  precision mediump float;  varying vec3  vPosition;  varying vec4  vShadowDepth;  varying float vAlpha;  uniform float uFrame;  uniform float uWidth;  uniform int   uModelNum;  uniform vec3  uModelCenterPosition[5];  uniform vec3  uModelRightFootPosition[5];  uniform vec3  uModelLeftFootPosition[5];  uniform bool  uShadowMapping;  uniform sampler2D uShadowTexture;  vec4 packDepth(const in float depth) {    const vec4 bitShift = vec4(256.0*256.0*256.0, 256.0*256.0, 256.0, 1.0);    const vec4 bitMask  = vec4(0.0, 1.0/256.0, 1.0/256.0, 1.0/256.0);    vec4 res = fract(depth * bitShift);    res -= res.xxyz * bitMask;    return res;  }  float unpackDepth(const in vec4 rgba) {    const vec4 bitShift = vec4(1.0/(256.0*256.0*256.0),                               1.0/(256.0*256.0), 1.0/256.0, 1.0);    float depth = dot(rgba, bitShift);    return depth;  }  void main() {    vec4 color = vec4(vec3(0.0), vAlpha);    if(uShadowMapping) {      vec3 lightCoord = vShadowDepth.xyz / vShadowDepth.w;      vec4 rgbaDepth = texture2D(uShadowTexture,                                  lightCoord.xy*0.5+0.5);      float depth = unpackDepth(rgbaDepth);/*      float depth2 = unpackDepth(packDepth(lightCoord.z));*/      float depth2 = lightCoord.z;      if(depth2 - 0.00008 > depth) {        color.rgb *= 0.7;      }    }    gl_FragColor = color;  }",o.prototype._init=function(){var t=this.layer.gl;this.shader=this._initShader(t),this._initAttributes(this.shader,t),this._initUniforms(this.shader,t),this._initBuffers(this.shader,t),this._initParams(this.shader,t)},o.prototype._initShader=function(t){var e=this._compileShader(this._VSHADER),i=this._compileShader(this._FSHADER),o=t.createProgram();return t.attachShader(o,e),t.attachShader(o,i),t.linkProgram(o),t.getProgramParameter(o,t.LINK_STATUS)||alert("Failed to setup shaders"),o},o.prototype._initAttributes=function(t,e){t.positionAttribute=e.getAttribLocation(t,"aPosition"),t.alphaAttribute=e.getAttribLocation(t,"aAlpha")},o.prototype._initUniforms=function(t,e){t.mvMatrixUniformLocation=e.getUniformLocation(t,"uMVMatrix"),t.pMatrixUniformLocation=e.getUniformLocation(t,"uPMatrix"),t.widthUniformLocation=e.getUniformLocation(t,"uWidth"),t.frameUniformLocation=e.getUniformLocation(t,"uFrame"),t.modelNumUniformLocation=e.getUniformLocation(t,"uModelNum"),t.modelCenterPositionUniformLocation=e.getUniformLocation(t,"uModelCenterPosition"),t.modelLeftFootPositionUniformLocation=e.getUniformLocation(t,"uModelLeftFootPosition"),t.modelRightFootPositionUniformLocation=e.getUniformLocation(t,"uModelRightFootPosition"),t.lightMatrixUniformLocation=e.getUniformLocation(t,"uLightMatrix"),t.shadowMappingUniformLocation=e.getUniformLocation(t,"uShadowMapping"),t.shadowTextureUniformLocation=e.getUniformLocation(t,"uShadowTexture")},o.prototype._initBuffers=function(t,e){var i=1e3,o=[-i,0,i,i,0,i,-i,0,-i,i,0,-i,-i,0,i,i,0,i,-i,0,-i,i,0,-i],r=[0,1,2,3,2,1,6,5,4,5,6,7],n=[1,1,1,1,.5,.5,.5,.5],s=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,s),e.bufferData(e.ARRAY_BUFFER,new Float32Array(o),e.STATIC_DRAW),s.itemSize=3;var a=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,a),e.bufferData(e.ARRAY_BUFFER,new Float32Array(n),e.STATIC_DRAW),a.itemSize=1;var h=e.createBuffer();e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,h),e.bufferData(e.ELEMENT_ARRAY_BUFFER,new Uint16Array(r),e.STATIC_DRAW),h.itemNum=r.length,t.width=i,t.pBuffer=s,t.aBuffer=a,t.iBuffer=h},o.prototype._initParams=function(t,e){},o.prototype._compileShader=function(t){return this.layer.compileShader(this.layer.gl,t.src,t.type)},o.prototype._bindAttributes=function(){var t=this.shader,e=this.layer.gl;e.bindBuffer(e.ARRAY_BUFFER,t.pBuffer),e.enableVertexAttribArray(t.positionAttribute),e.vertexAttribPointer(t.positionAttribute,t.pBuffer.itemSize,e.FLOAT,!1,0,0),e.bindBuffer(e.ARRAY_BUFFER,t.aBuffer),e.enableVertexAttribArray(t.alphaAttribute),e.vertexAttribPointer(t.alphaAttribute,t.aBuffer.itemSize,e.FLOAT,!1,0,0)},o.prototype._bindIndices=function(){var t=this.shader,e=this.layer.gl;e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,t.iBuffer)},o.prototype._setUniforms=function(t,e,i,o,r,n,s){var a=this.shader,h=this.layer.gl;h.uniformMatrix4fv(a.mvMatrixUniformLocation,!1,this.layer.mvMatrix),h.uniformMatrix4fv(a.pMatrixUniformLocation,!1,this.layer.pMatrix),h.uniform1f(a.frameUniformLocation,t),h.uniform1f(a.widthUniformLocation,a.width),h.uniform1i(a.modelNumUniformLocation,e),null!==i&&h.uniform3fv(a.modelCenterPositionUniformLocation,i),null!==o&&h.uniform3fv(a.modelLeftFootPositionUniformLocation,o),null!==r&&h.uniform3fv(a.modelRightFootPositionUniformLocation,r),n?(h.uniform1i(a.shadowMappingUniformLocation,1),h.activeTexture(h.TEXTURE1),h.bindTexture(h.TEXTURE_2D,this.layer.shadowFrameBuffer.t),h.uniform1i(a.shadowTextureUniformLocation,1),h.uniformMatrix4fv(a.lightMatrixUniformLocation,!1,s)):(h.uniform1i(a.shadowMappingUniformLocation,0),h.uniform1i(a.shadowTextureUniformLocation,0))},o.prototype._enableConditions=function(){var t=(this.shader,this.layer.gl);t.enable(t.BLEND),t.blendFuncSeparate(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA,t.SRC_ALPHA,t.DST_ALPHA),t.enable(t.DEPTH_TEST),t.depthFunc(t.LEQUAL),t.enable(t.CULL_FACE),t.cullFace(t.FRONT)},o.prototype._draw=function(){var t=this.shader,e=this.layer.gl;e.drawElements(e.TRIANGLES,t.iBuffer.itemNum,e.UNSIGNED_SHORT,0)},o.prototype.draw=function(t,e,i,o,r,n,s){this.layer.gl.useProgram(this.shader),this._bindAttributes(),this._setUniforms(t,e,i,o,r,n,s),this._bindIndices(),this._enableConditions(),this._draw()},e.exports=o},{}],49:[function(t,e,i){"use strict";function o(t){this.parent=r,this.parent.call(this,t)}var r=t("./StageShader"),n=t("../Inherit").__inherit;n(o,r),o.prototype._FSHADER={},o.prototype._FSHADER.type="x-shader/x-fragment",o.prototype._FSHADER.src="  precision mediump float;  varying vec3  vPosition;  varying vec4  vShadowDepth;  varying float vAlpha;  uniform float uFrame;  uniform float uWidth;  uniform int   uModelNum;  uniform vec3  uModelCenterPosition[5];  uniform vec3  uModelRightFootPosition[5];  uniform vec3  uModelLeftFootPosition[5];  uniform bool  uShadowMapping;  uniform sampler2D uShadowTexture;  vec4 packDepth(const in float depth) {    const vec4 bitShift = vec4(256.0*256.0*256.0, 256.0*256.0, 256.0, 1.0);    const vec4 bitMask  = vec4(0.0, 1.0/256.0, 1.0/256.0, 1.0/256.0);    vec4 res = fract(depth * bitShift);    res -= res.xxyz * bitMask;    return res;  }  float unpackDepth(const in vec4 rgba) {    const vec4 bitShift = vec4(1.0/(256.0*256.0*256.0),                               1.0/(256.0*256.0), 1.0/256.0, 1.0);    float depth = dot(rgba, bitShift);    return depth;  }  const int num = 8;  const int unitAngle = 360 / num;  vec2 getVec2(vec3 v) {    if(vPosition.y == 0.0 || vPosition.y >= 2.0 * uWidth - 0.1)      return v.xz;    if(vPosition.x <= -uWidth + 0.1 || vPosition.x >= uWidth - 0.1)      return v.yz;    return v.xy;  }  vec2 getPosition(int unitAngle, float uTime, int i) {    float ax = abs(mod(uTime*0.4, 100.0) - 50.0);    float ay = abs(mod(uTime*0.6, 100.0) - 50.0);    float rad = radians(float(unitAngle * i) + uTime*1.0);    vec2 val = vec2(0, 0);    for(int i = 0; i < 5; i++) {      if(i >= uModelNum)        break;      val += getVec2(uModelCenterPosition[i]);    }    val = val / float(uModelNum);    float x = val.x + ax * cos(rad);    float y = val.y + ay * sin(rad);    return vec2(x, y);  }  void main() {    float color = 0.0;    vec2 val = getVec2(vPosition);    for(int i = 0; i < num; i++) {      vec2 pos = getPosition(unitAngle, uFrame, i);      float dist = length(val - pos) * 6.0;      color += 5.0 / dist;    }    float visibility = 1.0;    if(uShadowMapping) {      vec3 lightCoord = vShadowDepth.xyz / vShadowDepth.w;      vec4 rgbaDepth = texture2D(uShadowTexture,                                  lightCoord.xy*0.5+0.5);      float depth = unpackDepth(rgbaDepth);      if(depth != 0.0) {        visibility = 0.5;      }    }    gl_FragColor = vec4(vec3(color)*visibility, vAlpha);  }",o.prototype._initBuffers=function(t,e){var i=100,o=[-i,0,i,i,0,i,-i,0,-i,i,0,-i,-i,0,i,i,0,i,-i,0,-i,i,0,-i,-i,2*i,i,i,2*i,i,-i,0,i,i,0,i,-i,0,-i,i,0,-i,-i,2*i,-i,i,2*i,-i,i,0,-i,i,0,i,i,2*i,-i,i,i*i,i,-i,2*i,-i,-i,2*i,i,-i,0,-i,-i,0,i,-i,2*i,-i,i,2*i,-i,-i,2*i,i,i,2*i,i],r=[0,1,2,3,2,1,6,5,4,5,6,7,8,9,10,11,10,9,12,13,14,15,14,13,16,17,18,19,18,17,20,21,22,23,22,21,24,25,26,27,26,25],n=[1,1,1,1,.5,.5,.5,.5,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],s=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,s),e.bufferData(e.ARRAY_BUFFER,new Float32Array(o),e.STATIC_DRAW),s.itemSize=3;var a=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,a),e.bufferData(e.ARRAY_BUFFER,new Float32Array(n),e.STATIC_DRAW),a.itemSize=1;var h=e.createBuffer();e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,h),e.bufferData(e.ELEMENT_ARRAY_BUFFER,new Uint16Array(r),e.STATIC_DRAW),h.itemNum=r.length,t.width=i,t.pBuffer=s,t.aBuffer=a,t.iBuffer=h},e.exports=o},{"../Inherit":2,"./StageShader":48}],50:[function(t,e,i){"use strict";var o,r,n,s,a,h,u,p,l,f,c,m,d,_,v,y,g,E,T,x,S,A,F,b,I,M,C,R,B,U,D=t("./Pmd/PMDView"),N=t("./WebGL/Layer"),w=t("./Pmd/PMDFileParser"),P=t("./Pmd/PMDModelView"),L=t("./Vmd/VMDFileParser"),O="./model",V="./vmd",W="./music",H=[{name:"Kaito",url:O+"/default/kaito.pmd",eye:[0,10,-22]},{name:"Haku",url:O+"/default/haku.pmd",eye:[0,10,-22]},{name:"MEIKO",url:O+"/default/MEIKO.pmd",eye:[0,10,-22]},{name:"Meiko (Sakine)",url:O+"/default/meiko_sakine.pmd",eye:[0,10,-22]},{name:"Miku",url:O+"/default/miku.pmd",eye:[0,10,-22]},{name:"Miku (Metal)",url:O+"/default/miku_m.pmd",eye:[0,10,-22]},{name:"Miku (v2)",url:O+"/default/miku_v2.pmd",eye:[0,10,-22]},{name:"Neru",url:O+"/default/neru.pmd",eye:[0,10,-22]},{name:"Ren",url:O+"/default/ren.pmd",eye:[0,10,-22]},{name:"Rin",url:O+"/default/rin.pmd",eye:[0,10,-22]},{name:"Rin (act2)",url:O+"/default/rin_act2.pmd",eye:[0,10,-22]},{name:"Miku (low poly)",url:O+"/low_miku/miku.pmd",eye:[0,10,-22]},{name:"Gumi (low poly)",url:O+"/low_miku/gumi.pmd",eye:[0,10,-22]},{name:"Mokou",url:O+"/mokou/mokou_A.pmd",eye:[0,10,-22]},{name:"Alice",url:O+"/alice/alice.pmd",eye:[0,10,-22],selected:!0}],k=[{name:"Toki No Kakera",url:[V+"/tokino_kakera.vmd",V+"/tokino_kakera_cam.vmd"],eye:[0,10,-22]},{name:"Sweet Magic",url:[V+"/sweetmagic-lip.vmd",V+"/sweetmagic-left.vmd"],eye:[0,10,-22],selected:!0},{name:"Wavefile (Short ver.)",url:[V+"/wavefile_v2.vmd"],eye:[0,10,-22],music:{url:W+"/wavefile_short.mp3",offset:320}}],z=[{name:"Audio OFF",value:D._AUDIO_OFF},{name:"Audio ON",value:D._AUDIO_ON,selected:!0}],G=[{name:"Physics OFF",value:D._PHYSICS_OFF},{name:"Physics ON",value:D._PHYSICS_ON,selected:!0}],X=[{name:"IK OFF",value:D._IK_OFF},{name:"IK ON",value:D._IK_ON,selected:!0}],Y=[{name:"Morphing OFF",value:D._MORPH_OFF},{name:"Morphing ON",value:D._MORPH_ON,selected:!0}],Z=[{name:"Stage OFF",value:D._STAGE_OFF},{name:"Stage 1",value:D._STAGE_1},{name:"Stage 2",value:D._STAGE_2,selected:!0},{name:"Stage 3",value:D._STAGE_3}],q=[{name:"Sphere mapping OFF",value:D._SPHERE_MAP_OFF},{name:"Sphere mapping ON",value:D._SPHERE_MAP_ON,selected:!0}],j=[{name:"Shadow mapping OFF",value:D._SHADOW_MAPPING_OFF,selected:!0},{name:"Shadow mapping ON",value:D._SHADOW_MAPPING_ON},{name:"Shadow mapping ONLY",value:D._SHADOW_MAPPING_ONLY}],K=[{name:"Edge OFF",value:D._EDGE_OFF},{name:"Edge ON",value:D._EDGE_ON,selected:!0}],Q=[{name:"CPU Skinning",value:D._SKINNING_CPU},{name:"GPU Skinning",value:D._SKINNING_GPU},{name:"CPU+GPU Skinning",value:D._SKINNING_CPU_AND_GPU,selected:!0}],J=[{name:"Frame Oriented",value:D._RUN_FRAME_ORIENTED},{name:"Real Time Oriented",value:D._RUN_REALTIME_ORIENTED,selected:!0}],$=[{name:"Light OFF",value:D._LIGHTING_OFF},{name:"Light ON",value:D._LIGHTING_ON},{name:"Light ON w/ toon",value:D._LIGHTING_ON_WITH_TOON,selected:!0}],tt=[{name:"Post effect OFF",value:D._EFFECT_OFF,selected:!0},{name:"Blur",value:D._EFFECT_BLUR},{name:"Gaussian Blur",value:D._EFFECT_GAUSSIAN},{name:"Diffusion Blur",value:D._EFFECT_DIFFUSION},{name:"Division",value:D._EFFECT_DIVISION},{name:"Low Resolution",value:D._EFFECT_LOW_RESO},{name:"Face Mosaic",value:D._EFFECT_FACE_MOSAIC}],et=0,it=60,ot=!1,rt=!1,nt=null,st=!1,at={x:0,y:0},ht=function(t){var e=document.getElementById("statusArea");e.appendChild(document.createTextNode(t+"\n")),e.scrollTop=e.scrollHeight},ut=function(){p.disabled=!1,l.disabled=!0,m.disabled=!1,d.disabled=!1,_.disabled=!1,f.disabled=!1,v.disabled=!1,y.disabled=!1,g.disabled=!1,E.disabled=!1,T.disabled=!1,x.disabled=!1,S.disabled=!1,A.disabled=!1,F.disabled=!1,b.disabled=!1,I.disabled=!1,M.disabled=!1,dt(),ct(),mt()},pt=function(){p.disabled=!0,l.disabled=!0,m.disabled=!0,d.disabled=!0,_.disabled=!0,f.disabled=!0,v.disabled=!0,F.disabled=!0,y.disabled=!0,g.disabled=!0,E.disabled=!0,T.disabled=!0,x.disabled=!0,S.disabled=!0,A.disabled=!0,b.disabled=!0,I.disabled=!0,M.disabled=!0},lt=function(){n&&n.getModelNum()>=4?p.disabled=!0:p.disabled=!1,l.disabled=!1,m.disabled=!1,d.disabled=!1,_.disabled=!1,f.disabled=!1,v.disabled=!1,y.disabled=!1,F.disabled=!1,g.disabled=!1,E.disabled=!1,T.disabled=!1,x.disabled=!1,S.disabled=!1,A.disabled=!1,b.disabled=!0,I.disabled=!1,M.disabled=!1,dt(),ct(),mt()},ft=function(){p.disabled=!0,l.disabled=!0,m.disabled=!1,d.disabled=!1,_.disabled=!1,f.disabled=!0,v.disabled=!1,y.disabled=!1,F.disabled=!1,g.disabled=!1,E.disabled=!1,T.disabled=!1,x.disabled=!1,S.disabled=!1,A.disabled=!1,b.disabled=!0,I.disabled=!1,M.disabled=!1,dt(),ct(),mt(),_.disabled=!0},ct=function(){f.checked?(S.options[0].selected=!0,S.options[1].selected=!1,S.options[2].selected=!1,S.disabled=!0,_.options[0].selected=!0,_.options[1].selected=!1,_.disabled=!0):(S.disabled=!1,_.disabled=!1),Kt(n),ie(n)},mt=function(){_.options[1].selected?(S.options[0].selected=!1,S.options[1].selected=!0,S.disabled=!0):f.checked||(S.disabled=!1),Kt(n)},dt=function(){var t=parseInt(d.value),e=k[t];void 0!==e.music&&null!==e.music?_.disabled=!1:(_.options[0].selected=!0,_.options[1].selected=!1,_.disabled=!0),ie(n)};window.onload=function(){p=document.getElementById("loadModelButton"),l=document.getElementById("loadMotionButton"),m=document.getElementById("modelSelect"),d=document.getElementById("motionSelect"),_=document.getElementById("audioSelect"),f=document.getElementById("videoGenerationCheckbox"),c=document.getElementById("physicsCheckbox"),v=document.getElementById("physicsSelect"),y=document.getElementById("ikSelect"),g=document.getElementById("morphSelect"),E=document.getElementById("stageSelect"),T=document.getElementById("sphereMapSelect"),x=document.getElementById("shadowMappingSelect"),A=document.getElementById("effectSelect"),S=document.getElementById("runTypeSelect"),F=document.getElementById("edgeSelect"),b=document.getElementById("skinningSelect"),I=document.getElementById("lightingSelect"),M=document.getElementById("lightColorRange"),C=document.getElementById("lightColorSpan"),u=document.getElementById("mainCanvas"),u.onblur=le,u.onmousedown=pe,u.onmouseup=le,u.onmousemove=ce,u.oncontextmenu=fe,u.addEventListener("mousewheel",ue,!1),R=new N(u);var t=new D(R);n=t,zt(),_t(m,H),_t(d,k),_t(_,z),_t(v,G),_t(y,X),_t(g,Y),_t(E,Z),_t(T,q),_t(x,j),_t(S,J),_t(A,tt),_t(F,K),_t(b,Q),_t(I,$),Gt(t),Xt(t),Yt(t),Zt(t),qt(t),Kt(t),Qt(t),Jt(t),$t(t),te(t),ee(t),ie(t),ht("select model and click load model button."),ut()};var _t=function(t,e){for(var i=0;i<e.length;i++){var o=document.createElement("option");o.selected=e[i].selected?!0:!1,o.value=i,o.innerText=e[i].name,t.appendChild(o)}},vt=function(){pt();var t=parseInt(m.value);B=H[t];var e=B.url,i=new XMLHttpRequest;i.responseType="arraybuffer",i.onload=function(){yt(i.response)},i.onerror=function(t){var e="";for(var i in t)e+=i+"="+t[i]+"\n";ht(e),ut()},i.open("GET",e,!0),i.send(null),ht("loading PMD file...")},yt=function(t){ht("parsing PMD file..."),requestAnimationFrame(function(){gt(t)})},gt=function(t){var e=new w(t);if(o=e,!e.valid())return ht("this file seems not a PMD file..."),void ut();var i=e.parse();r=i,i.setup(),Et(i)},Et=function(t){var e=B.url,i=e.substring(0,e.lastIndexOf("/"));t.loadImages(i,Tt),ht("loading images...")},Tt=function(t){var e=n;ht("PMD is ready."),ht("select motion and click load motion button."),e.getModelNum()<4&&ht("Or select model and click load model button."),lt(),ot=!0;var i=new P(R,t,e);i.setup(),e.addModelView(i),xt(e.modelViews),1===e.getModelNum()&&(e.setEye(B.eye),ae(e))},xt=function(t){switch(t.length){case 1:t[0].setBasePosition(0,0,0);break;case 2:t[0].setBasePosition(-10,0,0),t[1].setBasePosition(10,0,0);break;case 3:t[0].setBasePosition(0,0,0),t[1].setBasePosition(10,0,10),t[2].setBasePosition(-10,0,10);break;case 4:t[0].setBasePosition(5,0,0),t[1].setBasePosition(-5,0,0),t[2].setBasePosition(15,0,10),t[3].setBasePosition(-15,0,10);break;case 5:t[0].setBasePosition(0,0,0),t[1].setBasePosition(10,0,10),t[2].setBasePosition(-10,0,10),t[3].setBasePosition(20,0,20),t[4].setBasePosition(-20,0,20)}},St=function(){pt();var t=parseInt(d.value);U=k[t];var e=U.url;At(e,0,[])},At=function(t,e,i){var o=t[e],r=new XMLHttpRequest;r.responseType="arraybuffer",r.onload=function(){i.push(r.response),e+1>=t.length?Ft(i):At(t,e+1,i)},r.onerror=function(t){var e="";for(var i in t)e+=i+"="+t[i]+"\n";ht(e),lt()},r.open("GET",o,!0),r.send(null),ht("loading VMD file "+(e+1)+" ...")},Ft=function(t){ht("parsing VMD files..."),requestAnimationFrame(function(){bt(t)})},bt=function(t){var e,i=[],o=[];for(e=0;e<t.length;e++){if(o[e]=new L(t[e]),!o[e].valid())return ht("file "+(e+1)+" seems not a VMD file..."),void lt();i[e]=o[e].parse()}var r=i[0];o[0];for(s=o[0],a=i[0],e=1;e<t.length;e++)r.merge(i[e]);n.setVMD(r),n.setEye(U.eye),rt=!0,U.music?It():Mt()},It=function(){pt();var t=U.music.url,e=new Audio(t);e.addEventListener("canplaythrough",function(){Mt()}),n.setAudio(e,U.music.offset),ht("loading Audio files...")},Mt=function(){if(ht("ready."),ht("starts dance."),n.startDance(),f.checked){nt=new Whammy.Video(60);var t=document.getElementById("videoSpan"),e=document.createElement("button");e.innerText="output video",e.onclick=function(){re()},t.appendChild(e)}ft()},Ct=function(){Gt(n)},Rt=function(){Xt(n)},Bt=function(){Yt(n)},Ut=function(){Zt(n)},Dt=function(){qt(n)},Nt=function(){jt(n)},wt=function(){Kt(n)},Pt=function(){Qt(n)},Lt=function(){Jt(n)},Ot=function(){$t(n)},Vt=function(){te(n)},Wt=function(){zt(),ee(n)},Ht=function(){mt(),ie(n)},kt=function(){dt(),Ht()},zt=function(){C.innerText=M.value},Gt=function(t){var e=parseInt(v.value);t.setPhysicsType(G[e].value)},Xt=function(t){var e=parseInt(y.value);t.setIKType(X[e].value)},Yt=function(t){var e=parseInt(g.value);t.setMorphType(Y[e].value)},Zt=function(t){var e=parseInt(E.value);t.setStageType(Z[e].value)},qt=function(t){var e=parseInt(T.value);t.setSphereMapType(q[e].value)},jt=function(t){var e=parseInt(x.value);t.setShadowMappingType(j[e].value)},Kt=function(t){var e=parseInt(S.value);t.setRunType(J[e].value)},Qt=function(t){var e=parseInt(A.value);t.setEffectFlag(tt[e].value)},Jt=function(t){var e=parseInt(F.value);t.setEdgeType(K[e].value)},$t=function(t){var e=parseInt(b.value);t.setSkinningType(Q[e].value)},te=function(t){var e=parseInt(I.value);t.setLightingType($[e].value)},ee=function(t){var e=parseFloat(M.value);t.setLightColor(e)},ie=function(t){var e=parseInt(_.value);t.setAudioType(z[e].value)},oe=function(){ct()},re=function(){if(null!==nt){var t=document.getElementById("videoSpan");for(t.firstChild.disabled=!0;t.firstChild.nextSibling;)t.removeChild(t.firstChild.nextSibling);ht("compiling video file..."),requestAnimationFrame(function(){ne()})}},ne=function(){var t=nt.compile();ht("creating object URL..."),requestAnimationFrame(function(){se(t)})},se=function(t){var e=URL.createObjectURL(t),i=document.getElementById("videoSpan");i.firstChild.disabled=!1;var o=document.createElement("a");o.innerText="video",o.href=e,o.target="_blank",o.style.marginLeft="10px",i.appendChild(o),ht("video was generated.")},ae=function(t){t.update(),t.draw(),null!==nt&&nt.add(t.layer.canvas),requestAnimationFrame(function(){ae(t)}),he(),et++},he=function(){if(et%it===0){var t=Date.now();if(void 0!==h){var e=parseInt(1e3*it/(t-h));document.getElementById("fpsSpan").innerText=e+"fps"}h=t}},ue=function(t){if(ot){var e=(t.detail||t.wheelDelta)>0?1:-1;n.moveCameraForward(e),t.preventDefault()}},pe=function(t){ot&&(st=!0,at.x=t.clientX,at.y=t.clientY)},le=function(t){ot&&(st=!1)},fe=function(t){ot&&(n.resetCameraMove(),t.preventDefault())},ce=function(t){if(ot&&st){var e=(at.x-t.clientX)/u.width,i=(at.y-t.clientY)/u.height;t.shiftKey?n.moveCameraTranslation(e,i):n.moveCameraQuaternionByXY(e,i),at.x=t.clientX,at.y=t.clientY}};window.__loadModelButtonClicked=vt,window.__loadMotionButtonClicked=St,window.__motionSelectChanged=kt,window.__audioSelectChanged=Ht,window.__videoGenerationCheckboxChanged=oe,window.__physicsSelectChanged=Ct,window.__loadMotionButtonClicked=St,window.__ikSelectChanged=Rt,window.__morphSelectChanged=Bt,window.__stageSelectChanged=Ut,window.__sphereMapSelectChanged=Dt,window.__shadowMappingSelectChanged=Nt,window.__edgeSelectChanged=Lt,window.__skinningSelectChanged=Ot,window.__runTypeSelectChanged=wt,window.__effectSelectChanged=Pt,window.__lightingSelectChanged=Vt,window.__lightColorRangeChanged=Wt},{"./Pmd/PMDFileParser":18,"./Pmd/PMDModelView":24,"./Pmd/PMDView":29,"./Vmd/VMDFileParser":34,"./WebGL/Layer":43}]},{},[50]);